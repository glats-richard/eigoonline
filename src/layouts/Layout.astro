---
import "../styles/global.css";
import SiteHeader from "../components/SiteHeader.astro";
import SiteFooter from "../components/SiteFooter.astro";

type Props = {
  title?: string;
  description?: string;
  keywords?: string;
  robots?: string;
  ogImage?: string;
  showHeader?: boolean;
  /** If true, header overlays hero (absolute + translucent). */
  headerOverlay?: boolean;
};

const {
  title = "オンライン英会話 おすすめ比較・ランキング",
  description = "オンライン英会話のおすすめを目的別（総合/日常/ビジネス）に比較。料金・特徴・無料体験・公式サイト導線までまとめてチェックできます。",
  keywords = "オンライン英会話,オンライン英会話 おすすめ,おすすめ,人気,比較,ランキング",
  robots,
  ogImage = "/eigoonline_logo.webp",
  showHeader = true,
  headerOverlay = false,
} = Astro.props satisfies Props;

const siteUrl = Astro.site ? new URL(Astro.site) : new URL(Astro.url.origin);
const canonical = new URL(Astro.url.pathname, siteUrl).toString();
const ogImageAbs = new URL(ogImage, siteUrl).toString();

const defaultRobots = "index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1";

const orgName = "eigoonline";
const orgLogo = new URL("/eigoonline_logo.webp", siteUrl).toString();
const orgUrl = siteUrl.toString().replace(/\/$/, "");

// Debug/deploy trace: helps confirm which build is being served (useful under CDN caching).
const buildId =
  (typeof process !== "undefined" && process.env && (process.env.RAILWAY_GIT_COMMIT_SHA || process.env.GITHUB_SHA)) || "";

const jsonLd = [
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "@id": `${orgUrl}#organization`,
    name: orgName,
    url: orgUrl,
    logo: {
      "@type": "ImageObject",
      url: orgLogo,
    },
  },
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "@id": `${orgUrl}#website`,
    url: orgUrl,
    name: title,
    publisher: { "@id": `${orgUrl}#organization` },
    inLanguage: "ja-JP",
  },
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "@id": `${canonical}#webpage`,
    url: canonical,
    name: title,
    description,
    isPartOf: { "@id": `${orgUrl}#website` },
    inLanguage: "ja-JP",
  },
];
---

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.svg" sizes="any" type="image/svg+xml" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <!-- Speed up GTM connection -->
    <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin />
    <link rel="dns-prefetch" href="//www.googletagmanager.com" />
    <!-- Speed up Quoriza SDK connection (loaded via tags) -->
    <link rel="preconnect" href="https://rc.quoriza.net" crossorigin />
    <link rel="dns-prefetch" href="//rc.quoriza.net" />
    <!-- Google Tag Manager -->
    <script is:inline>
      // @ts-nocheck
      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;if(f&&f.parentNode){f.parentNode.insertBefore(j,f);}
      })(window,document,'script','dataLayer','GTM-WN37MRC9');
    </script>
    <!-- End Google Tag Manager -->
    <!-- Referrer policy:
         - Same-origin requests (e.g. /tracker -> /api/tracker/*) include Referer
         - Cross-origin requests do not leak Referer -->
    <meta name="referrer" content="same-origin" />
    <!-- Disable legacy interest-cohort/FLoC-style tracking -->
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()" />

    <meta name="robots" content={robots ?? defaultRobots} />
    <meta name="keywords" content={keywords} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonical} />
    <link rel="alternate" hreflang="ja" href={canonical} />
    <meta name="theme-color" content="#7ac6ff" />

    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonical} />
    <meta property="og:site_name" content={orgName} />
    <meta property="og:locale" content="ja_JP" />
    <meta property="og:image" content={ogImageAbs} />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageAbs} />

    {buildId ? <meta name="x-build-id" content={buildId} /> : null}
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)}></script>
    <slot name="head" />
  </head>
  <body class="min-h-dvh overflow-x-hidden bg-transparent antialiased">
    <!-- Google Tag Manager (noscript) -->
    <noscript>
      <iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-WN37MRC9"
        height="0"
        width="0"
        style="display:none;visibility:hidden"
      ></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->
    {showHeader ? <SiteHeader overlay={headerOverlay} /> : null}
    {buildId ? <span class="sr-only" data-build-id={buildId}>build:{buildId}</span> : null}
    <slot />
    <SiteFooter />
  </body>
</html>

