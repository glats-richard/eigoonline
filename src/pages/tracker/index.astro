---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../lib/supabase";

type Offer = { id: string | number; name?: string | null; title?: string | null };
type ClickRow = {
  id?: string | number;
  created_at?: string | null;
  offer_id?: string | number | null;
  url?: string | null;
  referrer?: string | null;
  user_agent?: string | null;
  ip?: string | null;
};
type ConversionRow = {
  id?: string | number;
  created_at?: string | null;
  offer_id?: string | number | null;
  reward?: number | null;
  payout?: number | null;
  amount?: number | null;
  commission?: number | null;
  status?: string | null;
};

function yen(n: number) {
  return new Intl.NumberFormat("ja-JP", { style: "currency", currency: "JPY", maximumFractionDigits: 0 }).format(n);
}

function fmtDate(iso?: string | null) {
  if (!iso) return "—";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return iso;
  return d.toLocaleString("ja-JP");
}

function offerNameById(offers: Map<string, Offer>, id: string | number | null | undefined) {
  if (id === null || id === undefined) return "—";
  const o = offers.get(String(id));
  return o?.name ?? o?.title ?? `offer:${id}`;
}

// Fetch latest logs first (we'll derive offers map from their offer_ids)
const { data: clicksRaw, error: clicksErr } = await supabase
  .from("clicks")
  .select("*")
  .order("created_at", { ascending: false })
  .limit(10);

const { data: convRaw, error: convErr } = await supabase
  .from("conversions")
  .select("*")
  .order("created_at", { ascending: false })
  .limit(10);

// Summary counts (exact count via head request)
const { count: totalClicks, error: totalClicksErr } = await supabase
  .from("clicks")
  .select("id", { head: true, count: "exact" });

const { count: totalConversions, error: totalConvErr } = await supabase
  .from("conversions")
  .select("id", { head: true, count: "exact" });

// Sum rewards (best-effort across common column names)
// Prefer server-side sum if a 'reward' column exists; otherwise we fall back to summing latest 10 only.
let totalRewardYen: number | null = null;
try {
  const { data: sumData } = await supabase
    // If your schema uses a different numeric column, adjust below (reward/payout/amount/commission)
    .from("conversions")
    // Supabase supports aggregates like sum() in select
    .select("reward:sum(reward)");
  const v = (sumData as any)?.[0]?.reward;
  if (typeof v === "number" && Number.isFinite(v)) totalRewardYen = v;
} catch {
  totalRewardYen = null;
}

const clicks = (clicksRaw ?? []) as ClickRow[];
const conversions = (convRaw ?? []) as ConversionRow[];

const offerIds = new Set<string>();
for (const c of clicks) if (c.offer_id != null) offerIds.add(String(c.offer_id));
for (const c of conversions) if (c.offer_id != null) offerIds.add(String(c.offer_id));

let offersMap = new Map<string, Offer>();
if (offerIds.size) {
  const { data: offersRaw } = await supabase.from("offers").select("id,name,title").in("id", Array.from(offerIds));
  for (const o of (offersRaw ?? []) as Offer[]) offersMap.set(String(o.id), o);
}

function rewardValue(r: ConversionRow) {
  const v = r.reward ?? r.payout ?? r.amount ?? r.commission;
  return typeof v === "number" && Number.isFinite(v) ? v : null;
}

const errors: string[] = [];
if (clicksErr) errors.push(`clicks: ${clicksErr.message}`);
if (convErr) errors.push(`conversions: ${convErr.message}`);
if (totalClicksErr) errors.push(`totalClicks: ${totalClicksErr.message}`);
if (totalConvErr) errors.push(`totalConversions: ${totalConvErr.message}`);
---

<Layout title="Tracker" description="Affiliate tracker admin" robots="noindex,nofollow" showHeader={true}>
  <main class="mx-auto w-full max-w-5xl px-4 pb-14 pt-8">
    <div class="flex flex-wrap items-end justify-between gap-4">
      <div>
        <h1 class="text-2xl font-extrabold text-zinc-900">成果トラッカー</h1>
        <p class="mt-1 text-sm text-zinc-600">/tracker（Basic認証保護）</p>
      </div>
      <div class="text-xs text-zinc-500">更新: {new Date().toLocaleString("ja-JP")}</div>
    </div>

    {errors.length ? (
      <div class="mt-6 rounded-2xl border border-rose-200 bg-rose-50 p-4 text-sm text-rose-900">
        <div class="font-extrabold">データ取得エラー</div>
        <ul class="mt-2 list-disc pl-5">
          {errors.map((e) => (
            <li>{e}</li>
          ))}
        </ul>
      </div>
    ) : null}

    <section class="mt-6 grid gap-4 sm:grid-cols-3">
      <div class="rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
        <div class="text-xs font-extrabold text-zinc-500">総クリック数</div>
        <div class="mt-2 text-3xl font-extrabold text-zinc-900">{totalClicks ?? 0}</div>
      </div>
      <div class="rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
        <div class="text-xs font-extrabold text-zinc-500">総コンバージョン数</div>
        <div class="mt-2 text-3xl font-extrabold text-zinc-900">{totalConversions ?? 0}</div>
      </div>
      <div class="rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
        <div class="text-xs font-extrabold text-zinc-500">合計報酬額</div>
        <div class="mt-2 text-3xl font-extrabold text-zinc-900">
          {totalRewardYen == null ? "—" : yen(totalRewardYen)}
        </div>
        <div class="mt-1 text-xs text-zinc-500">※ `conversions.reward` の合計（必要なら列名を調整）</div>
      </div>
    </section>

    <section class="mt-10">
      <h2 class="text-lg font-extrabold text-zinc-900">直近のクリックログ（最新10件）</h2>
      <div class="mt-3 overflow-hidden rounded-2xl border border-zinc-200 bg-white shadow-sm">
        <div class="overflow-x-auto">
          <table class="w-full min-w-[860px] text-left text-sm">
            <thead class="bg-zinc-50 text-xs font-extrabold text-zinc-600">
              <tr>
                <th class="px-4 py-3">日時</th>
                <th class="px-4 py-3">案件</th>
                <th class="px-4 py-3">URL</th>
                <th class="px-4 py-3">Referrer</th>
                <th class="px-4 py-3">IP</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-zinc-200">
              {clicks.map((c) => (
                <tr class="align-top">
                  <td class="px-4 py-3 whitespace-nowrap">{fmtDate(c.created_at)}</td>
                  <td class="px-4 py-3 font-semibold text-zinc-900">{offerNameById(offersMap, c.offer_id)}</td>
                  <td class="px-4 py-3">
                    {c.url ? <span class="break-all text-xs text-zinc-700">{c.url}</span> : <span class="text-zinc-400">—</span>}
                  </td>
                  <td class="px-4 py-3">
                    {c.referrer ? (
                      <span class="break-all text-xs text-zinc-700">{c.referrer}</span>
                    ) : (
                      <span class="text-zinc-400">—</span>
                    )}
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap">{c.ip ?? "—"}</td>
                </tr>
              ))}
              {!clicks.length ? (
                <tr>
                  <td class="px-4 py-6 text-center text-zinc-500" colspan="5">
                    データなし
                  </td>
                </tr>
              ) : null}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="mt-10">
      <h2 class="text-lg font-extrabold text-zinc-900">成果一覧（最新10件）</h2>
      <div class="mt-3 overflow-hidden rounded-2xl border border-zinc-200 bg-white shadow-sm">
        <div class="overflow-x-auto">
          <table class="w-full min-w-[760px] text-left text-sm">
            <thead class="bg-zinc-50 text-xs font-extrabold text-zinc-600">
              <tr>
                <th class="px-4 py-3">日時</th>
                <th class="px-4 py-3">案件</th>
                <th class="px-4 py-3">ステータス</th>
                <th class="px-4 py-3">報酬</th>
                <th class="px-4 py-3">ID</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-zinc-200">
              {conversions.map((cv) => {
                const v = rewardValue(cv);
                return (
                  <tr class="align-top">
                    <td class="px-4 py-3 whitespace-nowrap">{fmtDate(cv.created_at)}</td>
                    <td class="px-4 py-3 font-semibold text-zinc-900">{offerNameById(offersMap, cv.offer_id)}</td>
                    <td class="px-4 py-3">{cv.status ?? "—"}</td>
                    <td class="px-4 py-3 whitespace-nowrap">{v == null ? "—" : yen(v)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-xs text-zinc-600">{cv.id ?? "—"}</td>
                  </tr>
                );
              })}
              {!conversions.length ? (
                <tr>
                  <td class="px-4 py-6 text-center text-zinc-500" colspan="5">
                    データなし
                  </td>
                </tr>
              ) : null}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="mt-10 rounded-2xl border border-zinc-200 bg-zinc-50 p-5 text-sm text-zinc-700">
      <div class="font-extrabold text-zinc-900">環境変数（サーバー）</div>
      <ul class="mt-2 list-disc pl-5">
        <li><span class="font-semibold">SUPABASE_URL</span></li>
        <li><span class="font-semibold">SUPABASE_SERVICE_ROLE_KEY</span>（推奨）または <span class="font-semibold">SUPABASE_ANON_KEY</span></li>
      </ul>
    </section>
  </main>
</Layout>

