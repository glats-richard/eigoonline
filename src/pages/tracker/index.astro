---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import { dbEnvError, query } from "../../lib/db";
import TrackerHeader from "../../components/TrackerHeader.astro";

type Offer = { id: string | number; name?: string | null; title?: string | null };
type ClickRow = {
  id?: string | number;
  created_at?: string | Date | null;
  offer_id?: string | number | null;
  click_id?: string | null;
  url?: string | null;
  referrer?: string | null;
  user_agent?: string | null;
  ip?: string | null;
  ip_hash?: string | null;
  ip_version?: number | null;
};
type ConversionRow = {
  id?: string | number;
  created_at?: string | Date | null;
  offer_id?: string | number | null;
  click_id?: string | null;
  student_id?: string | null;
  student_id_hash?: string | null;
  event_id?: string | null;
  client_ts_ms?: number | null;
  risk?: Record<string, any> | null;
  review_comment?: string | null;
  reward?: number | null;
  payout?: number | null;
  amount?: number | null;
  commission?: number | null;
  status?: string | null;
  ip?: string | null;
  ip_hash?: string | null;
  ip_version?: number | null;
  country?: string | null;
  user_agent?: string | null;
  accept_language?: string | null;
  origin?: string | null;
  referrer?: string | null;
  page_url?: string | null;
  cf_ray?: string | null;
  cf_connecting_ip?: string | null;
  cf_ipcountry?: string | null;
  x_forwarded_for?: string | null;
  request_id?: string | null;
  request_headers?: Record<string, any> | null;
};

function yen(n: number) {
  return new Intl.NumberFormat("ja-JP", { style: "currency", currency: "JPY", maximumFractionDigits: 0 }).format(n);
}

function getTokyoMonthRange(now = new Date()) {
  // Compute month boundaries in JST, represented as UTC ISO strings for DB filtering.
  const parts = new Intl.DateTimeFormat("en-US", {
    timeZone: "Asia/Tokyo",
    year: "numeric",
    month: "2-digit",
  }).formatToParts(now);
  const year = Number(parts.find((p) => p.type === "year")?.value ?? now.getUTCFullYear());
  const month = Number(parts.find((p) => p.type === "month")?.value ?? now.getUTCMonth() + 1); // 1-12
  // JST midnight == UTC-9h
  const startUtc = new Date(Date.UTC(year, month - 1, 1, -9, 0, 0));
  const endUtc = new Date(Date.UTC(year, month, 1, -9, 0, 0));
  return {
    label: `${year}年${month}月`,
    startIso: startUtc.toISOString(),
    endIso: endUtc.toISOString(),
  };
}

function getTokyoTodayYmd(now = new Date()) {
  const parts = new Intl.DateTimeFormat("en-US", {
    timeZone: "Asia/Tokyo",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
  }).formatToParts(now);
  const y = Number(parts.find((p) => p.type === "year")?.value ?? now.getUTCFullYear());
  const mo = Number(parts.find((p) => p.type === "month")?.value ?? now.getUTCMonth() + 1);
  const d = Number(parts.find((p) => p.type === "day")?.value ?? now.getUTCDate());
  const ymd = `${String(y).padStart(4, "0")}-${String(mo).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
  return { y, mo, d, ymd };
}

function parseYmd(s?: string | null) {
  if (!s) return null;
  const m = String(s).match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!m) return null;
  const y = Number(m[1]);
  const mo = Number(m[2]);
  const d = Number(m[3]);
  if (!Number.isFinite(y) || !Number.isFinite(mo) || !Number.isFinite(d)) return null;
  if (mo < 1 || mo > 12) return null;
  if (d < 1 || d > 31) return null;
  return { y, mo, d, ymd: `${m[1]}-${m[2]}-${m[3]}` };
}

function getTokyoDateRange(fromYmd?: string | null, toYmd?: string | null) {
  const from = parseYmd(fromYmd);
  const to = parseYmd(toYmd);
  if (!from && !to) return null;

  // JST midnight == UTC-9h. Use [start, end) with end = next-day JST midnight.
  const startUtc = from ? new Date(Date.UTC(from.y, from.mo - 1, from.d, -9, 0, 0)) : null;
  const endUtcExclusive = to ? new Date(Date.UTC(to.y, to.mo - 1, to.d + 1, -9, 0, 0)) : null;

  const label = from && to ? `${from.ymd}〜${to.ymd}` : from ? `${from.ymd}〜` : `〜${to!.ymd}`;
  return {
    label,
    fromYmd: from?.ymd ?? null,
    toYmd: to?.ymd ?? null,
    startIso: startUtc ? startUtc.toISOString() : null,
    endIso: endUtcExclusive ? endUtcExclusive.toISOString() : null,
  };
}

function getTokyoLastNDaysRange(nDays: number, now = new Date()) {
  const today = getTokyoTodayYmd(now);
  const endUtcExclusive = new Date(Date.UTC(today.y, today.mo - 1, today.d + 1, -9, 0, 0));
  const startUtc = new Date(Date.UTC(today.y, today.mo - 1, today.d - (nDays - 1), -9, 0, 0));

  const fromParts = new Intl.DateTimeFormat("en-CA", { timeZone: "Asia/Tokyo", year: "numeric", month: "2-digit", day: "2-digit" }).formatToParts(startUtc);
  const toParts = new Intl.DateTimeFormat("en-CA", { timeZone: "Asia/Tokyo", year: "numeric", month: "2-digit", day: "2-digit" }).formatToParts(new Date(endUtcExclusive.getTime() - 1));
  const fromY = fromParts.find((p) => p.type === "year")?.value ?? String(today.y).padStart(4, "0");
  const fromM = fromParts.find((p) => p.type === "month")?.value ?? String(today.mo).padStart(2, "0");
  const fromD = fromParts.find((p) => p.type === "day")?.value ?? String(today.d).padStart(2, "0");
  const toY = toParts.find((p) => p.type === "year")?.value ?? String(today.y).padStart(4, "0");
  const toM = toParts.find((p) => p.type === "month")?.value ?? String(today.mo).padStart(2, "0");
  const toD = toParts.find((p) => p.type === "day")?.value ?? String(today.d).padStart(2, "0");
  const fromYmd = `${fromY}-${fromM}-${fromD}`;
  const toYmd = `${toY}-${toM}-${toD}`;

  return {
    label: `直近${nDays}日`,
    fromYmd,
    toYmd,
    startIso: startUtc.toISOString(),
    endIso: endUtcExclusive.toISOString(),
  };
}

function fmtDate(iso?: string | Date | null) {
  if (!iso) return "—";
  const d = iso instanceof Date ? iso : new Date(iso);
  if (Number.isNaN(d.getTime())) return iso;
  return d.toLocaleString("ja-JP");
}

function offerNameById(offers: Map<string, Offer>, id: string | number | null | undefined) {
  if (id === null || id === undefined) return "—";
  const o = offers.get(String(id));
  return o?.name ?? o?.title ?? `offer:${id}`;
}

function rewardValue(r: ConversionRow) {
  const v = r.reward ?? r.payout ?? r.amount ?? r.commission;
  return typeof v === "number" && Number.isFinite(v) ? v : null;
}

function shortText(s?: string | null, max = 64) {
  if (!s) return "—";
  const t = String(s);
  return t.length > max ? `${t.slice(0, max - 1)}…` : t;
}

const ALLOWED_ORIGINS = new Set(["https://eigoonline.com", "https://www.eigoonline.com", "https://br.glats.online"]);

function isSuspicious(cv: ConversionRow) {
  // Heuristics (best-effort): missing/unknown origin or country, very long UA, etc.
  if ((cv.status ?? "") === "check") return true;
  if (cv.risk && cv.risk.needs_review === true) return true;
  if (cv.review_comment) return true;
  if (cv.origin && !ALLOWED_ORIGINS.has(cv.origin)) return true;
  if (!cv.origin) return true;
  return false;
}

function ipLabel(cv: ConversionRow) {
  if (!cv.ip) return "—";
  const v = cv.ip_version === 6 ? "IPv6" : cv.ip_version === 4 ? "IPv4" : "IP";
  return `${v}`;
}

function maskId(s?: string | null) {
  if (!s) return "—";
  const t = String(s);
  if (t.length <= 10) return t;
  return `${t.slice(0, 4)}…${t.slice(-4)}`;
}

function sqlWhereCreatedAtRange(startIso: string | null, endIso: string | null, statuses: string[] | null = null, startIndex = 1) {
  const conds: string[] = [];
  const params: any[] = [];
  if (startIso) {
    params.push(startIso);
    conds.push(`created_at >= $${startIndex + params.length - 1}`);
  }
  if (endIso) {
    params.push(endIso);
    conds.push(`created_at < $${startIndex + params.length - 1}`);
  }
  if (statuses && statuses.length > 0) {
    params.push(statuses);
    conds.push(`status = any($${startIndex + params.length - 1}::text[])`);
  }
  const whereSql = conds.length ? `where ${conds.join(" and ")}` : "";
  return { whereSql, params };
}

const searchParams = Astro.url.searchParams;
const range = getTokyoDateRange(searchParams.get("from"), searchParams.get("to")) ?? getTokyoLastNDaysRange(30);
const todayYmd = getTokyoTodayYmd().ymd;
const last7 = getTokyoLastNDaysRange(7);
const returnTo = `${Astro.url.pathname}${Astro.url.search}`;

// Parse status filters from URL params (e.g., ?status=pending&status=check)
// Default to pending and check if no status filter is specified
const statusFilterRaw = searchParams.getAll("status");
const ALLOWED_STATUSES = new Set(["pending", "check", "approved", "rejected"]);
const statusFilterParsed = statusFilterRaw.filter((s) => ALLOWED_STATUSES.has(s));
// If no status filter in URL, default to pending and check
const statusFilter = statusFilterParsed.length > 0 ? statusFilterParsed : ["pending", "check"];
const hasStatusFilter = statusFilter.length > 0;

const pageSizeRaw = searchParams.get("per") ?? "10";
const pageSize = pageSizeRaw === "100" ? 100 : pageSizeRaw === "50" ? 50 : 10;
const pageRaw = Number(searchParams.get("page") ?? "1");
const page = Number.isFinite(pageRaw) && pageRaw >= 1 ? Math.floor(pageRaw) : 1;
const offset = (page - 1) * pageSize;

function buildHref(next: Record<string, string | number | null | undefined>) {
  const p = new URLSearchParams(searchParams);
  for (const [k, v] of Object.entries(next)) {
    if (v === null || v === undefined || v === "") p.delete(k);
    else p.set(k, String(v));
  }
  const qs = p.toString();
  return qs ? `/tracker?${qs}` : "/tracker";
}

// Fetch latest logs first (we'll derive offers map from their offer_ids)
let clicksErr: Error | null = null;
let convErr: Error | null = null;
let clicksRaw: ClickRow[] = [];
let convRaw: ConversionRow[] = [];
try {
  const w = sqlWhereCreatedAtRange(range?.startIso ?? null, range?.endIso ?? null);
  const r = await query<ClickRow>(`select * from clicks ${w.whereSql} order by created_at desc limit 10`, w.params);
  clicksRaw = r.rows ?? [];
} catch (e: any) {
  clicksErr = e;
}
try {
  const w = sqlWhereCreatedAtRange(range?.startIso ?? null, range?.endIso ?? null, hasStatusFilter ? statusFilter : null);
  const r = await query<ConversionRow>(
    `select * from conversions ${w.whereSql} order by created_at desc limit $${w.params.length + 1} offset $${w.params.length + 2}`,
    [...w.params, pageSize, offset],
  );
  convRaw = r.rows ?? [];
} catch (e: any) {
  convErr = e;
}

// Period conversions per offer: default is current JST month, override via ?from=YYYY-MM-DD&to=YYYY-MM-DD
const period = range ?? getTokyoMonthRange();
const periodLabel = period.label;
const periodStartIso = period.startIso;
const periodEndIso = period.endIso;
const MONTHLY_LIMIT = 5000;
let monthlyConvErr: Error | null = null;
let monthlyConvRaw: ConversionRow[] = [];
try {
  const r = await query<ConversionRow>(
    "select id, offer_id, reward, payout, amount, commission, status, created_at, ip, ip_hash, ip_version, country, user_agent, accept_language, origin, referrer, page_url, cf_ray, cf_connecting_ip, cf_ipcountry, x_forwarded_for, request_id, request_headers, student_id, student_id_hash from conversions where created_at >= $1 and created_at < $2 and status = 'approved' order by created_at desc limit $3",
    [periodStartIso, periodEndIso, MONTHLY_LIMIT],
  );
  monthlyConvRaw = r.rows ?? [];
} catch (e: any) {
  monthlyConvErr = e;
}

// Summary counts (exact count via head request)
let totalClicksErr: Error | null = null;
let totalConvErr: Error | null = null;
let totalClicks: number | null = null;
let totalConversions: number | null = null;
let approvedConvErr: Error | null = null;
let approvedConversions: number | null = null;
try {
  const w = sqlWhereCreatedAtRange(range?.startIso ?? null, range?.endIso ?? null);
  const r = await query<{ count: number }>(`select count(*)::bigint as count from clicks ${w.whereSql}`, w.params);
  totalClicks = r.rows?.[0]?.count ?? 0;
} catch (e: any) {
  totalClicksErr = e;
  totalClicks = 0;
}
try {
  const w = sqlWhereCreatedAtRange(range?.startIso ?? null, range?.endIso ?? null, hasStatusFilter ? statusFilter : null);
  const r = await query<{ count: number }>(`select count(*)::bigint as count from conversions ${w.whereSql}`, w.params);
  totalConversions = r.rows?.[0]?.count ?? 0;
} catch (e: any) {
  totalConvErr = e;
  totalConversions = 0;
}
try {
  const w = sqlWhereCreatedAtRange(range?.startIso ?? null, range?.endIso ?? null);
  const statusSql = w.whereSql ? `${w.whereSql} and status = 'approved'` : "where status = 'approved'";
  const r = await query<{ count: number }>(`select count(*)::bigint as count from conversions ${statusSql}`, w.params);
  approvedConversions = r.rows?.[0]?.count ?? 0;
} catch (e: any) {
  approvedConvErr = e;
  approvedConversions = 0;
}

// Sum rewards (best-effort across common column names)
// Prefer server-side sum if a 'reward' column exists; otherwise we fall back to summing latest 10 only.
let totalRewardYen: number | null = null;
try {
  const w = sqlWhereCreatedAtRange(range?.startIso ?? null, range?.endIso ?? null);
  const statusSql = w.whereSql ? `${w.whereSql} and status = 'approved'` : "where status = 'approved'";
  const r = await query<{ reward: number | null }>(`select sum(reward) as reward from conversions ${statusSql}`, w.params);
  const v = r.rows?.[0]?.reward;
  totalRewardYen = typeof v === "number" && Number.isFinite(v) ? v : null;
} catch {
  totalRewardYen = null;
}

const clicks = (clicksRaw ?? []) as ClickRow[];
const conversions = (convRaw ?? []) as ConversionRow[];
const monthlyConversions = (monthlyConvRaw ?? []) as ConversionRow[];

const offerIds = new Set<string>();
for (const c of clicks) if (c.offer_id != null) offerIds.add(String(c.offer_id));
for (const c of conversions) if (c.offer_id != null) offerIds.add(String(c.offer_id));
for (const c of monthlyConversions) if (c.offer_id != null) offerIds.add(String(c.offer_id));

let offersMap = new Map<string, Offer>();
if (offerIds.size) {
  try {
    const r = await query<Offer>(
      "select id::text as id, name, title from offers where id::text = any($1::text[])",
      [Array.from(offerIds)],
    );
    for (const o of (r.rows ?? []) as Offer[]) offersMap.set(String(o.id), o);
  } catch {
    // If offers table doesn't exist yet, we still want the page to render.
  }
}

const monthlyAggMap = new Map<string, { count: number; rewardSum: number }>();
for (const cv of monthlyConversions) {
  if (cv.offer_id == null) continue;
  const key = String(cv.offer_id);
  const cur = monthlyAggMap.get(key) ?? { count: 0, rewardSum: 0 };
  cur.count += 1;
  const v = rewardValue(cv);
  if (v != null) cur.rewardSum += v;
  monthlyAggMap.set(key, cur);
}
const monthlyAgg = Array.from(monthlyAggMap.entries())
  .map(([offerId, v]) => ({
    offerId,
    offerName: offerNameById(offersMap, offerId),
    count: v.count,
    rewardSum: v.rewardSum,
  }))
  .sort((a, b) => b.count - a.count);
const monthlyLimitHit = monthlyConversions.length >= MONTHLY_LIMIT;

const errors: string[] = [];
if (dbEnvError) errors.push(dbEnvError);
if (clicksErr) errors.push(`clicks: ${clicksErr.message}`);
if (convErr) errors.push(`conversions: ${convErr.message}`);
if (monthlyConvErr) errors.push(`monthlyConversions: ${monthlyConvErr.message}`);
if (totalClicksErr) errors.push(`totalClicks: ${totalClicksErr.message}`);
if (totalConvErr) errors.push(`totalConversions: ${totalConvErr.message}`);
if (approvedConvErr) errors.push(`approvedConversions: ${approvedConvErr.message}`);

const totalPages = Math.max(1, Math.ceil((totalConversions ?? 0) / pageSize));
const pageClamped = Math.min(page, totalPages);
const showingFrom = (totalConversions ?? 0) === 0 ? 0 : (pageClamped - 1) * pageSize + 1;
const showingTo = Math.min((totalConversions ?? 0), pageClamped * pageSize);
---

<Layout title="Tracker" description="Affiliate tracker admin" robots="noindex,nofollow" showHeader={false}>
  <Fragment slot="head">
    <!-- Allow same-origin Referer for POSTs; avoid leaking to other origins -->
    <meta name="referrer" content="same-origin" />
  </Fragment>
  <TrackerHeader />
  <main class="mx-auto w-full max-w-5xl px-4 pb-14 pt-8">
    <div class="flex flex-wrap items-end justify-between gap-4">
      <div>
        <h1 class="text-2xl font-extrabold text-zinc-900">成果トラッカー</h1>
        <p class="mt-1 text-sm text-zinc-600">/tracker（Basic認証保護）</p>
      </div>
      <div class="text-xs text-zinc-500">更新: {new Date().toLocaleString("ja-JP")}</div>
    </div>

    <section class="mt-6 rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <div class="text-xs font-extrabold text-zinc-500">管理</div>
          <div class="mt-1 text-sm font-semibold text-zinc-700">スクール情報・レビュー・成果を管理できます。</div>
        </div>
        <div class="flex flex-wrap gap-2">
          <a class="rounded-xl bg-zinc-900 px-4 py-2 text-sm font-extrabold text-white" href="/tracker/content">コンテンツ編集</a>
          <a class="rounded-xl border border-zinc-200 bg-white px-4 py-2 text-sm font-extrabold text-zinc-900 hover:bg-zinc-50" href="/tracker/reviews">レビュー管理</a>
        </div>
      </div>
    </section>

    <section class="mt-6 rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
      <div class="flex flex-wrap items-end justify-between gap-3">
        <div>
          <div class="text-xs font-extrabold text-zinc-500">表示期間</div>
          <div class="mt-1 text-base font-extrabold text-zinc-900">
            {searchParams.get("from") || searchParams.get("to") ? `期間指定（${range.label}）` : `デフォルト（${range.label}）`}
          </div>
        </div>
        <a class="text-sm font-extrabold text-[color:var(--brand-link)] underline decoration-[#aebcff] underline-offset-2 hover:text-[color:var(--brand-link-hover)]" href="/tracker">
          クリア
        </a>
      </div>

      <form method="get" class="mt-4 flex flex-wrap items-end gap-3">
        <label class="block">
          <div class="text-xs font-extrabold text-zinc-500">開始日</div>
          <input
            type="date"
            name="from"
            value={range?.fromYmd ?? ""}
            class="mt-1 rounded-lg border border-zinc-200 bg-white px-3 py-2 text-sm font-semibold text-zinc-900 shadow-sm"
          />
        </label>
        <label class="block">
          <div class="text-xs font-extrabold text-zinc-500">終了日</div>
          <input
            type="date"
            name="to"
            value={range?.toYmd ?? ""}
            class="mt-1 rounded-lg border border-zinc-200 bg-white px-3 py-2 text-sm font-semibold text-zinc-900 shadow-sm"
          />
        </label>
        {statusFilter.map((s) => (
          <input type="hidden" name="status" value={s} />
        ))}
        <input type="hidden" name="per" value={String(pageSize)} />
        <button
          type="submit"
          class="btn-brand inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-extrabold text-white shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-orange-300 focus-visible:ring-offset-2 focus-visible:ring-offset-white"
        >
          絞り込む
        </button>
      </form>

      <div class="mt-4">
        <div class="text-xs font-extrabold text-zinc-500 mb-2">ステータスで絞り込み</div>
        <form method="get" class="flex flex-wrap items-center gap-3">
          {searchParams.get("from") ? <input type="hidden" name="from" value={searchParams.get("from") ?? ""} /> : null}
          {searchParams.get("to") ? <input type="hidden" name="to" value={searchParams.get("to") ?? ""} /> : null}
          <input type="hidden" name="per" value={String(pageSize)} />
          <label class="inline-flex items-center gap-2">
            <input
              type="checkbox"
              name="status"
              value="pending"
              checked={statusFilter.includes("pending")}
              onchange="this.form.submit()"
              class="rounded border-zinc-300 text-[color:var(--brand-link)] focus:ring-[color:var(--brand-link)]"
            />
            <span class="text-sm font-semibold text-zinc-700">pending</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input
              type="checkbox"
              name="status"
              value="check"
              checked={statusFilter.includes("check")}
              onchange="this.form.submit()"
              class="rounded border-zinc-300 text-[color:var(--brand-link)] focus:ring-[color:var(--brand-link)]"
            />
            <span class="text-sm font-semibold text-zinc-700">check</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input
              type="checkbox"
              name="status"
              value="approved"
              checked={statusFilter.includes("approved")}
              onchange="this.form.submit()"
              class="rounded border-zinc-300 text-[color:var(--brand-link)] focus:ring-[color:var(--brand-link)]"
            />
            <span class="text-sm font-semibold text-zinc-700">approved</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input
              type="checkbox"
              name="status"
              value="rejected"
              checked={statusFilter.includes("rejected")}
              onchange="this.form.submit()"
              class="rounded border-zinc-300 text-[color:var(--brand-link)] focus:ring-[color:var(--brand-link)]"
            />
            <span class="text-sm font-semibold text-zinc-700">rejected</span>
          </label>
          {hasStatusFilter ? (
            <a
              href={buildHref({ status: null })}
              class="text-xs font-extrabold text-[color:var(--brand-link)] underline decoration-[#aebcff] underline-offset-2 hover:text-[color:var(--brand-link-hover)]"
            >
              クリア
            </a>
          ) : null}
        </form>
      </div>

      <div class="mt-3 flex flex-wrap gap-2 text-xs font-semibold">
        <a class="rounded-full bg-zinc-100 px-3 py-1 text-zinc-700 hover:bg-zinc-200" href={`/tracker?from=${todayYmd}&to=${todayYmd}`}>
          今日
        </a>
        <a
          class="rounded-full bg-zinc-100 px-3 py-1 text-zinc-700 hover:bg-zinc-200"
          href={`/tracker?from=${last7.fromYmd}&to=${last7.toYmd}`}
        >
          直近7日
        </a>
      </div>
    </section>

    {errors.length ? (
      <div class="mt-6 rounded-2xl border border-rose-200 bg-rose-50 p-4 text-sm text-rose-900">
        <div class="font-extrabold">データ取得エラー</div>
        <ul class="mt-2 list-disc pl-5">
          {errors.map((e) => (
            <li>{e}</li>
          ))}
        </ul>
      </div>
    ) : null}

    <section class="mt-6 grid gap-4 sm:grid-cols-3">
      <div class="rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
        <div class="text-xs font-extrabold text-zinc-500">総クリック数</div>
        <div class="mt-2 text-3xl font-extrabold text-zinc-900">{totalClicks ?? 0}</div>
      </div>
      <div class="rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
        <div class="text-xs font-extrabold text-zinc-500">承認コンバージョン数（請求対象）</div>
        <div class="mt-2 text-3xl font-extrabold text-zinc-900">{approvedConversions ?? 0}</div>
        <div class="mt-1 text-xs text-zinc-500">全ステータス: {totalConversions ?? 0}</div>
      </div>
      <div class="rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
        <div class="text-xs font-extrabold text-zinc-500">合計報酬額（承認のみ）</div>
        <div class="mt-2 text-3xl font-extrabold text-zinc-900">
          {totalRewardYen == null ? "—" : yen(totalRewardYen)}
        </div>
        <div class="mt-1 text-xs text-zinc-500">※ `conversions.reward` の合計（必要なら列名を調整）</div>
      </div>
    </section>

    <section class="mt-10">
      <div class="flex flex-wrap items-end justify-between gap-3">
        <div>
          <h2 class="text-lg font-extrabold text-zinc-900">{periodLabel} のコンバージョン数（案件別）</h2>
          <p class="mt-1 text-sm text-zinc-600">
            {range ? "指定期間の成果件数を案件ごとに集計します（承認のみ）。" : "当月（JST）の成果件数を案件ごとに集計します（承認のみ）。"}
          </p>
        </div>
        <div class="text-xs text-zinc-500">
          期間: {fmtDate(periodStartIso)} 〜 {fmtDate(periodEndIso)}
        </div>
      </div>

      <div class="mt-3 grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        {monthlyAgg.map((x) => (
          <div class="rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
            <div class="text-xs font-extrabold text-zinc-500">案件</div>
            <div class="mt-1 truncate text-base font-extrabold text-zinc-900">{x.offerName}</div>
            <div class="mt-3 flex items-end justify-between gap-4">
              <div>
                <div class="text-xs font-extrabold text-zinc-500">CV</div>
                <div class="mt-1 text-3xl font-extrabold text-zinc-900">{x.count}</div>
              </div>
              <div class="text-right">
                <div class="text-xs font-extrabold text-zinc-500">報酬（合計）</div>
                <div class="mt-1 text-base font-extrabold text-zinc-900">{x.rewardSum ? yen(x.rewardSum) : "—"}</div>
              </div>
            </div>
          </div>
        ))}

        {!monthlyAgg.length ? (
          <div class="rounded-2xl border border-zinc-200 bg-white p-5 text-sm font-semibold text-zinc-500 shadow-sm sm:col-span-2 lg:col-span-3">
            当月のコンバージョンがまだありません。
          </div>
        ) : null}
      </div>

      {monthlyLimitHit ? (
        <div class="mt-3 rounded-2xl border border-[#c9d4ff] bg-[#eef3ff] p-4 text-sm text-[#2f46b6]">
          <div class="font-extrabold">注意</div>
          <p class="mt-1">
            当月データが {MONTHLY_LIMIT} 件以上あるため、集計は先頭 {MONTHLY_LIMIT} 件で打ち切っています。
            必要ならDB側の集計（SQL/RPC）に切り替えます。
          </p>
        </div>
      ) : null}
    </section>

    <section class="mt-10">
      <h2 class="text-lg font-extrabold text-zinc-900">直近のクリックログ（最新10件）</h2>
      <div class="mt-3 overflow-hidden rounded-2xl border border-zinc-200 bg-white shadow-sm">
        <div class="overflow-x-auto">
          <table class="w-full min-w-[860px] text-left text-sm">
            <thead class="bg-zinc-50 text-xs font-extrabold text-zinc-600">
              <tr>
                <th class="px-4 py-3">日時</th>
                <th class="px-4 py-3">案件</th>
                <th class="px-4 py-3">click_id</th>
                <th class="px-4 py-3">URL</th>
                <th class="px-4 py-3">Referrer</th>
                <th class="px-4 py-3">IP</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-zinc-200">
              {clicks.map((c) => (
                <tr class="align-top">
                  <td class="px-4 py-3 whitespace-nowrap">{fmtDate(c.created_at)}</td>
                  <td class="px-4 py-3 font-semibold text-zinc-900">{offerNameById(offersMap, c.offer_id)}</td>
                  <td class="px-4 py-3 whitespace-nowrap text-xs font-mono text-zinc-700">{c.click_id ?? "—"}</td>
                  <td class="px-4 py-3">
                    {c.url ? <span class="break-all text-xs text-zinc-700">{c.url}</span> : <span class="text-zinc-400">—</span>}
                  </td>
                  <td class="px-4 py-3">
                    {c.referrer ? (
                      <span class="break-all text-xs text-zinc-700">{c.referrer}</span>
                    ) : (
                      <span class="text-zinc-400">—</span>
                    )}
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-xs text-zinc-700">
                    {c.ip ? (
                      <span title={c.ip} class="inline-flex items-center gap-2">
                        <span class="inline-flex items-center rounded-full bg-zinc-100 px-2 py-0.5 text-[11px] font-extrabold text-zinc-700">
                          {c.ip_version === 6 ? "IPv6" : c.ip_version === 4 ? "IPv4" : "IP"}
                        </span>
                        <span class="font-mono">{shortText(c.ip, 36)}</span>
                      </span>
                    ) : (
                      "—"
                    )}
                  </td>
                </tr>
              ))}
              {!clicks.length ? (
                <tr>
                  <td class="px-4 py-6 text-center text-zinc-500" colspan="6">
                    データなし
                  </td>
                </tr>
              ) : null}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="mt-10">
      <h2 class="text-lg font-extrabold text-zinc-900">成果一覧</h2>
      <div class="mt-2 flex flex-wrap items-end justify-between gap-3">
        <div class="text-xs font-semibold text-zinc-500">
          {showingFrom}–{showingTo} / {totalConversions ?? 0} 件（{range.label}）
        </div>

        <div class="flex items-center gap-2">
          <form method="get" class="flex items-center gap-2">
            {searchParams.get("from") ? <input type="hidden" name="from" value={searchParams.get("from") ?? ""} /> : null}
            {searchParams.get("to") ? <input type="hidden" name="to" value={searchParams.get("to") ?? ""} /> : null}
            {statusFilter.map((s) => (
              <input type="hidden" name="status" value={s} />
            ))}
            <input type="hidden" name="page" value="1" />
            <label class="inline-flex items-center gap-2">
              <span class="text-xs font-extrabold text-zinc-500">表示件数</span>
              <select
                name="per"
                class="rounded-lg border border-zinc-200 bg-white px-2 py-1 text-xs font-semibold text-zinc-900 shadow-sm"
                onchange="this.form.submit()"
              >
                <option value="10" selected={pageSize === 10}>10</option>
                <option value="50" selected={pageSize === 50}>50</option>
                <option value="100" selected={pageSize === 100}>100</option>
              </select>
            </label>
          </form>

          <div class="flex items-center gap-1">
            <a
              class:list={[
                "rounded-lg border px-3 py-1 text-xs font-extrabold shadow-sm",
                pageClamped <= 1 ? "pointer-events-none border-zinc-200 bg-zinc-100 text-zinc-400" : "border-zinc-200 bg-white text-zinc-800 hover:bg-zinc-50",
              ]}
              href={buildHref({ page: pageClamped - 1 })}
            >
              前へ
            </a>
            <span class="px-2 text-xs font-semibold text-zinc-500">
              {pageClamped} / {totalPages}
            </span>
            <a
              class:list={[
                "rounded-lg border px-3 py-1 text-xs font-extrabold shadow-sm",
                pageClamped >= totalPages ? "pointer-events-none border-zinc-200 bg-zinc-100 text-zinc-400" : "border-zinc-200 bg-white text-zinc-800 hover:bg-zinc-50",
              ]}
              href={buildHref({ page: pageClamped + 1 })}
            >
              次へ
            </a>
          </div>
        </div>
      </div>

      <div class="mt-3 overflow-hidden rounded-2xl border border-zinc-200 bg-white shadow-sm">
        <div class="overflow-x-auto">
          <table class="w-full min-w-[1540px] text-left text-sm">
            <thead class="bg-zinc-50 text-xs font-extrabold text-zinc-600">
              <tr>
                <th class="px-4 py-3">日時</th>
                <th class="px-4 py-3">案件</th>
                <th class="px-4 py-3">student_id</th>
                <th class="px-4 py-3">ステータス</th>
                <th class="px-4 py-3">コメント</th>
                <th class="px-4 py-3">報酬</th>
                <th class="px-4 py-3">国</th>
                <th class="px-4 py-3">IP</th>
                <th class="px-4 py-3">Origin</th>
                <th class="px-4 py-3">Referrer</th>
                <th class="px-4 py-3">UA</th>
                <th class="px-4 py-3">詳細</th>
                <th class="px-4 py-3">ID</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-zinc-200">
              {conversions.map((cv) => {
                const v = rewardValue(cv);
                const suspicious = isSuspicious(cv);
                return (
                  <tr class="align-top">
                    <td class="px-4 py-3 whitespace-nowrap">{fmtDate(cv.created_at)}</td>
                    <td class="px-4 py-3 font-semibold text-zinc-900">{offerNameById(offersMap, cv.offer_id)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-xs text-zinc-700">
                      <span class="inline-flex items-center gap-2">
                        <span class="font-mono" title={cv.student_id ?? ""}>{maskId(cv.student_id)}</span>
                      </span>
                    </td>
                    <td class="px-4 py-3">
                      <form method="post" action="/api/tracker/conversion-status" class="flex items-center gap-2">
                        <input type="hidden" name="id" value={String(cv.id ?? "")} />
                        <input type="hidden" name="returnTo" value={returnTo} />
                        <select
                          name="status"
                          class="rounded-lg border border-zinc-200 bg-white px-2 py-1 text-xs font-extrabold text-zinc-900 shadow-sm"
                          onchange="this.form.submit()"
                        >
                          <option value="pending" selected={(cv.status ?? "pending") === "pending"}>pending</option>
                          <option value="check" selected={(cv.status ?? "") === "check"}>check</option>
                          <option value="approved" selected={(cv.status ?? "") === "approved"}>approved</option>
                          <option value="rejected" selected={(cv.status ?? "") === "rejected"}>rejected</option>
                        </select>
                        <noscript>
                          <button type="submit" class="rounded-lg border border-zinc-200 bg-white px-2 py-1 text-xs font-extrabold text-zinc-800 hover:bg-zinc-50">
                            更新
                          </button>
                        </noscript>
                      </form>
                    </td>
                    <td class="px-4 py-3 text-xs text-zinc-700">
                      {cv.review_comment ? (
                        <span class="inline-block max-w-[220px] truncate align-top" title={cv.review_comment}>
                          {cv.review_comment}
                        </span>
                      ) : (
                        "—"
                      )}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">{v == null ? "—" : yen(v)}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                      {cv.country ?? cv.cf_ipcountry ?? "—"}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-xs text-zinc-700">
                      {cv.ip ? (
                        <span title={cv.ip} class="inline-flex items-center gap-2">
                          <span class="inline-flex items-center rounded-full bg-zinc-100 px-2 py-0.5 text-[11px] font-extrabold text-zinc-700">
                            {ipLabel(cv)}
                          </span>
                          <span class="font-mono">{shortText(cv.ip, 36)}</span>
                        </span>
                      ) : (
                        "—"
                      )}
                    </td>
                    <td class="px-4 py-3 text-xs text-zinc-700">
                      <span
                        class:list={[
                          "inline-block max-w-[240px] truncate align-top",
                          suspicious ? "font-extrabold text-rose-700" : "text-zinc-700",
                        ]}
                        title={cv.origin ?? ""}
                      >
                        {cv.origin ?? "—"}
                      </span>
                      {suspicious ? (
                        <span class="ml-2 inline-flex items-center rounded-full bg-rose-50 px-2 py-0.5 text-[11px] font-extrabold text-rose-700 ring-1 ring-rose-200">
                          要確認
                        </span>
                      ) : null}
                    </td>
                    <td class="px-4 py-3 text-xs text-zinc-700">
                      {cv.referrer ? (
                        <span class="inline-block max-w-[320px] truncate align-top" title={cv.referrer}>
                          {cv.referrer}
                        </span>
                      ) : (
                        "—"
                      )}
                    </td>
                    <td class="px-4 py-3 text-xs text-zinc-700">
                      {cv.user_agent ? (
                        <span class="inline-block max-w-[360px] truncate align-top font-mono" title={cv.user_agent}>
                          {cv.user_agent}
                        </span>
                      ) : (
                        "—"
                      )}
                    </td>
                    <td class="px-4 py-3 text-xs text-zinc-700">
                      <details>
                        <summary class="cursor-pointer select-none font-extrabold text-[color:var(--brand-link)] underline decoration-[#aebcff] underline-offset-2 hover:text-[color:var(--brand-link-hover)]">
                          表示
                        </summary>
                        <div class="mt-2 space-y-2">
                          <div>
                            <div class="text-[11px] font-extrabold text-zinc-500">click_id</div>
                            <div class="break-all font-mono">{cv.click_id ?? "—"}</div>
                          </div>
                          <div>
                            <div class="text-[11px] font-extrabold text-zinc-500">student_id / hash</div>
                            <div class="break-all font-mono">{cv.student_id ?? "—"}</div>
                            <div class="break-all font-mono text-zinc-500">{cv.student_id_hash ?? "—"}</div>
                          </div>
                          <div>
                            <div class="text-[11px] font-extrabold text-zinc-500">event_id / client_ts_ms</div>
                            <div class="break-all font-mono">{cv.event_id ?? "—"}</div>
                            <div class="break-all font-mono text-zinc-500">{cv.client_ts_ms ?? "—"}</div>
                          </div>
                          <div>
                            <div class="text-[11px] font-extrabold text-zinc-500">risk</div>
                            <pre class="max-w-[520px] overflow-x-auto rounded-lg border border-zinc-200 bg-zinc-50 p-2 text-[11px] leading-relaxed text-zinc-800">
{cv.risk ? JSON.stringify(cv.risk, null, 2) : "—"}
                            </pre>
                          </div>
                          <div>
                            <div class="text-[11px] font-extrabold text-zinc-500">comment</div>
                            <div class="break-words">{cv.review_comment ?? "—"}</div>
                          </div>
                          <div>
                            <div class="text-[11px] font-extrabold text-zinc-500">ip（full）</div>
                            <div class="break-all font-mono">{cv.ip ?? "—"}</div>
                          </div>
                          <div>
                            <div class="text-[11px] font-extrabold text-zinc-500">page_url</div>
                            <div class="break-all">{cv.page_url ?? "—"}</div>
                          </div>
                          <div>
                            <div class="text-[11px] font-extrabold text-zinc-500">cf_ray / request_id</div>
                            <div class="break-all">{cv.cf_ray ?? "—"} / {cv.request_id ?? "—"}</div>
                          </div>
                          <div>
                            <div class="text-[11px] font-extrabold text-zinc-500">headers</div>
                            <pre class="max-w-[520px] overflow-x-auto rounded-lg border border-zinc-200 bg-zinc-50 p-2 text-[11px] leading-relaxed text-zinc-800">
{cv.request_headers ? JSON.stringify(cv.request_headers, null, 2) : "—"}
                            </pre>
                          </div>
                        </div>
                      </details>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-xs text-zinc-600">{cv.id ?? "—"}</td>
                  </tr>
                );
              })}
              {!conversions.length ? (
                <tr>
                  <td class="px-4 py-6 text-center text-zinc-500" colspan="13">
                    データなし
                  </td>
                </tr>
              ) : null}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="mt-10 rounded-2xl border border-zinc-200 bg-zinc-50 p-5 text-sm text-zinc-700">
      <div class="font-extrabold text-zinc-900">環境変数（サーバー）</div>
      <ul class="mt-2 list-disc pl-5">
        <li><span class="font-semibold">DATABASE_URL</span></li>
        <li>
          （必要な場合のみ）<span class="font-semibold">PGSSLMODE</span>=require
        </li>
      </ul>
    </section>

    <section class="mt-10 rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
      <div class="flex flex-wrap items-end justify-between gap-3">
        <div>
          <h2 class="text-lg font-extrabold text-zinc-900">GTM（成果発生ページ）テンプレ</h2>
          <p class="mt-1 text-sm text-zinc-600">
            成果が発生したページ（例: <code class="font-semibold">br.glats.online</code> の完了ページ）に貼る用です。
          </p>
        </div>
        <a class="text-sm font-extrabold text-[color:var(--brand-link)] underline decoration-[#aebcff] underline-offset-2 hover:text-[color:var(--brand-link-hover)]" href="/tracker/howto">
          手順ページへ →
        </a>
      </div>

      <div class="mt-4 overflow-hidden rounded-xl border border-zinc-200 bg-zinc-50">
        <pre class="overflow-x-auto p-4 text-xs leading-relaxed text-zinc-800"><code>{`<script>
(function () {
  var TTL_DAYS = 14;
  function getParam(name) {
    try {
      var qs = location && location.search ? location.search : "";
      if (!qs) return null;
      var pairs = qs.replace(/^\?/, "").split("&");
      for (var i = 0; i < pairs.length; i++) {
        var p = pairs[i].split("=");
        var k = decodeURIComponent((p[0] || "").replace(/\+/g, " "));
        if (k === name) return decodeURIComponent(((p[1] || "") + "").replace(/\+/g, " "));
      }
    } catch (e) {}
    return null;
  }

  function getCookie(name) {
    try {
      var prefix = name + "=";
      var parts = (document.cookie || "").split("; ");
      for (var i = 0; i < parts.length; i++) {
        if (parts[i].indexOf(prefix) === 0) return decodeURIComponent(parts[i].slice(prefix.length));
      }
    } catch (e) {}
    return null;
  }

  function readStoredClickId(offerId) {
    var now = new Date().getTime();
    try {
      var ts = Number(localStorage.getItem("eo_click_ts:" + offerId) || "0");
      var id = localStorage.getItem("eo_click_id:" + offerId);
      if (id && ts && now - ts <= TTL_DAYS * 24 * 60 * 60 * 1000) return id;
    } catch (e) {}
    return getCookie("eo_click_id_" + offerId);
  }

  function genEventId() {
    // UUIDv4-like (best-effort). Uses crypto.getRandomValues when available.
    try {
      var c = (window && (window.crypto || window.msCrypto)) || null;
      if (c && c.getRandomValues) {
        var b = new Uint8Array(16);
        c.getRandomValues(b);
        b[6] = (b[6] & 0x0f) | 0x40; // version 4
        b[8] = (b[8] & 0x3f) | 0x80; // variant
        var hex = [];
        for (var i = 0; i < b.length; i++) hex.push((b[i] + 256).toString(16).slice(1));
        return (
          hex.slice(0, 4).join("") +
          "-" +
          hex.slice(4, 6).join("") +
          "-" +
          hex.slice(6, 8).join("") +
          "-" +
          hex.slice(8, 10).join("") +
          "-" +
          hex.slice(10, 16).join("")
        );
      }
    } catch (e) {}
    return "e-" + String(new Date().getTime()) + "-" + String(Math.random()).slice(2);
  }

  var offerId = "kimini";
  var clickId = getParam("click_id");
  if (!clickId) {
    clickId = readStoredClickId(offerId);
  }
  if (!clickId) return;

  var payload = {
    offer_id: offerId,
    click_id: clickId,
    student_id: getParam("student_id"), // 任意: ?student_id=... を受け取る
    status: "approved",
    reward: 1500,
    page_url: location && location.href ? String(location.href) : null
  };
  // Idempotency key: reuse within the same browser session to avoid double counting
  try {
    var key = "eo_cv_event_id:" + String(payload.offer_id || "") + ":" + String((location && location.pathname) || "");
    var eid = null;
    try { eid = sessionStorage.getItem(key); } catch (e) {}
    if (!eid) {
      eid = genEventId();
      try { sessionStorage.setItem(key, eid); } catch (e) {}
    }
    payload.event_id = eid;
  } catch (e) {}
  payload.client_ts_ms = new Date().getTime();
  var url = "https://eigoonline.com/api/track/conversion";
  var body = JSON.stringify(payload);

  try {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", url, true);
    xhr.withCredentials = false; // これを明示
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.send(body);
  } catch (e) {}
})();
</script>`}</code></pre>
      </div>

      <div class="mt-3 text-xs text-zinc-500">
        <span class="font-semibold">ポイント:</span> <code class="font-semibold">offer_id</code> は <code class="font-semibold">offers.id</code> に存在する値にしてください（FK制約）。
      </div>
    </section>
  </main>
</Layout>

