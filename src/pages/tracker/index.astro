---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import { dbEnvError, query } from "../../lib/db";
import TrackerHeader from "../../components/TrackerHeader.astro";

type Offer = { id: string | number; name?: string | null; title?: string | null };
type ClickRow = {
  id?: string | number;
  created_at?: string | Date | null;
  offer_id?: string | number | null;
  url?: string | null;
  referrer?: string | null;
  user_agent?: string | null;
  ip?: string | null;
};
type ConversionRow = {
  id?: string | number;
  created_at?: string | Date | null;
  offer_id?: string | number | null;
  offer_uuid?: string | null;
  student_id?: string | null;
  student_id_hash?: string | null;
  reward?: number | null;
  payout?: number | null;
  amount?: number | null;
  commission?: number | null;
  status?: string | null;
  ip?: string | null;
  ip_hash?: string | null;
  ip_version?: number | null;
  country?: string | null;
  user_agent?: string | null;
  accept_language?: string | null;
  origin?: string | null;
  referrer?: string | null;
  page_url?: string | null;
  cf_ray?: string | null;
  cf_connecting_ip?: string | null;
  cf_ipcountry?: string | null;
  x_forwarded_for?: string | null;
  request_id?: string | null;
  request_headers?: Record<string, any> | null;
};

function yen(n: number) {
  return new Intl.NumberFormat("ja-JP", { style: "currency", currency: "JPY", maximumFractionDigits: 0 }).format(n);
}

function getTokyoMonthRange(now = new Date()) {
  // Compute month boundaries in JST, represented as UTC ISO strings for DB filtering.
  const parts = new Intl.DateTimeFormat("en-US", {
    timeZone: "Asia/Tokyo",
    year: "numeric",
    month: "2-digit",
  }).formatToParts(now);
  const year = Number(parts.find((p) => p.type === "year")?.value ?? now.getUTCFullYear());
  const month = Number(parts.find((p) => p.type === "month")?.value ?? now.getUTCMonth() + 1); // 1-12
  // JST midnight == UTC-9h
  const startUtc = new Date(Date.UTC(year, month - 1, 1, -9, 0, 0));
  const endUtc = new Date(Date.UTC(year, month, 1, -9, 0, 0));
  return {
    label: `${year}年${month}月`,
    startIso: startUtc.toISOString(),
    endIso: endUtc.toISOString(),
  };
}

function fmtDate(iso?: string | Date | null) {
  if (!iso) return "—";
  const d = iso instanceof Date ? iso : new Date(iso);
  if (Number.isNaN(d.getTime())) return iso;
  return d.toLocaleString("ja-JP");
}

function offerNameById(offers: Map<string, Offer>, id: string | number | null | undefined) {
  if (id === null || id === undefined) return "—";
  const o = offers.get(String(id));
  return o?.name ?? o?.title ?? `offer:${id}`;
}

function rewardValue(r: ConversionRow) {
  const v = r.reward ?? r.payout ?? r.amount ?? r.commission;
  return typeof v === "number" && Number.isFinite(v) ? v : null;
}

function shortText(s?: string | null, max = 64) {
  if (!s) return "—";
  const t = String(s);
  return t.length > max ? `${t.slice(0, max - 1)}…` : t;
}

const ALLOWED_ORIGINS = new Set(["https://eigoonline.com", "https://www.eigoonline.com", "https://br.glats.online"]);

function isSuspicious(cv: ConversionRow) {
  // Heuristics (best-effort): missing/unknown origin or country, very long UA, etc.
  if (cv.origin && !ALLOWED_ORIGINS.has(cv.origin)) return true;
  if (!cv.origin) return true;
  return false;
}

function ipLabel(cv: ConversionRow) {
  if (!cv.ip) return "—";
  const v = cv.ip_version === 6 ? "IPv6" : cv.ip_version === 4 ? "IPv4" : "IP";
  return `${v}`;
}

function maskId(s?: string | null) {
  if (!s) return "—";
  const t = String(s);
  if (t.length <= 10) return t;
  return `${t.slice(0, 4)}…${t.slice(-4)}`;
}

// Fetch latest logs first (we'll derive offers map from their offer_ids)
let clicksErr: Error | null = null;
let convErr: Error | null = null;
let clicksRaw: ClickRow[] = [];
let convRaw: ConversionRow[] = [];
try {
  const r = await query<ClickRow>("select * from clicks order by created_at desc limit 10");
  clicksRaw = r.rows ?? [];
} catch (e: any) {
  clicksErr = e;
}
try {
  const r = await query<ConversionRow>("select * from conversions order by created_at desc limit 10");
  convRaw = r.rows ?? [];
} catch (e: any) {
  convErr = e;
}

// Monthly conversions per offer (JST month)
const { label: monthLabel, startIso: monthStartIso, endIso: monthEndIso } = getTokyoMonthRange();
const MONTHLY_LIMIT = 5000;
let monthlyConvErr: Error | null = null;
let monthlyConvRaw: ConversionRow[] = [];
try {
  const r = await query<ConversionRow>(
    "select id, offer_id, reward, payout, amount, commission, created_at from conversions where created_at >= $1 and created_at < $2 order by created_at desc limit $3",
    [monthStartIso, monthEndIso, MONTHLY_LIMIT],
  );
  monthlyConvRaw = r.rows ?? [];
} catch (e: any) {
  monthlyConvErr = e;
}

// Summary counts (exact count via head request)
let totalClicksErr: Error | null = null;
let totalConvErr: Error | null = null;
let totalClicks: number | null = null;
let totalConversions: number | null = null;
try {
  const r = await query<{ count: number }>("select count(*)::bigint as count from clicks");
  totalClicks = r.rows?.[0]?.count ?? 0;
} catch (e: any) {
  totalClicksErr = e;
  totalClicks = 0;
}
try {
  const r = await query<{ count: number }>("select count(*)::bigint as count from conversions");
  totalConversions = r.rows?.[0]?.count ?? 0;
} catch (e: any) {
  totalConvErr = e;
  totalConversions = 0;
}

// Sum rewards (best-effort across common column names)
// Prefer server-side sum if a 'reward' column exists; otherwise we fall back to summing latest 10 only.
let totalRewardYen: number | null = null;
try {
  const r = await query<{ reward: number | null }>("select sum(reward) as reward from conversions");
  const v = r.rows?.[0]?.reward;
  totalRewardYen = typeof v === "number" && Number.isFinite(v) ? v : null;
} catch {
  totalRewardYen = null;
}

const clicks = (clicksRaw ?? []) as ClickRow[];
const conversions = (convRaw ?? []) as ConversionRow[];
const monthlyConversions = (monthlyConvRaw ?? []) as ConversionRow[];

const offerIds = new Set<string>();
for (const c of clicks) if (c.offer_id != null) offerIds.add(String(c.offer_id));
for (const c of conversions) if (c.offer_id != null) offerIds.add(String(c.offer_id));
for (const c of monthlyConversions) if (c.offer_id != null) offerIds.add(String(c.offer_id));

let offersMap = new Map<string, Offer>();
if (offerIds.size) {
  try {
    const r = await query<Offer>(
      "select id::text as id, name, title from offers where id::text = any($1::text[])",
      [Array.from(offerIds)],
    );
    for (const o of (r.rows ?? []) as Offer[]) offersMap.set(String(o.id), o);
  } catch {
    // If offers table doesn't exist yet, we still want the page to render.
  }
}

const monthlyAggMap = new Map<string, { count: number; rewardSum: number }>();
for (const cv of monthlyConversions) {
  if (cv.offer_id == null) continue;
  const key = String(cv.offer_id);
  const cur = monthlyAggMap.get(key) ?? { count: 0, rewardSum: 0 };
  cur.count += 1;
  const v = rewardValue(cv);
  if (v != null) cur.rewardSum += v;
  monthlyAggMap.set(key, cur);
}
const monthlyAgg = Array.from(monthlyAggMap.entries())
  .map(([offerId, v]) => ({
    offerId,
    offerName: offerNameById(offersMap, offerId),
    count: v.count,
    rewardSum: v.rewardSum,
  }))
  .sort((a, b) => b.count - a.count);
const monthlyLimitHit = monthlyConversions.length >= MONTHLY_LIMIT;

const errors: string[] = [];
if (dbEnvError) errors.push(dbEnvError);
if (clicksErr) errors.push(`clicks: ${clicksErr.message}`);
if (convErr) errors.push(`conversions: ${convErr.message}`);
if (monthlyConvErr) errors.push(`monthlyConversions: ${monthlyConvErr.message}`);
if (totalClicksErr) errors.push(`totalClicks: ${totalClicksErr.message}`);
if (totalConvErr) errors.push(`totalConversions: ${totalConvErr.message}`);
---

<Layout title="Tracker" description="Affiliate tracker admin" robots="noindex,nofollow" showHeader={false}>
  <TrackerHeader />
  <main class="mx-auto w-full max-w-5xl px-4 pb-14 pt-8">
    <div class="flex flex-wrap items-end justify-between gap-4">
      <div>
        <h1 class="text-2xl font-extrabold text-zinc-900">成果トラッカー</h1>
        <p class="mt-1 text-sm text-zinc-600">/tracker（Basic認証保護）</p>
      </div>
      <div class="text-xs text-zinc-500">更新: {new Date().toLocaleString("ja-JP")}</div>
    </div>

    {errors.length ? (
      <div class="mt-6 rounded-2xl border border-rose-200 bg-rose-50 p-4 text-sm text-rose-900">
        <div class="font-extrabold">データ取得エラー</div>
        <ul class="mt-2 list-disc pl-5">
          {errors.map((e) => (
            <li>{e}</li>
          ))}
        </ul>
      </div>
    ) : null}

    <section class="mt-6 grid gap-4 sm:grid-cols-3">
      <div class="rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
        <div class="text-xs font-extrabold text-zinc-500">総クリック数</div>
        <div class="mt-2 text-3xl font-extrabold text-zinc-900">{totalClicks ?? 0}</div>
      </div>
      <div class="rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
        <div class="text-xs font-extrabold text-zinc-500">総コンバージョン数</div>
        <div class="mt-2 text-3xl font-extrabold text-zinc-900">{totalConversions ?? 0}</div>
      </div>
      <div class="rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
        <div class="text-xs font-extrabold text-zinc-500">合計報酬額</div>
        <div class="mt-2 text-3xl font-extrabold text-zinc-900">
          {totalRewardYen == null ? "—" : yen(totalRewardYen)}
        </div>
        <div class="mt-1 text-xs text-zinc-500">※ `conversions.reward` の合計（必要なら列名を調整）</div>
      </div>
    </section>

    <section class="mt-10">
      <div class="flex flex-wrap items-end justify-between gap-3">
        <div>
          <h2 class="text-lg font-extrabold text-zinc-900">{monthLabel} のコンバージョン数（案件別）</h2>
          <p class="mt-1 text-sm text-zinc-600">当月（JST）の成果件数を案件ごとに集計します。</p>
        </div>
        <div class="text-xs text-zinc-500">
          期間: {fmtDate(monthStartIso)} 〜 {fmtDate(monthEndIso)}
        </div>
      </div>

      <div class="mt-3 grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        {monthlyAgg.map((x) => (
          <div class="rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
            <div class="text-xs font-extrabold text-zinc-500">案件</div>
            <div class="mt-1 truncate text-base font-extrabold text-zinc-900">{x.offerName}</div>
            <div class="mt-3 flex items-end justify-between gap-4">
              <div>
                <div class="text-xs font-extrabold text-zinc-500">CV</div>
                <div class="mt-1 text-3xl font-extrabold text-zinc-900">{x.count}</div>
              </div>
              <div class="text-right">
                <div class="text-xs font-extrabold text-zinc-500">報酬（合計）</div>
                <div class="mt-1 text-base font-extrabold text-zinc-900">{x.rewardSum ? yen(x.rewardSum) : "—"}</div>
              </div>
            </div>
          </div>
        ))}

        {!monthlyAgg.length ? (
          <div class="rounded-2xl border border-zinc-200 bg-white p-5 text-sm font-semibold text-zinc-500 shadow-sm sm:col-span-2 lg:col-span-3">
            当月のコンバージョンがまだありません。
          </div>
        ) : null}
      </div>

      {monthlyLimitHit ? (
        <div class="mt-3 rounded-2xl border border-[#c9d4ff] bg-[#eef3ff] p-4 text-sm text-[#2f46b6]">
          <div class="font-extrabold">注意</div>
          <p class="mt-1">
            当月データが {MONTHLY_LIMIT} 件以上あるため、集計は先頭 {MONTHLY_LIMIT} 件で打ち切っています。
            必要ならDB側の集計（SQL/RPC）に切り替えます。
          </p>
        </div>
      ) : null}
    </section>

    <section class="mt-10">
      <h2 class="text-lg font-extrabold text-zinc-900">直近のクリックログ（最新10件）</h2>
      <div class="mt-3 overflow-hidden rounded-2xl border border-zinc-200 bg-white shadow-sm">
        <div class="overflow-x-auto">
          <table class="w-full min-w-[860px] text-left text-sm">
            <thead class="bg-zinc-50 text-xs font-extrabold text-zinc-600">
              <tr>
                <th class="px-4 py-3">日時</th>
                <th class="px-4 py-3">案件</th>
                <th class="px-4 py-3">URL</th>
                <th class="px-4 py-3">Referrer</th>
                <th class="px-4 py-3">IP</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-zinc-200">
              {clicks.map((c) => (
                <tr class="align-top">
                  <td class="px-4 py-3 whitespace-nowrap">{fmtDate(c.created_at)}</td>
                  <td class="px-4 py-3 font-semibold text-zinc-900">{offerNameById(offersMap, c.offer_id)}</td>
                  <td class="px-4 py-3">
                    {c.url ? <span class="break-all text-xs text-zinc-700">{c.url}</span> : <span class="text-zinc-400">—</span>}
                  </td>
                  <td class="px-4 py-3">
                    {c.referrer ? (
                      <span class="break-all text-xs text-zinc-700">{c.referrer}</span>
                    ) : (
                      <span class="text-zinc-400">—</span>
                    )}
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap">{c.ip ?? "—"}</td>
                </tr>
              ))}
              {!clicks.length ? (
                <tr>
                  <td class="px-4 py-6 text-center text-zinc-500" colspan="5">
                    データなし
                  </td>
                </tr>
              ) : null}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="mt-10">
      <h2 class="text-lg font-extrabold text-zinc-900">成果一覧（最新10件）</h2>
      <div class="mt-3 overflow-hidden rounded-2xl border border-zinc-200 bg-white shadow-sm">
        <div class="overflow-x-auto">
          <table class="w-full min-w-[1480px] text-left text-sm">
            <thead class="bg-zinc-50 text-xs font-extrabold text-zinc-600">
              <tr>
                <th class="px-4 py-3">日時</th>
                <th class="px-4 py-3">案件</th>
                <th class="px-4 py-3">UUID</th>
                <th class="px-4 py-3">student_id</th>
                <th class="px-4 py-3">ステータス</th>
                <th class="px-4 py-3">報酬</th>
                <th class="px-4 py-3">国</th>
                <th class="px-4 py-3">IP</th>
                <th class="px-4 py-3">Origin</th>
                <th class="px-4 py-3">Referrer</th>
                <th class="px-4 py-3">UA</th>
                <th class="px-4 py-3">詳細</th>
                <th class="px-4 py-3">ID</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-zinc-200">
              {conversions.map((cv) => {
                const v = rewardValue(cv);
                const suspicious = isSuspicious(cv);
                return (
                  <tr class="align-top">
                    <td class="px-4 py-3 whitespace-nowrap">{fmtDate(cv.created_at)}</td>
                    <td class="px-4 py-3 font-semibold text-zinc-900">{offerNameById(offersMap, cv.offer_id)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-xs text-zinc-700">{cv.offer_uuid ?? "—"}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-xs text-zinc-700">
                      <span class="inline-flex items-center gap-2">
                        <span class="font-mono" title={cv.student_id ?? ""}>{maskId(cv.student_id)}</span>
                      </span>
                    </td>
                    <td class="px-4 py-3">{cv.status ?? "—"}</td>
                    <td class="px-4 py-3 whitespace-nowrap">{v == null ? "—" : yen(v)}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                      {cv.country ?? cv.cf_ipcountry ?? "—"}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-xs text-zinc-700">
                      {cv.ip ? (
                        <span title={cv.ip} class="inline-flex items-center gap-2">
                          <span class="inline-flex items-center rounded-full bg-zinc-100 px-2 py-0.5 text-[11px] font-extrabold text-zinc-700">
                            {ipLabel(cv)}
                          </span>
                          <span class="font-mono">{shortText(cv.ip, 36)}</span>
                        </span>
                      ) : (
                        "—"
                      )}
                    </td>
                    <td class="px-4 py-3 text-xs text-zinc-700">
                      <span
                        class:list={[
                          "inline-block max-w-[240px] truncate align-top",
                          suspicious ? "font-extrabold text-rose-700" : "text-zinc-700",
                        ]}
                        title={cv.origin ?? ""}
                      >
                        {cv.origin ?? "—"}
                      </span>
                      {suspicious ? (
                        <span class="ml-2 inline-flex items-center rounded-full bg-rose-50 px-2 py-0.5 text-[11px] font-extrabold text-rose-700 ring-1 ring-rose-200">
                          要確認
                        </span>
                      ) : null}
                    </td>
                    <td class="px-4 py-3 text-xs text-zinc-700">
                      {cv.referrer ? (
                        <span class="inline-block max-w-[320px] truncate align-top" title={cv.referrer}>
                          {cv.referrer}
                        </span>
                      ) : (
                        "—"
                      )}
                    </td>
                    <td class="px-4 py-3 text-xs text-zinc-700">
                      {cv.user_agent ? (
                        <span class="inline-block max-w-[360px] truncate align-top font-mono" title={cv.user_agent}>
                          {cv.user_agent}
                        </span>
                      ) : (
                        "—"
                      )}
                    </td>
                    <td class="px-4 py-3 text-xs text-zinc-700">
                      <details>
                        <summary class="cursor-pointer select-none font-extrabold text-[color:var(--brand-link)] underline decoration-[#aebcff] underline-offset-2 hover:text-[color:var(--brand-link-hover)]">
                          表示
                        </summary>
                        <div class="mt-2 space-y-2">
                          <div>
                            <div class="text-[11px] font-extrabold text-zinc-500">student_id / hash</div>
                            <div class="break-all font-mono">{cv.student_id ?? "—"}</div>
                            <div class="break-all font-mono text-zinc-500">{cv.student_id_hash ?? "—"}</div>
                          </div>
                          <div>
                            <div class="text-[11px] font-extrabold text-zinc-500">ip（full）</div>
                            <div class="break-all font-mono">{cv.ip ?? "—"}</div>
                          </div>
                          <div>
                            <div class="text-[11px] font-extrabold text-zinc-500">page_url</div>
                            <div class="break-all">{cv.page_url ?? "—"}</div>
                          </div>
                          <div>
                            <div class="text-[11px] font-extrabold text-zinc-500">cf_ray / request_id</div>
                            <div class="break-all">{cv.cf_ray ?? "—"} / {cv.request_id ?? "—"}</div>
                          </div>
                          <div>
                            <div class="text-[11px] font-extrabold text-zinc-500">headers</div>
                            <pre class="max-w-[520px] overflow-x-auto rounded-lg border border-zinc-200 bg-zinc-50 p-2 text-[11px] leading-relaxed text-zinc-800">
{cv.request_headers ? JSON.stringify(cv.request_headers, null, 2) : "—"}
                            </pre>
                          </div>
                        </div>
                      </details>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-xs text-zinc-600">{cv.id ?? "—"}</td>
                  </tr>
                );
              })}
              {!conversions.length ? (
                <tr>
                  <td class="px-4 py-6 text-center text-zinc-500" colspan="13">
                    データなし
                  </td>
                </tr>
              ) : null}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="mt-10 rounded-2xl border border-zinc-200 bg-zinc-50 p-5 text-sm text-zinc-700">
      <div class="font-extrabold text-zinc-900">環境変数（サーバー）</div>
      <ul class="mt-2 list-disc pl-5">
        <li><span class="font-semibold">DATABASE_URL</span></li>
        <li>
          （必要な場合のみ）<span class="font-semibold">PGSSLMODE</span>=require
        </li>
      </ul>
    </section>

    <section class="mt-10 rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
      <div class="flex flex-wrap items-end justify-between gap-3">
        <div>
          <h2 class="text-lg font-extrabold text-zinc-900">GTM（成果発生ページ）テンプレ</h2>
          <p class="mt-1 text-sm text-zinc-600">
            成果が発生したページ（例: <code class="font-semibold">br.glats.online</code> の完了ページ）に貼る用です。
          </p>
        </div>
        <a class="text-sm font-extrabold text-[color:var(--brand-link)] underline decoration-[#aebcff] underline-offset-2 hover:text-[color:var(--brand-link-hover)]" href="/tracker/howto">
          手順ページへ →
        </a>
      </div>

      <div class="mt-4 overflow-hidden rounded-xl border border-zinc-200 bg-zinc-50">
        <pre class="overflow-x-auto p-4 text-xs leading-relaxed text-zinc-800"><code>{`<script>
(function () {
  function getParam(name) {
    try {
      var qs = location && location.search ? location.search : "";
      if (!qs) return null;
      var pairs = qs.replace(/^\?/, "").split("&");
      for (var i = 0; i < pairs.length; i++) {
        var p = pairs[i].split("=");
        var k = decodeURIComponent((p[0] || "").replace(/\+/g, " "));
        if (k === name) return decodeURIComponent(((p[1] || "") + "").replace(/\+/g, " "));
      }
    } catch (e) {}
    return null;
  }

  var payload = {
    offer_id: "kimini",
    offer_uuid: "YOUR_UUID_HERE", // 任意: 各サービスのUUIDなど
    student_id: getParam("student_id"), // 任意: ?student_id=... を受け取る
    status: "approved",
    reward: 1500,
    page_url: location && location.href ? String(location.href) : null
  };
  var url = "https://eigoonline.com/api/track/conversion";
  var body = JSON.stringify(payload);

  try {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", url, true);
    xhr.withCredentials = false; // これを明示
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.send(body);
  } catch (e) {}
})();
</script>`}</code></pre>
      </div>

      <div class="mt-3 text-xs text-zinc-500">
        <span class="font-semibold">ポイント:</span> <code class="font-semibold">offer_id</code> は <code class="font-semibold">offers.id</code> に存在する値にしてください（FK制約）。
      </div>
    </section>
  </main>
</Layout>

