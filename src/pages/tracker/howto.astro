---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import TrackerHeader from "../../components/TrackerHeader.astro";
---

<Layout title="成果発生までの手順" description="Tracker how-to" robots="noindex,nofollow" showHeader={false}>
  <TrackerHeader />

  <main class="mx-auto w-full max-w-5xl px-4 pb-14 pt-8">
    <div class="flex flex-wrap items-end justify-between gap-4">
      <div>
        <h1 class="text-2xl font-extrabold text-zinc-900">成果発生までの手順</h1>
        <p class="mt-1 text-sm text-zinc-600">GTMとCloudflareを使って成果（CV）をDBへ記録する手順です。</p>
      </div>
      <a class="text-sm font-extrabold text-[color:var(--brand-link)] underline decoration-[#aebcff] underline-offset-2 hover:text-[color:var(--brand-link-hover)]" href="/tracker">
        ← ダッシュボードへ
      </a>
    </div>

    <section class="mt-8 rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
      <h2 class="text-lg font-extrabold text-zinc-900">1. 環境変数（本番サーバー）</h2>
      <ul class="mt-3 list-disc space-y-1 pl-5 text-sm text-zinc-700">
        <li><span class="font-semibold">DATABASE_URL</span>（Railway Postgres）</li>
        <li>（必要な場合のみ）<span class="font-semibold">PGSSLMODE</span>=require（Public Proxy接続時）</li>
      </ul>
    </section>

    <section class="mt-6 rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
      <h2 class="text-lg font-extrabold text-zinc-900">2. DBにオファー（案件）を登録</h2>
      <p class="mt-2 text-sm text-zinc-700">
        <code class="font-semibold">conversions.offer_id</code> は <code class="font-semibold">offers.id</code> を参照します。
        先に <code class="font-semibold">offers</code> に案件IDを入れてください。
      </p>
      <div class="mt-3 overflow-hidden rounded-xl border border-zinc-200 bg-zinc-50">
        <pre class="overflow-x-auto p-4 text-xs leading-relaxed text-zinc-800"><code>{`insert into offers (id, name, title)
values ('kimini', 'Kimini英会話', 'Kimini英会話')
on conflict (id) do nothing;`}</code></pre>
      </div>
    </section>

    <section class="mt-6 rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
      <h2 class="text-lg font-extrabold text-zinc-900">3. 成果発生ページにGTMタグを設置</h2>
      <p class="mt-2 text-sm text-zinc-700">
        成果が発生したページ（例: <code class="font-semibold">https://br.glats.online/</code> 側の完了ページ）で、
        GTMの「カスタムHTML」で下記を発火させます。
      </p>
      <div class="mt-3 overflow-hidden rounded-xl border border-zinc-200 bg-zinc-50">
        <pre class="overflow-x-auto p-4 text-xs leading-relaxed text-zinc-800"><code>{`<script>
(function () {
  function getParam(name) {
    try {
      var qs = location && location.search ? location.search : "";
      if (!qs) return null;
      var pairs = qs.replace(/^\?/, "").split("&");
      for (var i = 0; i < pairs.length; i++) {
        var p = pairs[i].split("=");
        var k = decodeURIComponent((p[0] || "").replace(/\+/g, " "));
        if (k === name) return decodeURIComponent(((p[1] || "") + "").replace(/\+/g, " "));
      }
    } catch (e) {}
    return null;
  }

  var payload = {
    offer_id: "kimini",
    offer_uuid: "YOUR_UUID_HERE", // 任意: 各サービスのUUIDなど
    student_id: getParam("student_id"), // 任意: ?student_id=... を受け取る
    status: "approved",
    reward: 1500,
    page_url: location && location.href ? String(location.href) : null
  };
  var url = "https://eigoonline.com/api/track/conversion";
  var body = JSON.stringify(payload);

  try {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", url, true);
    xhr.withCredentials = false; // CORS回避のため明示
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.send(body);
  } catch (e) {}
})();
</script>`}</code></pre>
      </div>
      <ul class="mt-3 list-disc space-y-1 pl-5 text-sm text-zinc-700">
        <li><span class="font-semibold">offer_id</span> を案件IDに変更</li>
        <li><span class="font-semibold">offer_uuid</span> は任意（各サービスのUUIDなど）</li>
        <li><span class="font-semibold">student_id</span> は任意（先方から <code class="font-semibold">?student_id=</code> で渡してもらう）</li>
        <li><span class="font-semibold">reward</span> は任意（円）</li>
      </ul>
    </section>

    <section class="mt-6 rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
      <h2 class="text-lg font-extrabold text-zinc-900">4. Cloudflare（eigoonline.com）でWAFの除外</h2>
      <p class="mt-2 text-sm text-zinc-700">
        <code class="font-semibold">/api/track/conversion</code> へのPOSTが403になる場合、Cloudflare WAFで
        当該パスを <span class="font-semibold">Skip（Managed rules / Super Bot Fight）</span> してください。
      </p>
      <div class="mt-3 text-sm text-zinc-700">
        例: <code class="font-semibold">URI Path starts with /api/track/</code> + <code class="font-semibold">Method = POST</code>
      </div>
    </section>

    <section class="mt-6 rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
      <h2 class="text-lg font-extrabold text-zinc-900">5. 動作確認</h2>
      <p class="mt-2 text-sm text-zinc-700">手元からAPIを叩いて、200が返ることを確認できます。</p>
      <div class="mt-3 overflow-hidden rounded-xl border border-zinc-200 bg-zinc-50">
        <pre class="overflow-x-auto p-4 text-xs leading-relaxed text-zinc-800"><code>{`curl -i -X POST "https://eigoonline.com/api/track/conversion" \\
  -H "Origin: https://br.glats.online" \\
  -H "Content-Type: application/json" \\
  --data '{"offer_id":"kimini","status":"approved","reward":1500}'`}</code></pre>
      </div>
      <p class="mt-3 text-sm text-zinc-700">
        反映後、<a class="font-extrabold text-[color:var(--brand-link)] underline decoration-[#aebcff] underline-offset-2 hover:text-[color:var(--brand-link-hover)]" href="/tracker">/tracker</a>
        の「成果一覧」に表示されます。
      </p>
    </section>
  </main>
</Layout>

