---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import TrackerHeader from "../../components/TrackerHeader.astro";
---

<Layout title="成果発生までの手順" description="Tracker how-to" robots="noindex,nofollow" showHeader={false}>
  <TrackerHeader />

  <main class="mx-auto w-full max-w-5xl px-4 pb-14 pt-8">
    <div class="flex flex-wrap items-end justify-between gap-4">
      <div>
        <h1 class="text-2xl font-extrabold text-zinc-900">成果発生までの手順</h1>
        <p class="mt-1 text-sm text-zinc-600">GTMとCloudflareを使って成果（CV）をDBへ記録する手順です。</p>
      </div>
      <a class="text-sm font-extrabold text-[color:var(--brand-link)] underline decoration-[#aebcff] underline-offset-2 hover:text-[color:var(--brand-link-hover)]" href="/tracker">
        ← ダッシュボードへ
      </a>
    </div>

    <section class="mt-8 rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
      <h2 class="text-lg font-extrabold text-zinc-900">1. 環境変数（本番サーバー）</h2>
      <ul class="mt-3 list-disc space-y-1 pl-5 text-sm text-zinc-700">
        <li><span class="font-semibold">DATABASE_URL</span>（Railway Postgres）</li>
        <li>（必要な場合のみ）<span class="font-semibold">PGSSLMODE</span>=require（Public Proxy接続時）</li>
      </ul>
    </section>

    <section class="mt-6 rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
      <h2 class="text-lg font-extrabold text-zinc-900">2. DBにオファー（案件）を登録</h2>
      <p class="mt-2 text-sm text-zinc-700">
        <code class="font-semibold">conversions.offer_id</code> は <code class="font-semibold">offers.id</code> を参照します。
        先に <code class="font-semibold">offers</code> に案件IDを入れてください。
      </p>
      <div class="mt-3 overflow-hidden rounded-xl border border-zinc-200 bg-zinc-50">
        <pre class="overflow-x-auto p-4 text-xs leading-relaxed text-zinc-800"><code>{`insert into offers (id, name, title)
values ('kimini', 'Kimini英会話', 'Kimini英会話')
on conflict (id) do nothing;`}</code></pre>
      </div>
    </section>

    <section class="mt-6 rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
      <h2 class="text-lg font-extrabold text-zinc-900">3. GTMタグを設置（click_id必須）</h2>
      <p class="mt-2 text-sm text-zinc-700">
        このトラッキングは <span class="font-semibold">eigoonline経由のクリック証跡（click_id）</span> がある成果のみをカウントします。
        そのためGTMは <span class="font-semibold">2つ</span> 設置します。
      </p>

      <div class="mt-4 text-sm font-extrabold text-zinc-900">3-1. 先方サイトの全ページで click_id を保存（常時発火）</div>
      <p class="mt-2 text-sm text-zinc-700">
        先方サイト（例: <code class="font-semibold">br.glats.online</code>）の全ページで、URLの
        <code class="font-semibold">?click_id=...</code> を <code class="font-semibold">localStorage + cookie</code> に保存します（<span class="font-semibold">14日間</span>保持）。
      </p>
      <div class="mt-3 overflow-hidden rounded-xl border border-zinc-200 bg-zinc-50">
        <pre class="overflow-x-auto p-4 text-xs leading-relaxed text-zinc-800"><code>{`<script>
(function () {
  var TTL_DAYS = 14;
  function getParam(name) {
    try {
      var qs = location && location.search ? location.search : "";
      if (!qs) return null;
      var pairs = qs.replace(/^\\?/, "").split("&");
      for (var i = 0; i < pairs.length; i++) {
        var p = pairs[i].split("=");
        var k = decodeURIComponent((p[0] || "").replace(/\\+/g, " "));
        if (k === name) return decodeURIComponent(((p[1] || "") + "").replace(/\\+/g, " "));
      }
    } catch (e) {}
    return null;
  }

  var offerId = "kimini";
  var clickId = getParam("click_id");
  if (!clickId) return;
  try {
    var now = new Date().getTime();
    localStorage.setItem("eo_click_id:" + offerId, clickId);
    localStorage.setItem("eo_click_ts:" + offerId, String(now));
  } catch (e) {}

  // Also persist as cookie (fallback when localStorage is unavailable)
  try {
    var d = new Date();
    d.setTime(d.getTime() + TTL_DAYS * 24 * 60 * 60 * 1000);
    document.cookie =
      "eo_click_id_" +
      offerId +
      "=" +
      encodeURIComponent(clickId) +
      "; path=/; expires=" +
      d.toUTCString() +
      "; SameSite=Lax";
  } catch (e) {}
})();
</script>`}</code></pre>
      </div>

      <div class="mt-5 text-sm font-extrabold text-zinc-900">3-2. 成果発生ページで CV を送信（完了ページのみ発火）</div>
      <p class="mt-2 text-sm text-zinc-700">
        成果が発生したページ（完了ページ）で、保存済みの <code class="font-semibold">click_id</code> を付けて送信します。
        <code class="font-semibold">click_id</code> が取れない場合は送信しません。
      </p>
      <div class="mt-3 overflow-hidden rounded-xl border border-zinc-200 bg-zinc-50">
        <pre class="overflow-x-auto p-4 text-xs leading-relaxed text-zinc-800"><code>{`<script>
(function () {
  var TTL_DAYS = 14;
  function getParam(name) {
    try {
      var qs = location && location.search ? location.search : "";
      if (!qs) return null;
      var pairs = qs.replace(/^\?/, "").split("&");
      for (var i = 0; i < pairs.length; i++) {
        var p = pairs[i].split("=");
        var k = decodeURIComponent((p[0] || "").replace(/\+/g, " "));
        if (k === name) return decodeURIComponent(((p[1] || "") + "").replace(/\+/g, " "));
      }
    } catch (e) {}
    return null;
  }

  function getCookie(name) {
    try {
      var prefix = name + "=";
      var parts = (document.cookie || "").split("; ");
      for (var i = 0; i < parts.length; i++) {
        if (parts[i].indexOf(prefix) === 0) return decodeURIComponent(parts[i].slice(prefix.length));
      }
    } catch (e) {}
    return null;
  }

  function readStoredClickId(offerId) {
    var now = new Date().getTime();
    try {
      var ts = Number(localStorage.getItem("eo_click_ts:" + offerId) || "0");
      var id = localStorage.getItem("eo_click_id:" + offerId);
      if (id && ts && now - ts <= TTL_DAYS * 24 * 60 * 60 * 1000) return id;
    } catch (e) {}
    // cookie fallback (no timestamp; assume within cookie lifetime)
    return getCookie("eo_click_id_" + offerId);
  }

  function genEventId() {
    // UUIDv4-like (best-effort). Uses crypto.getRandomValues when available.
    try {
      var c = (window && (window.crypto || window.msCrypto)) || null;
      if (c && c.getRandomValues) {
        var b = new Uint8Array(16);
        c.getRandomValues(b);
        b[6] = (b[6] & 0x0f) | 0x40; // version 4
        b[8] = (b[8] & 0x3f) | 0x80; // variant
        var hex = [];
        for (var i = 0; i < b.length; i++) hex.push((b[i] + 256).toString(16).slice(1));
        return (
          hex.slice(0, 4).join("") +
          "-" +
          hex.slice(4, 6).join("") +
          "-" +
          hex.slice(6, 8).join("") +
          "-" +
          hex.slice(8, 10).join("") +
          "-" +
          hex.slice(10, 16).join("")
        );
      }
    } catch (e) {}
    return "e-" + String(new Date().getTime()) + "-" + String(Math.random()).slice(2);
  }

  var offerId = "kimini";
  var clickId = getParam("click_id");
  if (!clickId) {
    clickId = readStoredClickId(offerId);
  }
  if (!clickId) return;

  var payload = {
    offer_id: offerId,
    click_id: clickId,
    student_id: getParam("student_id"), // 任意: ?student_id=... を受け取る
    status: "pending",
    reward: 1500,
    page_url: location && location.href ? String(location.href) : null
  };
  // Idempotency key: reuse within the same browser session to avoid double counting
  try {
    var key = "eo_cv_event_id:" + String(payload.offer_id || "") + ":" + String((location && location.pathname) || "");
    var eid = null;
    try { eid = sessionStorage.getItem(key); } catch (e) {}
    if (!eid) {
      eid = genEventId();
      try { sessionStorage.setItem(key, eid); } catch (e) {}
    }
    payload.event_id = eid;
  } catch (e) {}
  payload.client_ts_ms = new Date().getTime();
  var url = "https://eigoonline.com/api/track/conversion";
  var body = JSON.stringify(payload);

  try {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", url, true);
    xhr.withCredentials = false; // CORS回避のため明示
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.send(body);
  } catch (e) {}
})();
</script>`}</code></pre>
      </div>
      <ul class="mt-3 list-disc space-y-1 pl-5 text-sm text-zinc-700">
        <li><span class="font-semibold">offer_id</span> を案件IDに変更</li>
        <li><span class="font-semibold">click_id</span> は必須（eigoonline経由のクリック証跡）</li>
        <li><span class="font-semibold">student_id</span> は任意（先方から <code class="font-semibold">?student_id=</code> で渡してもらう）</li>
        <li><span class="font-semibold">reward</span> は任意（円）</li>
      </ul>
    </section>

    <section class="mt-6 rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
      <h2 class="text-lg font-extrabold text-zinc-900">4. Cloudflare（eigoonline.com）でWAFの除外</h2>
      <p class="mt-2 text-sm text-zinc-700">
        <code class="font-semibold">/api/track/conversion</code> へのPOSTが403になる場合、Cloudflare WAFで
        当該パスを <span class="font-semibold">Skip（Managed rules / Super Bot Fight）</span> してください。
      </p>
      <div class="mt-3 text-sm text-zinc-700">
        例: <code class="font-semibold">URI Path starts with /api/track/</code> + <code class="font-semibold">Method = POST</code>
      </div>
    </section>

    <section class="mt-6 rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
      <h2 class="text-lg font-extrabold text-zinc-900">5. 動作確認</h2>
      <p class="mt-2 text-sm text-zinc-700">
        <code class="font-semibold">click_id</code> が必須なので、まずDBにテスト用のクリックを作ってからAPIを叩きます。
      </p>
      <div class="mt-3 overflow-hidden rounded-xl border border-zinc-200 bg-zinc-50">
        <pre class="overflow-x-auto p-4 text-xs leading-relaxed text-zinc-800"><code>{`# 1) DBにテスト用 click_id を作成（psqlで実行）
insert into clicks (offer_id, click_id, url)
values ('kimini', 'test_click_id_001', 'https://br.glats.online/')
returning id;

# 2) CVを送信
curl -i -X POST "https://eigoonline.com/api/track/conversion" \\
  -H "Origin: https://br.glats.online" \\
  -H "Content-Type: application/json" \\
  --data '{"offer_id":"kimini","click_id":"test_click_id_001","status":"approved","reward":1500}'`}</code></pre>
      </div>
      <p class="mt-3 text-sm text-zinc-700">
        反映後、<a class="font-extrabold text-[color:var(--brand-link)] underline decoration-[#aebcff] underline-offset-2 hover:text-[color:var(--brand-link-hover)]" href="/tracker">/tracker</a>
        の「成果一覧」に表示されます。
      </p>
    </section>
  </main>
</Layout>

