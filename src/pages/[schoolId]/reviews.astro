---
export const prerender = false;

import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import StarRating from "../../components/StarRating.astro";
import { getDetailedReviewStatsFromDB, getReviewStats, type DBReviewRow } from "../../utils/reviewStats";
import { query } from "../../lib/db";

const schoolId = Astro.params.schoolId ?? "";

const schools = await getCollection("schools");
const schoolEntry = schools.find((s) => s.id === schoolId) ?? null;

if (!schoolEntry) {
  Astro.response.status = 404;
}

const school = schoolEntry?.data ?? null;

// Static (editorial) reviews from content collection
const reviewsCollection = await getCollection("reviews");
const staticReviews =
  reviewsCollection.find((r) => r.data.schoolId === schoolId)?.data.items ?? [];

type DbApprovedReviewRow = DBReviewRow & {
  id: number;
  created_at: string;
  body: string;
  age: string | null;
};

let dbApprovedReviews: DbApprovedReviewRow[] = [];
try {
  const res = await query<DbApprovedReviewRow>(
    `
    select
      id,
      created_at,
      overall_rating,
      teacher_quality,
      material_quality,
      connection_quality,
      body,
      age
    from reviews
    where status = 'approved' and school_id = $1
    order by created_at desc
    limit 200
    `,
    [schoolId],
  );
  dbApprovedReviews = res.rows ?? [];
} catch {
  // DB might be unavailable; page still works with static reviews only
}

const dbDisplayReviews = dbApprovedReviews.map((r) => ({
  age: r.age ?? "年齢非公開",
  rating: typeof r.overall_rating === "number" ? r.overall_rating : 0,
  body: r.body,
  createdAt: r.created_at,
}));

const combinedForStats = [
  ...staticReviews,
  ...dbDisplayReviews.map((r) => ({ age: r.age, rating: r.rating, body: r.body })),
];

const stats = getReviewStats(combinedForStats);
const detailed = getDetailedReviewStatsFromDB(dbApprovedReviews);

const pageTitle = school ? `${school.name}の口コミ・評判` : "口コミ・評判";
const pageDescription = school
  ? `${school.name}の口コミ・評判を一覧で確認できます。総合評価に加えて、講師の質・教材の質・通信の質の評価も参考にできます。`
  : "口コミ・評判を一覧で確認できます。";

const formatJpDate = (isoLike: string) => {
  const d = new Date(isoLike);
  if (Number.isNaN(d.getTime())) return isoLike;
  return d.toLocaleDateString("ja-JP", { year: "numeric", month: "2-digit", day: "2-digit" });
};
---

<Layout title={pageTitle} description={pageDescription}>
  <main id="top" class="mx-auto w-full max-w-6xl px-4 pb-10 pt-6">
    {!school ? (
      <section class="rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
        <h1 class="text-xl font-extrabold text-zinc-900">ページが見つかりません</h1>
        <p class="mt-3 text-sm text-zinc-700">指定されたサービスが見つかりませんでした。</p>
        <div class="mt-4">
          <a class="link-brand font-semibold underline" href="/">TOPへ戻る</a>
        </div>
      </section>
    ) : (
      <>
        <header class="rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
          <div class="flex flex-wrap items-end justify-between gap-4">
            <div>
              <h1 class="text-2xl font-extrabold tracking-tight text-zinc-900">{school.name}の口コミ・評判</h1>
              <p class="mt-2 text-sm text-zinc-600">ユーザーの体験談（承認済み）と、参考レビューをまとめて確認できます。</p>
            </div>
            <div class="rounded-2xl border border-zinc-200 bg-zinc-50 px-4 py-3">
              <div class="text-xs font-extrabold text-zinc-700">総合評価</div>
              <div class="mt-1 flex items-center gap-3">
                <StarRating value={stats.avg} size={18} />
                <div class="text-sm font-extrabold text-zinc-900">
                  {stats.avg ? `${stats.avg} / 5` : "—"}
                  <span class="ml-2 text-xs font-semibold text-zinc-500">（口コミ{stats.count}件）</span>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-5 overflow-x-auto rounded-2xl border border-zinc-200 bg-white">
            <table class="w-full table-fixed border-separate border-spacing-0" style="min-width:560px">
              <colgroup>
                <col style="width:140px" />
                <col style="width:140px" />
                <col style="width:140px" />
                <col style="width:140px" />
              </colgroup>
              <thead>
                <tr class="text-left">
                  <th class="bg-zinc-100 px-4 py-3 text-sm font-extrabold text-zinc-700">項目</th>
                  <th class="bg-zinc-100 px-4 py-3 text-sm font-extrabold text-zinc-700">評価</th>
                  <th class="bg-zinc-100 px-4 py-3 text-sm font-extrabold text-zinc-700">口コミ数</th>
                  <th class="bg-zinc-100 px-4 py-3 text-sm font-extrabold text-zinc-700">対象</th>
                </tr>
              </thead>
              <tbody class="align-top">
                <tr>
                  <th class="border-t border-zinc-200 bg-white px-4 py-3 text-sm font-extrabold text-zinc-700">講師の質</th>
                  <td class="border-t border-zinc-200 px-4 py-3 text-sm font-semibold text-zinc-900">
                    {detailed.teacherQualityAvg ? `${detailed.teacherQualityAvg} / 5` : "—"}
                  </td>
                  <td class="border-t border-zinc-200 px-4 py-3 text-sm font-semibold text-zinc-900">
                    {detailed.count ? `${detailed.count}件` : "—"}
                  </td>
                  <td class="border-t border-zinc-200 px-4 py-3 text-sm text-zinc-700">ユーザー投稿（承認済み）</td>
                </tr>
                <tr>
                  <th class="border-t border-zinc-200 bg-white px-4 py-3 text-sm font-extrabold text-zinc-700">教材の質</th>
                  <td class="border-t border-zinc-200 px-4 py-3 text-sm font-semibold text-zinc-900">
                    {detailed.materialQualityAvg ? `${detailed.materialQualityAvg} / 5` : "—"}
                  </td>
                  <td class="border-t border-zinc-200 px-4 py-3 text-sm font-semibold text-zinc-900">
                    {detailed.count ? `${detailed.count}件` : "—"}
                  </td>
                  <td class="border-t border-zinc-200 px-4 py-3 text-sm text-zinc-700">ユーザー投稿（承認済み）</td>
                </tr>
                <tr>
                  <th class="border-t border-zinc-200 bg-white px-4 py-3 text-sm font-extrabold text-zinc-700">通信の質</th>
                  <td class="border-t border-zinc-200 px-4 py-3 text-sm font-semibold text-zinc-900">
                    {detailed.connectionQualityAvg ? `${detailed.connectionQualityAvg} / 5` : "—"}
                  </td>
                  <td class="border-t border-zinc-200 px-4 py-3 text-sm font-semibold text-zinc-900">
                    {detailed.count ? `${detailed.count}件` : "—"}
                  </td>
                  <td class="border-t border-zinc-200 px-4 py-3 text-sm text-zinc-700">ユーザー投稿（承認済み）</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="mt-5 flex flex-wrap gap-2">
            <a
              class="inline-flex items-center justify-center rounded-xl bg-[color:var(--brand-link)] px-4 py-2.5 text-sm font-extrabold text-white shadow-sm hover:opacity-90 transition-opacity"
              href={`/review/submit?school_id=${encodeURIComponent(schoolId)}`}
            >
              このサービスのレビューを投稿する
            </a>
            <a class="inline-flex items-center justify-center rounded-xl border border-zinc-200 bg-white px-4 py-2.5 text-sm font-extrabold text-zinc-900 hover:bg-zinc-50" href="/">
              TOPへ戻る
            </a>
          </div>
        </header>

        <section class="mt-6 grid gap-6">
          <section class="rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
            <h2 class="text-lg font-extrabold text-zinc-900">ユーザー投稿の口コミ（承認済み）</h2>
            {dbDisplayReviews.length ? (
              <div class="mt-4 grid gap-3">
                {dbDisplayReviews.map((r) => (
                  <article class="rounded-xl border border-zinc-200 bg-zinc-50 p-4">
                    <div class="flex flex-wrap items-center justify-between gap-3">
                      <div class="text-sm font-extrabold text-zinc-800">
                        {r.age}
                        <span class="ml-2 text-xs font-semibold text-zinc-500">{formatJpDate(r.createdAt)}</span>
                      </div>
                      <div class="flex items-center gap-2">
                        <StarRating value={r.rating} />
                        <span class="text-xs font-semibold text-zinc-500">{r.rating.toFixed(1)}</span>
                      </div>
                    </div>
                    <p class="mt-2 whitespace-pre-wrap text-sm leading-relaxed text-zinc-700">{r.body}</p>
                  </article>
                ))}
              </div>
            ) : (
              <p class="mt-3 text-sm text-zinc-600">まだ承認済みのユーザー投稿レビューがありません。</p>
            )}
          </section>

          {staticReviews.length ? (
            <section class="rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
              <h2 class="text-lg font-extrabold text-zinc-900">参考レビュー</h2>
              <p class="mt-2 text-sm text-zinc-600">過去の掲載レビュー（参考）です。</p>
              <div class="mt-4 grid gap-3">
                {staticReviews.map((r) => (
                  <article class="rounded-xl border border-zinc-200 bg-zinc-50 p-4">
                    <div class="flex flex-wrap items-center justify-between gap-3">
                      <div class="text-sm font-extrabold text-zinc-800">{r.age}</div>
                      <div class="flex items-center gap-2">
                        <StarRating value={r.rating} />
                        <span class="text-xs font-semibold text-zinc-500">{r.rating.toFixed(1)}</span>
                      </div>
                    </div>
                    <p class="mt-2 whitespace-pre-wrap text-sm leading-relaxed text-zinc-700">{r.body}</p>
                  </article>
                ))}
              </div>
            </section>
          ) : null}
        </section>
      </>
    )}
  </main>
</Layout>

