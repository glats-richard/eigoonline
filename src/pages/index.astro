---
export const prerender = true;

import { getCollection } from "astro:content";
import Layout from "../layouts/Layout.astro";
import RankingListItem from "../components/RankingListItem.astro";
import CompareTableTabs from "../components/CompareTableTabs.astro";
import PickupCard from "../components/PickupCard.astro";
import SearchBox from "../components/SearchBox.astro";
import CategoryGrid from "../components/CategoryGrid.astro";
import ArticleBanners from "../components/ArticleBanners.astro";
import Sidebar from "../components/Sidebar.astro";
import SchoolDetailSection from "../components/SchoolDetailSection.astro";
import { getReviewStats } from "../utils/reviewStats";

const schools = await getCollection("schools");
const rankings = await getCollection("rankings");
const categories = await getCollection("categories");
const pickups = await getCollection("pickups");
const articles = await getCollection("articles");
const banners = await getCollection("banners");
const reviews = await getCollection("reviews");

const schoolsById = new Map(schools.map((s) => [s.id, s.data] as const));
const rankingByCategory = new Map(rankings.map((r) => [r.data.category, r.data] as const));

const overall = rankingByCategory.get("overall");
const daily = rankingByCategory.get("daily");
const business = rankingByCategory.get("business");

const resolveItems = (items: string[] | undefined) =>
	(items ?? []).map((id) => ({ id, data: schoolsById.get(id) })).filter((x): x is { id: string; data: NonNullable<typeof x.data> } => Boolean(x.data));

const overallItems = resolveItems(overall?.items);
const dailyItems = resolveItems(daily?.items);
const businessItems = resolveItems(business?.items);

const catLevel = categories.filter((c) => c.data.group === "level").map((c) => c.data);
const catAge = categories.filter((c) => c.data.group === "age").map((c) => c.data);
const catReco = categories.filter((c) => c.data.group === "recommend").map((c) => c.data);

const pickupTop = pickups[0]?.data;
const sidebarBannersTop = banners.filter((b) => ["sidebar", "sidebar_top"].includes(b.data.placement)).map((b) => b.data);
const sidebarBannersMid = banners.filter((b) => b.data.placement === "sidebar_mid").map((b) => b.data);
const sidebarBannersBottom = banners.filter((b) => b.data.placement === "sidebar_bottom").map((b) => b.data);

const reviewsBySchoolId = new Map(reviews.map((r) => [r.data.schoolId, r.data.items] as const));
const reviewStatsBySchoolId = new Map(reviews.map((r) => [r.data.schoolId, getReviewStats(r.data.items)] as const));

const applyReviewRating = <T extends { id: string; data: Record<string, unknown> }>(xs: T[]) =>
	xs.map((x) => {
		const stats = reviewStatsBySchoolId.get(x.id);
		// Only show a rating when it's backed by reviews.
		const rating = stats?.count ? stats.avg : null;
		return { ...x, data: { ...x.data, rating } };
	});

const overallItemsRated = applyReviewRating(overallItems);
const dailyItemsRated = applyReviewRating(dailyItems);
const businessItemsRated = applyReviewRating(businessItems);

const base = Astro.site ? new URL(Astro.site) : new URL(Astro.url.origin);
const pageUrl = new URL(Astro.url.pathname, base).toString();
const itemListJsonLd = {
	"@context": "https://schema.org",
	"@type": "ItemList",
	name: "オンライン英会話 おすすめランキング（総合）",
	itemListOrder: "http://schema.org/ItemListOrderAscending",
	url: pageUrl,
	numberOfItems: Math.min(8, overallItems.length),
	itemListElement: overallItems.slice(0, 8).map((x, idx) => ({
		"@type": "ListItem",
		position: idx + 1,
		name: x.data.name,
		url: new URL(`#school-${x.id}`, pageUrl).toString(),
	})),
};

const faqJsonLd = {
	"@context": "https://schema.org",
	"@type": "FAQPage",
	mainEntity: [
		{
			"@type": "Question",
			name: "オンライン英会話のおすすめはどう選べばいい？",
			acceptedAnswer: {
				"@type": "Answer",
				text:
					"目的（総合/日常/ビジネス）を決めた上で、料金・無料体験の有無・受講可能時間・講師の質を比較すると選びやすいです。本ページでは目的別タブで比較できます。",
			},
		},
		{
			"@type": "Question",
			name: "無料体験は受けた方がいい？",
			acceptedAnswer: {
				"@type": "Answer",
				text: "おすすめです。講師との相性や教材の使いやすさ、予約の取りやすさを実際に確認できます。",
			},
		},
		{
			"@type": "Question",
			name: "初心者でも続けやすいオンライン英会話の特徴は？",
			acceptedAnswer: {
				"@type": "Answer",
				text: "日本語サポート・初心者向け教材・短時間レッスン・受講できる時間帯が広いサービスは継続しやすい傾向があります。",
			},
		},
	],
};
---
<Layout
	title="オンライン英会話 おすすめ比較・ランキング（総合・日常・ビジネス）"
	description="オンライン英会話のおすすめを「総合 / 日常英会話 / ビジネス英会話」の目的別に比較。料金の目安・特徴・無料体験・公式サイト導線をまとめてチェックできます。"
	ogImage="/eigoonline_logo.png"
	headerOverlay
>
	<Fragment slot="head">
		<link rel="preload" as="image" href="/fv_1.webp" fetchpriority="high" />
	</Fragment>
	<script type="application/ld+json" set:html={JSON.stringify(itemListJsonLd)}></script>
	<script type="application/ld+json" set:html={JSON.stringify(faqJsonLd)}></script>

	<main id="top" class="mx-auto w-full max-w-6xl px-4 pb-8 pt-4 sm:pb-10 sm:pt-6">
		<!-- Hero: 4 columns (FV 3 cols + sidebar 1 col) -->
		<section class="pt-10 sm:pt-12">
			<div class="grid gap-6 lg:grid-cols-4 lg:items-start">
				<div class="relative overflow-hidden rounded-2xl border border-zinc-200 bg-white shadow-sm lg:col-span-3">
					<picture>
						<source srcset="/fv_1.webp" type="image/webp" />
						<img
							src="/fv_1.jpg"
							alt="オンライン英会話 おすすめランキング"
							loading="eager"
							decoding="async"
							fetchpriority="high"
							class="block h-auto w-full object-cover"
						/>
					</picture>

					<!-- Service logos (top picks) -->
					<div class="pointer-events-none absolute inset-x-0 bottom-0 bg-white/65 backdrop-blur">
						<div class="pointer-events-auto flex items-center gap-4 overflow-x-auto px-4 py-2 [-webkit-overflow-scrolling:touch]">
							{overallItemsRated.slice(0, 8).map((x) => (
								x.data.logoUrl ? (
									<a
										href={`#school-${x.id}`}
										class="shrink-0 rounded-lg bg-white/70 px-3 py-2 ring-1 ring-black/5 hover:bg-white"
										aria-label={`${x.data.name} の詳細へ`}
									>
										<img
											src={x.data.logoUrl}
											alt={`${x.data.name} ロゴ`}
											loading="lazy"
											decoding="async"
											class="h-8 w-auto max-w-[140px] object-contain"
										/>
									</a>
								) : null
							))}
						</div>
					</div>
				</div>

				<div class="hidden lg:block lg:col-span-1">
					<Sidebar
						bannersTop={sidebarBannersTop}
						bannersMid={[]}
						bannersBottom={[]}
						popular={[]}
						categories={[
							...catReco.map((c) => ({ title: c.title, href: c.href })),
							...catLevel.map((c) => ({ title: c.title, href: c.href })),
						]}
					/>
				</div>
			</div>
		</section>

		<div class="mt-4 grid gap-6 sm:mt-6 lg:grid-cols-4 lg:items-start">
			<div class="min-w-0 space-y-6 lg:col-span-3">
				<section id="ranking" class="w-full min-w-0">
					<div class="mb-4">
						<h2 class="text-xl font-extrabold text-zinc-900">目的別ランキング</h2>
						<p class="mt-1 text-sm text-zinc-600">タブを切り替えて、目的に合うスクールを比較できます。</p>
					</div>

					<div class="rounded-2xl border border-zinc-200 bg-white p-0 shadow-sm overflow-hidden">
						<input class="peer/overall sr-only" type="radio" name="ranktab" id="tab-overall" checked />
						<input class="peer/daily sr-only" type="radio" name="ranktab" id="tab-daily" />
						<input class="peer/business sr-only" type="radio" name="ranktab" id="tab-business" />

						<div class="rounded-t-2xl bg-[#ecf9fe] px-3 pt-3 sm:px-4
							peer-checked/overall:[&_.tab-overall]:relative peer-checked/overall:[&_.tab-overall]:z-10 peer-checked/overall:[&_.tab-overall]:h-full peer-checked/overall:[&_.tab-overall]:bg-[linear-gradient(to_bottom,#EE6B95,#F49BB5_55%,#fff_100%)] peer-checked/overall:[&_.tab-overall]:text-white peer-checked/overall:[&_.tab-overall]:shadow-[0_2px_8px_rgba(0,0,0,0.18)]
							peer-checked/daily:[&_.tab-daily]:relative peer-checked/daily:[&_.tab-daily]:z-10 peer-checked/daily:[&_.tab-daily]:h-full peer-checked/daily:[&_.tab-daily]:bg-[linear-gradient(to_bottom,#EE6B95,#F49BB5_55%,#fff_100%)] peer-checked/daily:[&_.tab-daily]:text-white peer-checked/daily:[&_.tab-daily]:shadow-[0_2px_8px_rgba(0,0,0,0.18)]
							peer-checked/business:[&_.tab-business]:relative peer-checked/business:[&_.tab-business]:z-10 peer-checked/business:[&_.tab-business]:h-full peer-checked/business:[&_.tab-business]:bg-[linear-gradient(to_bottom,#EE6B95,#F49BB5_55%,#fff_100%)] peer-checked/business:[&_.tab-business]:text-white peer-checked/business:[&_.tab-business]:shadow-[0_2px_8px_rgba(0,0,0,0.18)]
						">
							<div class="grid h-[50px] w-full grid-cols-3 items-end gap-0.5 text-[#595959] sm:gap-[10px]">
							<label
								for="tab-overall"
								class="tab tab-overall w-full cursor-pointer rounded-t-xl bg-[#d1d1d1] px-1.5 py-1 text-center text-[11px] font-extrabold leading-tight transition hover:bg-zinc-200 sm:px-3 sm:text-sm"
							>
								<div class="grid h-[80%] place-items-center">
									<span class="grid grid-rows-2 leading-tight">
										<span class="block">{overall?.title ?? "総合"}</span>
										<span class="block select-none text-transparent" aria-hidden="true">英会話</span>
									</span>
								</div>
							</label>
							<label
								for="tab-daily"
								class="tab tab-daily w-full cursor-pointer rounded-t-xl bg-[#d1d1d1] px-1.5 py-1 text-center text-[11px] font-extrabold leading-tight transition hover:bg-zinc-200 sm:px-3 sm:text-sm"
							>
								<div class="grid h-[80%] place-items-center">
									<span class="grid grid-rows-2 leading-tight">
										<span class="block">日常</span>
										<span class="block">英会話</span>
									</span>
								</div>
							</label>
							<label
								for="tab-business"
								class="tab tab-business w-full cursor-pointer rounded-t-xl bg-[#d1d1d1] px-1.5 py-1 text-center text-[11px] font-extrabold leading-tight transition hover:bg-zinc-200 sm:px-3 sm:text-sm"
							>
								<div class="grid h-[80%] place-items-center">
									<span class="grid grid-rows-2 leading-tight">
										<span class="block">ビジネス</span>
										<span class="block">英会話</span>
									</span>
								</div>
							</label>
							</div>
						</div>

						<section class="px-3 pb-3 pt-4 sm:px-4 sm:pb-4 hidden peer-checked/overall:block">
							<p class="mb-3 text-sm text-zinc-600">{overall?.description}</p>
							<div class="grid gap-4">
								{overallItemsRated.slice(0, 3).map((x, idx) => (
										<RankingListItem item={x.data} rank={idx + 1} reviews={reviewsBySchoolId.get(x.id) ?? []} />
								))}
							</div>
						</section>

						<section class="px-3 pb-3 pt-4 sm:px-4 sm:pb-4 hidden peer-checked/daily:block">
							<p class="mb-3 text-sm text-zinc-600">{daily?.description}</p>
							<div class="grid gap-4">
								{dailyItemsRated.slice(0, 3).map((x, idx) => (
										<RankingListItem item={x.data} rank={idx + 1} reviews={reviewsBySchoolId.get(x.id) ?? []} />
								))}
							</div>
						</section>

						<section class="px-3 pb-3 pt-4 sm:px-4 sm:pb-4 hidden peer-checked/business:block">
							<p class="mb-3 text-sm text-zinc-600">{business?.description}</p>
							<div class="grid gap-4">
								{businessItemsRated.slice(0, 3).map((x, idx) => (
										<RankingListItem item={x.data} rank={idx + 1} reviews={reviewsBySchoolId.get(x.id) ?? []} />
								))}
							</div>
						</section>
					</div>
				</section>

				<section id="compare">
					<div class="mb-4">
						<h2 class="text-xl font-extrabold text-zinc-900">比較表</h2>
						<p class="mt-1 text-sm text-zinc-600">上位スクールを項目ごとに横並びで比較できます（横スクロール可）。</p>
					</div>

					{overall && daily && business ? (
						<CompareTableTabs
							overall={{ title: overall.title, items: overallItemsRated }}
							daily={{ title: daily.title, items: dailyItemsRated }}
							business={{ title: business.title, items: businessItemsRated }}
							columns={4}
						/>
					) : null}
				</section>

				<section id="pickup">
					{pickupTop ? (
						<PickupCard title={pickupTop.title} label={pickupTop.label} body={pickupTop.body} ctaHref={pickupTop.ctaHref} ctaLabel={pickupTop.ctaLabel} />
					) : null}
				</section>

				<section id="details" class="space-y-6">
					<div class="rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
						<h2 class="text-xl font-extrabold text-zinc-900">ランキング詳細</h2>
						<p class="mt-1 text-sm text-zinc-600">PICKUPの下に、各社の詳細を順に掲載しています。</p>
					</div>

					{overallItemsRated.map((x, idx) => (
						<div id={`school-${x.id}`} class="scroll-mt-24">
							<SchoolDetailSection rank={idx + 1} item={x.data} reviews={reviewsBySchoolId.get(x.id) ?? []} />
						</div>
					))}
				</section>

				<section class="rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm sm:p-6">
					<h2 class="text-xl font-extrabold text-zinc-900">よくある質問（オンライン英会話 おすすめ）</h2>
					<div class="mt-4 space-y-3">
						<details class="rounded-xl border border-zinc-200 bg-zinc-50 p-4">
							<summary class="cursor-pointer text-sm font-extrabold text-zinc-900">オンライン英会話のおすすめはどう選べばいい？</summary>
							<p class="mt-2 text-sm text-zinc-700">
								目的（総合/日常/ビジネス）を決めた上で、料金・無料体験の有無・受講可能時間・講師の質を比較すると選びやすいです。本ページでは目的別タブで比較できます。
							</p>
						</details>
						<details class="rounded-xl border border-zinc-200 bg-zinc-50 p-4">
							<summary class="cursor-pointer text-sm font-extrabold text-zinc-900">無料体験は受けた方がいい？</summary>
							<p class="mt-2 text-sm text-zinc-700">
								おすすめです。講師との相性や教材の使いやすさ、予約の取りやすさを実際に確認できます。
							</p>
						</details>
						<details class="rounded-xl border border-zinc-200 bg-zinc-50 p-4">
							<summary class="cursor-pointer text-sm font-extrabold text-zinc-900">初心者でも続けやすいオンライン英会話の特徴は？</summary>
							<p class="mt-2 text-sm text-zinc-700">
								日本語サポート・初心者向け教材・短時間レッスン・受講できる時間帯が広いサービスは継続しやすい傾向があります。
							</p>
						</details>
					</div>
				</section>

				<section id="search">
					<SearchBox />
				</section>

				<section id="categories" class="grid gap-4 sm:grid-cols-2">
					<CategoryGrid heading="レベル別ランキング" items={catLevel} />
					<CategoryGrid heading="年代別ランキング" items={catAge} />
					<CategoryGrid heading="おすすめランキング" items={catReco} />
				</section>

				<section id="articles">
					<ArticleBanners heading="オンライン英会話ガイド・コラム" items={articles.map((a) => a.data)} />
				</section>
			</div>

			<div class="hidden lg:block lg:col-span-1">
				<Sidebar
					bannersTop={[]}
					bannersMid={sidebarBannersMid}
					bannersBottom={sidebarBannersBottom}
					popular={overallItems.slice(0, 8).map((x) => ({ name: x.data.name, officialUrl: x.data.officialUrl, logoUrl: x.data.logoUrl }))}
					categories={[]}
				/>
			</div>
		</div>

		<!-- Mobile: show hero sidebar blocks after main content -->
		<section class="mt-10 lg:hidden">
			<Sidebar
				bannersTop={sidebarBannersTop}
				bannersMid={[]}
				bannersBottom={[]}
				popular={[]}
				categories={[
					...catReco.map((c) => ({ title: c.title, href: c.href })),
					...catLevel.map((c) => ({ title: c.title, href: c.href })),
				]}
			/>
		</section>

	</main>
</Layout>
