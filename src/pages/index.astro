---
export const prerender = false;

import { getCollection } from "astro:content";
import Layout from "../layouts/Layout.astro";
import RankingListItem from "../components/RankingListItem.astro";
import CompareTableTabs from "../components/CompareTableTabs.astro";
import PickupCard from "../components/PickupCard.astro";
import Sidebar from "../components/Sidebar.astro";
import SchoolDetailSection from "../components/SchoolDetailSection.astro";
import { getReviewStats, getDetailedReviewStatsFromDB, type DBReviewRow } from "../utils/reviewStats";
import { query } from "../lib/db";
import { getSchoolsMerged } from "../lib/schools";

const schools = await getSchoolsMerged();
const rankings = await getCollection("rankings");
const categories = await getCollection("categories");
const pickups = await getCollection("pickups");
const banners = await getCollection("banners");
const reviews = await getCollection("reviews");

const schoolsById = new Map(schools.map((s) => [s.id, s.data] as const));
const rankingByCategory = new Map(rankings.map((r) => [r.data.category, r.data] as const));

const overall = rankingByCategory.get("overall");
const exam = rankingByCategory.get("exam");
const daily = rankingByCategory.get("daily");
const business = rankingByCategory.get("business");

const resolveItems = (items: string[] | undefined) =>
	(items ?? []).map((id) => ({ id, data: schoolsById.get(id) })).filter((x): x is { id: string; data: NonNullable<typeof x.data> } => Boolean(x.data));

const overallItems = resolveItems(overall?.items);
const examItems = resolveItems(exam?.items);
const dailyItems = resolveItems(daily?.items);
const businessItems = resolveItems(business?.items);

const catLevel = categories.filter((c) => c.data.group === "level").map((c) => c.data);
const catAge = categories.filter((c) => c.data.group === "age").map((c) => c.data);
const catReco = categories.filter((c) => c.data.group === "recommend").map((c) => c.data);

const pickupTop = pickups[0]?.data;
const sidebarBannersTop = banners.filter((b) => ["sidebar", "sidebar_top"].includes(b.data.placement)).map((b) => b.data);
const sidebarBannersMid = banners.filter((b) => b.data.placement === "sidebar_mid").map((b) => b.data);
const sidebarBannersBottom = banners.filter((b) => b.data.placement === "sidebar_bottom").map((b) => b.data);

// Start with static reviews
const staticReviewsBySchoolId = new Map(reviews.map((r) => [r.data.schoolId, r.data.items] as const));

// Fetch approved reviews from database
type DbReviewRow = DBReviewRow & {
  school_id: string;
  body?: string | null;
  birth_year?: number | null;
  birth_month?: number | null;
  age?: string | null; // legacy
  featured_rank?: number | null;
  created_at?: string | null;
};
let dbReviewsBySchoolId = new Map<string, DbReviewRow[]>();
try {
  const dbReviewsWithSchoolId = await query<DbReviewRow>(
    "select school_id, created_at, featured_rank, overall_rating, teacher_quality, material_quality, connection_quality, price_rating, satisfaction_rating, body, birth_year, birth_month, age from reviews where status = 'approved'",
  );
  for (const r of dbReviewsWithSchoolId.rows ?? []) {
    const existing = dbReviewsBySchoolId.get(r.school_id) ?? [];
    existing.push({
      school_id: r.school_id,
      created_at: r.created_at ?? null,
      featured_rank: (r as any).featured_rank ?? null,
      overall_rating: r.overall_rating,
      teacher_quality: r.teacher_quality,
      material_quality: r.material_quality,
      connection_quality: r.connection_quality,
      price_rating: (r as any).price_rating ?? null,
      satisfaction_rating: (r as any).satisfaction_rating ?? null,
      body: r.body,
      birth_year: (r as any).birth_year ?? null,
      birth_month: (r as any).birth_month ?? null,
      age: (r as any).age ?? null,
    });
    dbReviewsBySchoolId.set(r.school_id, existing);
  }
} catch {
  // If DB query fails (e.g., table doesn't exist yet), continue with static reviews only
}

// Display reviews for components:
// - Prefer latest approved user-submitted reviews per school (max 3)
// - Fall back to static reviews if no approved DB reviews exist
const reviewsBySchoolId = new Map<string, { age: string; rating: number; body: string }[]>();
for (const [schoolId, staticItems] of staticReviewsBySchoolId) {
  reviewsBySchoolId.set(schoolId, [...staticItems]);
}
for (const [schoolId, dbReviews] of dbReviewsBySchoolId) {
  const valid = dbReviews
    .filter((r) => r.overall_rating !== null && Number.isFinite(r.overall_rating) && r.body)
    .slice()
    .sort((a, b) => {
      const at = a.created_at ? new Date(a.created_at).getTime() : 0;
      const bt = b.created_at ? new Date(b.created_at).getTime() : 0;
      return bt - at;
    });

  if (!valid.length) continue;

  const latest3 = valid.slice(0, 3).map((r) => ({
    age:
      typeof r.birth_year === "number" && typeof r.birth_month === "number"
        ? `${r.birth_year}年${r.birth_month}月`
        : r.age || "ユーザー",
    rating: r.overall_rating!,
    body: r.body!,
  }));
  reviewsBySchoolId.set(schoolId, latest3);
}

// Calculate review stats from ALL reviews (static + ALL approved DB), for rating display.
const reviewStatsBySchoolId = new Map<string, { count: number; avg: number | null }>();
for (const [schoolId] of schoolsById) {
  const staticItems = staticReviewsBySchoolId.get(schoolId) ?? [];
  const dbItems = dbReviewsBySchoolId.get(schoolId) ?? [];
  const dbForStats = dbItems
    .filter((r) => r.overall_rating !== null && Number.isFinite(r.overall_rating))
    .map((r) => ({ rating: r.overall_rating! }));
  const stats = getReviewStats([
    ...staticItems,
    ...dbForStats,
  ]);
  reviewStatsBySchoolId.set(schoolId, stats);
}

// Detailed stats for compare table (teacher, material, connection quality)
const detailedReviewStatsBySchoolId = new Map<string, ReturnType<typeof getDetailedReviewStatsFromDB>>();
for (const [schoolId] of schoolsById) {
  const dbReviews = dbReviewsBySchoolId.get(schoolId) ?? [];
  const detailedStats = getDetailedReviewStatsFromDB(dbReviews);
  if (detailedStats.count > 0) {
    detailedReviewStatsBySchoolId.set(schoolId, detailedStats);
  }
}

const applyReviewRating = <T extends { id: string; data: Record<string, unknown> }>(xs: T[]) =>
	xs.map((x) => {
		const stats = reviewStatsBySchoolId.get(x.id);
		// Only show a rating when it's backed by reviews.
		const rating = stats?.count ? stats.avg : null;
		// Merge DB review stats for detailed ratings (teacher, material, connection)
		const detailedStats = detailedReviewStatsBySchoolId.get(x.id);
		const teacherQuality = detailedStats?.teacherQualityAvg ?? x.data.teacherQuality ?? null;
		const materialQuality = detailedStats?.materialQualityAvg ?? x.data.materialQuality ?? null;
		const connectionQuality = detailedStats?.connectionQualityAvg ?? x.data.connectionQuality ?? null;
		const priceRating = detailedStats?.priceRatingAvg ?? (x.data as any).priceRating ?? null;
		const satisfactionRating = detailedStats?.satisfactionRatingAvg ?? (x.data as any).satisfactionRating ?? null;
		return { ...x, data: { ...x.data, rating, teacherQuality, materialQuality, connectionQuality, priceRating, satisfactionRating } };
	});

const overallItemsRated = applyReviewRating(overallItems);
const examItemsRated = applyReviewRating(examItems);
const dailyItemsRated = applyReviewRating(dailyItems);
const businessItemsRated = applyReviewRating(businessItems);

const base = Astro.site ? new URL(Astro.site) : new URL(Astro.url.origin);
const pageUrl = new URL(Astro.url.pathname, base).toString();
const itemListJsonLd = {
	"@context": "https://schema.org",
	"@type": "ItemList",
	name: "オンライン英会話 おすすめランキング（総合）",
	itemListOrder: "http://schema.org/ItemListOrderAscending",
	url: pageUrl,
	numberOfItems: Math.min(8, overallItems.length),
	itemListElement: overallItems.slice(0, 8).map((x, idx) => ({
		"@type": "ListItem",
		position: idx + 1,
		name: x.data.name,
		url: new URL(`#school-${x.id}`, pageUrl).toString(),
	})),
};

// Generate structured data for reviews (Schema.org Review and AggregateRating)
const reviewsJsonLd: any[] = [];
for (const [schoolId, schoolData] of schoolsById) {
  const staticReviews = reviewsBySchoolId.get(schoolId) ?? [];
  const dbReviews = dbReviewsBySchoolId.get(schoolId) ?? [];
  const stats = reviewStatsBySchoolId.get(schoolId);
  
  if (stats && stats.count > 0 && stats.avg !== null) {
    // Create AggregateRating
    const aggregateRating = {
      "@type": "AggregateRating",
      ratingValue: stats.avg,
      bestRating: 5,
      worstRating: 1,
      ratingCount: stats.count,
    };

    // Create individual Review objects
    const reviewObjects: any[] = [];
    
    // Add static reviews
    for (const review of staticReviews) {
      reviewObjects.push({
        "@type": "Review",
        author: {
          "@type": "Person",
          name: review.age || "匿名",
        },
        reviewRating: {
          "@type": "Rating",
          ratingValue: review.rating,
          bestRating: 5,
          worstRating: 1,
        },
        reviewBody: review.body,
      });
    }
    
    // Add DB reviews
    for (const review of dbReviews) {
      if (review.overall_rating !== null && Number.isFinite(review.overall_rating) && review.body) {
        reviewObjects.push({
          "@type": "Review",
          author: {
            "@type": "Person",
            name: "ユーザー",
          },
          reviewRating: {
            "@type": "Rating",
            ratingValue: review.overall_rating,
            bestRating: 5,
            worstRating: 1,
          },
          reviewBody: review.body,
        });
      }
    }

    // Create Service with reviews
    const serviceUrl = new URL(`#school-${schoolId}`, pageUrl).toString();
    reviewsJsonLd.push({
      "@context": "https://schema.org",
      "@type": "Service",
      "@id": serviceUrl,
      name: schoolData.name,
      url: schoolData.officialUrl || serviceUrl,
      aggregateRating,
      review: reviewObjects.slice(0, 10), // Limit to 10 reviews for structured data
    });
  }
}

const faqJsonLd = {
	"@context": "https://schema.org",
	"@type": "FAQPage",
	mainEntity: [
		{
			"@type": "Question",
			name: "オンライン英会話のおすすめはどう選べばいい？",
			acceptedAnswer: {
				"@type": "Answer",
				text:
					"目的（総合/試験対策/日曜英会話/ビジネス英会話）を決めた上で、料金・無料体験の有無・受講可能時間・講師の質を比較すると選びやすいです。本ページでは目的別タブで比較できます。",
			},
		},
		{
			"@type": "Question",
			name: "無料体験は受けた方がいい？",
			acceptedAnswer: {
				"@type": "Answer",
				text: "おすすめです。講師との相性や教材の使いやすさ、予約の取りやすさを実際に確認できます。",
			},
		},
		{
			"@type": "Question",
			name: "初心者でも続けやすいオンライン英会話の特徴は？",
			acceptedAnswer: {
				"@type": "Answer",
				text: "日本語サポート・初心者向け教材・短時間レッスン・受講できる時間帯が広いサービスは継続しやすい傾向があります。",
			},
		},
	],
};
---
<Layout
	title="オンライン英会話 おすすめ比較・ランキング（総合・試験対策・日曜・ビジネス）"
	description="オンライン英会話のおすすめを「総合 / 試験対策 / 日曜英会話 / ビジネス英会話」の目的別に比較。料金の目安・特徴・無料体験・公式サイト導線をまとめてチェックできます。"
	ogImage="/eigoonline_logo.png"
	headerOverlay
>
	<Fragment slot="head">
		<link rel="preload" as="image" href="/fv_1.webp" fetchpriority="high" />
	</Fragment>
	<script type="application/ld+json" set:html={JSON.stringify(itemListJsonLd)}></script>
	<script type="application/ld+json" set:html={JSON.stringify(faqJsonLd)}></script>
	{reviewsJsonLd.map((review) => (
		<script type="application/ld+json" set:html={JSON.stringify(review)}></script>
	))}

	<main id="top" class="mx-auto w-full max-w-6xl px-4 pb-8 pt-4 sm:pb-10 sm:pt-6">
		<section class="pt-10 sm:pt-12">
			<div class="mt-3 grid gap-6 sm:mt-4 lg:grid-cols-3 lg:items-start">
				<div class="min-w-0 space-y-6 lg:col-span-2">
					<!-- Hero image -->
					<div class="relative overflow-hidden rounded-2xl border border-zinc-200 bg-white shadow-sm">
						<picture>
							<source srcset="/fv_1.webp" type="image/webp" />
							<img
								src="/fv_1.jpg"
								alt="オンライン英会話 おすすめランキング"
								loading="eager"
								decoding="async"
								fetchpriority="high"
								width="1024"
								height="565"
								class="block h-auto w-full object-cover"
							/>
						</picture>

						<!-- Service logos (top picks) -->
						<div class="pointer-events-none absolute inset-x-0 bottom-0 bg-white/65 backdrop-blur">
							<div class="pointer-events-auto flex items-center gap-4 overflow-x-auto px-4 py-2 [-webkit-overflow-scrolling:touch]">
								{overallItemsRated.slice(0, 8).map((x) =>
									x.data.logoUrl ? (
										<a
											href={`#school-${x.id}`}
											class="shrink-0 rounded-lg bg-white/70 px-3 py-2 ring-1 ring-black/5 hover:bg-white"
											aria-label={`${x.data.name} の詳細へ`}
										>
											<img
												src={x.data.logoUrl}
												alt={`${x.data.name} ロゴ`}
												loading="lazy"
												decoding="async"
												class="h-8 w-auto max-w-[140px] object-contain"
											/>
										</a>
									) : null,
								)}
							</div>
						</div>
					</div>

				<section id="ranking" class="w-full min-w-0">
					<div class="mb-4">
						<h2 class="text-xl font-extrabold text-zinc-900">目的別ランキング</h2>
						<p class="mt-1 text-sm text-zinc-600">タブを切り替えて、目的に合うスクールを比較できます。</p>
					</div>

					<div class="rounded-2xl border-2 border-[#F49BB5] bg-white p-0 shadow-sm overflow-hidden">
						<input class="peer/overall sr-only" type="radio" name="ranktab" id="tab-overall" checked />
						<input class="peer/exam sr-only" type="radio" name="ranktab" id="tab-exam" />
						<input class="peer/daily sr-only" type="radio" name="ranktab" id="tab-daily" />
						<input class="peer/business sr-only" type="radio" name="ranktab" id="tab-business" />

						<div class="rounded-t-2xl bg-[#ecf9fe] px-3 pt-3 sm:px-4
							peer-checked/overall:[&_.tab-overall]:relative peer-checked/overall:[&_.tab-overall]:z-10 peer-checked/overall:[&_.tab-overall]:h-full peer-checked/overall:[&_.tab-overall]:bg-[linear-gradient(to_bottom,#EE6B95,#F49BB5_55%,#fff_100%)] peer-checked/overall:[&_.tab-overall]:text-white peer-checked/overall:[&_.tab-overall]:shadow-[0_2px_8px_rgba(0,0,0,0.18)]
							peer-checked/exam:[&_.tab-exam]:relative peer-checked/exam:[&_.tab-exam]:z-10 peer-checked/exam:[&_.tab-exam]:h-full peer-checked/exam:[&_.tab-exam]:bg-[linear-gradient(to_bottom,#EE6B95,#F49BB5_55%,#fff_100%)] peer-checked/exam:[&_.tab-exam]:text-white peer-checked/exam:[&_.tab-exam]:shadow-[0_2px_8px_rgba(0,0,0,0.18)]
							peer-checked/daily:[&_.tab-daily]:relative peer-checked/daily:[&_.tab-daily]:z-10 peer-checked/daily:[&_.tab-daily]:h-full peer-checked/daily:[&_.tab-daily]:bg-[linear-gradient(to_bottom,#EE6B95,#F49BB5_55%,#fff_100%)] peer-checked/daily:[&_.tab-daily]:text-white peer-checked/daily:[&_.tab-daily]:shadow-[0_2px_8px_rgba(0,0,0,0.18)]
							peer-checked/business:[&_.tab-business]:relative peer-checked/business:[&_.tab-business]:z-10 peer-checked/business:[&_.tab-business]:h-full peer-checked/business:[&_.tab-business]:bg-[linear-gradient(to_bottom,#EE6B95,#F49BB5_55%,#fff_100%)] peer-checked/business:[&_.tab-business]:text-white peer-checked/business:[&_.tab-business]:shadow-[0_2px_8px_rgba(0,0,0,0.18)]
						">
							<div class="grid h-[50px] w-full grid-cols-4 items-end gap-0.5 text-[#595959] sm:gap-[10px]">
							<label
								for="tab-overall"
								class="tab tab-overall w-full cursor-pointer rounded-t-xl bg-[#d1d1d1] px-1.5 py-1 text-center text-[11px] font-extrabold leading-tight transition hover:bg-zinc-200 sm:px-3 sm:text-sm"
							>
								<div class="grid h-[80%] place-items-center">
									<span class="grid grid-rows-2 leading-tight">
										<span class="block">{overall?.title ?? "総合"}</span>
										<span class="block select-none text-transparent" aria-hidden="true">英会話</span>
									</span>
								</div>
							</label>
							<label
								for="tab-exam"
								class="tab tab-exam w-full cursor-pointer rounded-t-xl bg-[#d1d1d1] px-1.5 py-1 text-center text-[11px] font-extrabold leading-tight transition hover:bg-zinc-200 sm:px-3 sm:text-sm"
							>
								<div class="grid h-[80%] place-items-center">
									<span class="grid grid-rows-2 leading-tight">
										<span class="block">試験</span>
										<span class="block">対策</span>
									</span>
								</div>
							</label>
							<label
								for="tab-daily"
								class="tab tab-daily w-full cursor-pointer rounded-t-xl bg-[#d1d1d1] px-1.5 py-1 text-center text-[11px] font-extrabold leading-tight transition hover:bg-zinc-200 sm:px-3 sm:text-sm"
							>
								<div class="grid h-[80%] place-items-center">
									<span class="grid grid-rows-2 leading-tight">
										<span class="block">日曜</span>
										<span class="block">英会話</span>
									</span>
								</div>
							</label>
							<label
								for="tab-business"
								class="tab tab-business w-full cursor-pointer rounded-t-xl bg-[#d1d1d1] px-1.5 py-1 text-center text-[11px] font-extrabold leading-tight transition hover:bg-zinc-200 sm:px-3 sm:text-sm"
							>
								<div class="grid h-[80%] place-items-center">
									<span class="grid grid-rows-2 leading-tight">
										<span class="block">ビジネス</span>
										<span class="block">英会話</span>
									</span>
								</div>
							</label>
							</div>
						</div>

						<section class="px-3 pb-3 pt-4 sm:px-4 sm:pb-4 hidden peer-checked/overall:block">
							<p class="mb-3 text-sm text-zinc-600">{overall?.description}</p>
							<div class="grid gap-4">
								{overallItemsRated.slice(0, 3).map((x, idx) => (
										<RankingListItem
											item={x.data}
											offerId={x.id}
											rank={idx + 1}
											reviews={reviewsBySchoolId.get(x.id) ?? []}
											reviewStats={reviewStatsBySchoolId.get(x.id) ?? null}
										/>
								))}
							</div>
						</section>

						<section class="px-3 pb-3 pt-4 sm:px-4 sm:pb-4 hidden peer-checked/exam:block">
							<p class="mb-3 text-sm text-zinc-600">{exam?.description}</p>
							<div class="grid gap-4">
								{examItemsRated.slice(0, 3).map((x, idx) => (
										<RankingListItem
											item={x.data}
											offerId={x.id}
											rank={idx + 1}
											reviews={reviewsBySchoolId.get(x.id) ?? []}
											reviewStats={reviewStatsBySchoolId.get(x.id) ?? null}
										/>
								))}
							</div>
						</section>

						<section class="px-3 pb-3 pt-4 sm:px-4 sm:pb-4 hidden peer-checked/daily:block">
							<p class="mb-3 text-sm text-zinc-600">{daily?.description}</p>
							<div class="grid gap-4">
								{dailyItemsRated.slice(0, 3).map((x, idx) => (
										<RankingListItem
											item={x.data}
											offerId={x.id}
											rank={idx + 1}
											reviews={reviewsBySchoolId.get(x.id) ?? []}
											reviewStats={reviewStatsBySchoolId.get(x.id) ?? null}
										/>
								))}
							</div>
						</section>

						<section class="px-3 pb-3 pt-4 sm:px-4 sm:pb-4 hidden peer-checked/business:block">
							<p class="mb-3 text-sm text-zinc-600">{business?.description}</p>
							<div class="grid gap-4">
								{businessItemsRated.slice(0, 3).map((x, idx) => (
										<RankingListItem
											item={x.data}
											offerId={x.id}
											rank={idx + 1}
											reviews={reviewsBySchoolId.get(x.id) ?? []}
											reviewStats={reviewStatsBySchoolId.get(x.id) ?? null}
										/>
								))}
							</div>
						</section>
					</div>
				</section>

				<section id="compare">
					<div class="mb-4">
						<h2 class="text-xl font-extrabold text-zinc-900">比較表</h2>
						<p class="mt-1 text-sm text-zinc-600">上位スクールを項目ごとに横並びで比較できます（横スクロール可）。</p>
					</div>

					{overall && exam && daily && business ? (
						<CompareTableTabs
							overall={{ title: overall.title, items: overallItemsRated }}
							exam={{ title: exam.title, items: examItemsRated }}
							daily={{ title: daily.title, items: dailyItemsRated }}
							business={{ title: business.title, items: businessItemsRated }}
							columns={4}
						/>
					) : null}
				</section>

				<section id="pickup">
					{pickupTop?.schoolId ? (
						<PickupCard
              title={pickupTop.title}
              label={pickupTop.label}
              body={pickupTop.body}
              offerId={pickupTop.schoolId}
              ctaHref={pickupTop.ctaHref}
              ctaLabel={pickupTop.ctaLabel}
            />
					) : null}
				</section>

				<section id="details" class="space-y-6">
					<div class="rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
						<h2 class="text-xl font-extrabold text-zinc-900">ランキング詳細</h2>
						<p class="mt-1 text-sm text-zinc-600">PICKUPの下に、各社の詳細を順に掲載しています。</p>
					</div>

					{overallItemsRated.map((x, idx) => (
						<div id={`school-${x.id}`} class="scroll-mt-24">
							<SchoolDetailSection
								offerId={x.id}
								rank={idx + 1}
								item={x.data}
								reviews={reviewsBySchoolId.get(x.id) ?? []}
								reviewStats={reviewStatsBySchoolId.get(x.id) ?? null}
							/>
						</div>
					))}
				</section>

				<section class="rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm sm:p-6">
					<h2 class="text-xl font-extrabold text-zinc-900">よくある質問（オンライン英会話 おすすめ）</h2>
					<div class="mt-4 space-y-3">
						<details class="rounded-xl border border-zinc-200 bg-zinc-50 p-4">
							<summary class="cursor-pointer text-sm font-extrabold text-zinc-900">オンライン英会話のおすすめはどう選べばいい？</summary>
							<p class="mt-2 text-sm text-zinc-700">
								目的（総合/日常/ビジネス）を決めた上で、料金・無料体験の有無・受講可能時間・講師の質を比較すると選びやすいです。本ページでは目的別タブで比較できます。
							</p>
						</details>
						<details class="rounded-xl border border-zinc-200 bg-zinc-50 p-4">
							<summary class="cursor-pointer text-sm font-extrabold text-zinc-900">無料体験は受けた方がいい？</summary>
							<p class="mt-2 text-sm text-zinc-700">
								おすすめです。講師との相性や教材の使いやすさ、予約の取りやすさを実際に確認できます。
							</p>
						</details>
						<details class="rounded-xl border border-zinc-200 bg-zinc-50 p-4">
							<summary class="cursor-pointer text-sm font-extrabold text-zinc-900">初心者でも続けやすいオンライン英会話の特徴は？</summary>
							<p class="mt-2 text-sm text-zinc-700">
								日本語サポート・初心者向け教材・短時間レッスン・受講できる時間帯が広いサービスは継続しやすい傾向があります。
							</p>
						</details>
					</div>
				</section>

				</div>

				<!-- Desktop sidebar -->
				<div class="hidden lg:block lg:col-span-1">
					<Sidebar
						bannersTop={sidebarBannersTop}
						bannersMid={sidebarBannersMid}
						bannersBottom={sidebarBannersBottom}
						popular={overallItems.slice(0, 8).map((x) => ({
              offerId: x.id,
							name: x.data.name,
							officialUrl: x.data.officialUrl,
							logoUrl: x.data.logoUrl,
						}))}
						categories={[
							...catReco.map((c) => ({ title: c.title, href: c.href })),
							...catAge.map((c) => ({ title: c.title, href: c.href })),
							...catLevel.map((c) => ({ title: c.title, href: c.href })),
						]}
					/>
				</div>
			</div>
		</section>

		<!-- Mobile: show sidebar blocks after main content -->
		<section class="mt-10 lg:hidden">
			<Sidebar
				bannersTop={sidebarBannersTop}
				bannersMid={sidebarBannersMid}
				bannersBottom={sidebarBannersBottom}
				popular={overallItems.slice(0, 8).map((x) => ({
          offerId: x.id,
					name: x.data.name,
					officialUrl: x.data.officialUrl,
					logoUrl: x.data.logoUrl,
				}))}
				categories={[
					...catReco.map((c) => ({ title: c.title, href: c.href })),
					...catAge.map((c) => ({ title: c.title, href: c.href })),
					...catLevel.map((c) => ({ title: c.title, href: c.href })),
				]}
			/>
		</section>

	</main>
</Layout>
