---
type Props = {
  endsAt: string | null | undefined;
  /** Optional label shown before countdown */
  prefix?: string;
};

const { endsAt, prefix = "キャンペーン終了まであと" } = Astro.props satisfies Props;
const id =
  typeof crypto !== "undefined" && "randomUUID" in crypto ? crypto.randomUUID() : String(Math.random()).slice(2);
---

{endsAt ? (
  <div class="rounded-2xl border border-[#d8ceff] bg-[#f4f0ff] px-4 py-3 text-sm font-extrabold text-[#3e57c8]">
    <span class="mr-2">{prefix}</span>
    <span data-countdown-id={id} data-ends-at={endsAt}>—</span>
    <noscript>
      <span class="ml-2 text-xs font-semibold text-[#6a56d6]">（終了日時: {endsAt}）</span>
    </noscript>
  </div>
) : null}

{endsAt ? (
  <script is:inline>
    {`
(() => {
  const el = document.querySelector('[data-countdown-id="${id}"]');
  if (!el) return;
  const endsAt = el.getAttribute('data-ends-at');
  const end = new Date(endsAt);
  if (Number.isNaN(end.getTime())) { el.textContent = '—'; return; }

  const pad = (n) => String(n).padStart(2, '0');
  const tick = () => {
    const now = new Date();
    let ms = end.getTime() - now.getTime();
    if (ms <= 0) { el.textContent = 'まもなく終了！'; return; }
    const totalSec = Math.floor(ms / 1000);
    const days = Math.floor(totalSec / 86400);
    const hours = Math.floor((totalSec % 86400) / 3600);
    const mins = Math.floor((totalSec % 3600) / 60);
    const secs = totalSec % 60;
    el.textContent = \`\${days}日\${pad(hours)}時間\${pad(mins)}分\${pad(secs)}秒\`;
  };
  tick();
  const t = setInterval(tick, 1000);
  window.addEventListener('beforeunload', () => clearInterval(t));
})();
    `}
  </script>
) : null}

