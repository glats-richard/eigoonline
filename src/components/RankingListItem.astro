---
import CTAButton from "./CTAButton.astro";
import ReviewList from "./ReviewList.astro";
import StarRating from "./StarRating.astro";
import { getReviewStats } from "../utils/reviewStats";
import { Picture } from "astro:assets";
import kiminiDetailBanner from "../assets/kimini_detail_banner.webp";
import kiminiHeroDetailBanner from "../assets/heroes/kimini_detail_banner.webp";

type Item = {
  name: string;
  logoUrl?: string | null;
  heroImageUrl?: string | null;
  heroImageAlt?: string | null;
  officialUrl: string;
  trialText?: string | null;
  trialDetailText?: string | null;
  trialMaxDays?: number | null;
  trialPromoMaxDays?: number | null;
  campaignEndsAt?: string | null;
  priceText?: string | null;
  benefitText?: string | null;
  points?: string[] | null;
  features?: string[] | null;
};

type Props = {
  item: Item;
  offerId: string;
  rank: number;
  reviews?: { age: string; rating: number; body: string }[];
  reviewStats?: { count: number; avg: number | null } | null;
};

const { item, offerId, rank, reviews = [], reviewStats = null } = Astro.props satisfies Props;
const stats = reviewStats ?? getReviewStats(reviews);

const preferWebpForKnownPng = (url: string) => {
  if (url.endsWith("/kimini_detail_banner.png")) return url.replace(/\.png$/, ".webp");
  if (url.endsWith("/heroes/kimini_detail_banner.png")) return url.replace(/\.png$/, ".webp");
  return url;
};

const responsiveHero = (url: string) => {
  if (url === "/kimini_detail_banner.webp") {
    return {
      asset: kiminiDetailBanner,
    };
  }
  if (url === "/heroes/kimini_detail_banner.webp") {
    return {
      asset: kiminiHeroDetailBanner,
    };
  }
  return null;
};

const responsiveLogo = (url: string) => {
  if (url === "/logos/company-30.webp") {
    return {
      src: "/logos/company-30-320.webp",
      srcset: "/logos/company-30-320.webp 320w, /logos/company-30.webp 581w",
      sizes: "160px",
    };
  }
  if (url === "/logos/company-50.webp") {
    return {
      src: "/logos/company-50-320.webp",
      srcset: "/logos/company-50-320.webp 320w, /logos/company-50.webp 596w",
      sizes: "160px",
    };
  }
  return null;
};

const stripLeadingBullet = (v: unknown): string =>
  String(v ?? "")
    .replace(/^[\s\u3000]+/, "")
    .replace(/^(?:[・•\-–—*]\s*)+/, "")
    .trim();

const highlightItems = (item.points?.length ? item.points : item.features) ?? [];
const highlightText =
  highlightItems
    .map(stripLeadingBullet)
    .filter(Boolean)
    .slice(0, 6)
    .join("、") ||
  (item.benefitText ? stripLeadingBullet(item.benefitText) : "");

const parseCampaignEndsAt = (v: string | null | undefined): Date | null => {
  if (!v) return null;
  const s = String(v).trim();
  if (!s) return null;
  // YYYY-MM-DD -> interpret as end of day in JST.
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
    const d = new Date(`${s}T23:59:59+09:00`);
    return Number.isNaN(d.getTime()) ? null : d;
  }
  const d = new Date(s);
  return Number.isNaN(d.getTime()) ? null : d;
};

const isCampaignActive = (endsAt: string | null | undefined) => {
  const d = parseCampaignEndsAt(endsAt);
  if (!d) return false;
  return Date.now() <= d.getTime();
};

const maxDaysFromText = (text: string): number | null => {
  const s = String(text ?? "");
  let max: number | null = null;
  for (const m of s.matchAll(/(\d+)\s*日/g)) {
    const n = Number(m?.[1]);
    if (!Number.isFinite(n)) continue;
    if (max == null || n > max) max = n;
  }
  return max;
};

const maxFreeTrialDaysFromText = (text: string): number | null => {
  const s = String(text ?? "");
  let max: number | null = null;
  // Only treat numbers as "trial days" when they're in a free-trial context.
  const patterns = [
    /(\d+)\s*日(?:間)?\s*(?:無料(?:体験)?|無料トライアル)/g,
    /(?:無料(?:体験)?|無料トライアル)[^0-9]{0,12}(\d+)\s*日(?:間)?/g,
  ] as const;
  for (const re of patterns) {
    for (const m of s.matchAll(re)) {
      const n = Number(m?.[1]);
      if (!Number.isFinite(n)) continue;
      if (max == null || n > max) max = n;
    }
  }
  return max;
};

const active = isCampaignActive(item.campaignEndsAt);
const baseDaysFromField = typeof item.trialMaxDays === "number" && Number.isFinite(item.trialMaxDays) ? item.trialMaxDays : null;
const baseDaysFromText = maxDaysFromText(String(item.trialText ?? ""));
const baseDaysFromDetail = maxDaysFromText(String(item.trialDetailText ?? ""));
const baseDays = baseDaysFromField ?? baseDaysFromText ?? baseDaysFromDetail;
const promoDaysFromPool = maxFreeTrialDaysFromText(
  `${item.trialDetailText ?? ""} ${item.benefitText ?? ""} ${highlightText ?? ""}`,
);
const promoDaysCandidate =
  (active && typeof item.trialPromoMaxDays === "number" && Number.isFinite(item.trialPromoMaxDays) ? item.trialPromoMaxDays : null) ??
  (active ? promoDaysFromPool : null);
const promoDays = active && promoDaysCandidate != null && (baseDays == null || promoDaysCandidate > baseDays) ? promoDaysCandidate : null;
const displayDays = promoDays ?? baseDays;
---

<article class="rank-card surface rounded-2xl border border-white/30 shadow-sm">
  {item.heroImageUrl ? (
    <a
      href={`/${encodeURIComponent(offerId)}/`}
      class="block overflow-hidden rounded-t-2xl"
      aria-label={`${item.name}の詳細ページへ`}
    >
      {(() => {
        const heroUrl = preferWebpForKnownPng(item.heroImageUrl as string);
        const r = responsiveHero(heroUrl);
        if (r) {
          return (
            <Picture
              src={r.asset}
              alt={item.heroImageAlt ?? `${item.name} アイキャッチ`}
              widths={[400, 768, 1024]}
              sizes="(max-width: 768px) 100vw, 1024px"
              loading="lazy"
              decoding="async"
              class="h-auto w-full object-contain"
            />
          );
        }
        return (
          <img
            src={heroUrl}
            alt={item.heroImageAlt ?? `${item.name} アイキャッチ`}
            width="1024"
            height="565"
            loading="lazy"
            decoding="async"
            class="h-auto w-full object-contain"
          />
        );
      })()}
    </a>
  ) : null}

  <div class="grid grid-cols-[96px_1fr] gap-3 p-3 sm:grid-cols-[140px_1fr_auto] sm:items-center sm:gap-5 sm:p-5">
    <div class="flex h-16 items-center justify-center overflow-hidden rounded-xl border border-zinc-200 bg-zinc-50 p-2 sm:h-auto sm:p-3">
      {item.logoUrl ? (
        (() => {
          const lr = responsiveLogo(item.logoUrl as string);
          return (
            <img
              src={lr?.src ?? item.logoUrl}
              srcset={lr?.srcset}
              sizes={lr?.sizes}
              alt={`${item.name} ロゴ`}
              width="160"
              height="64"
              loading="lazy"
              decoding="async"
              class="h-12 w-auto max-w-full object-contain"
            />
          );
        })()
      ) : (
        <div class="text-sm font-semibold text-zinc-600">{item.name}</div>
      )}
    </div>

    <div class="min-w-0">
      <div class="flex items-center gap-2">
        {rank <= 3 ? (
          <img
            src={`/rank${rank}.webp`}
            alt={`${rank}位`}
            width="36"
            height="36"
            loading="eager"
            decoding="async"
            class="h-9 w-9 shrink-0 object-contain"
          />
        ) : (
          <div class="inline-flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-[#f4f0ff] text-xs font-extrabold text-[#6a56d6] ring-1 ring-[#d8ceff]">
            {rank}
          </div>
        )}
        <h3 class="min-w-0 truncate text-base font-extrabold text-[color:var(--brand-link-hover)] sm:text-lg">
          <a
            href={`/${encodeURIComponent(offerId)}/`}
            class="hover:underline decoration-[#aebcff] underline-offset-2"
            aria-label={`${item.name}の詳細ページへ`}
          >
            {item.name}
          </a>
        </h3>
        <a
          href={`/${encodeURIComponent(offerId)}/`}
          class="inline-flex shrink-0 items-center rounded-full bg-zinc-100 px-2 py-0.5 text-xs font-semibold text-zinc-700 hover:bg-zinc-200"
          aria-label={`${item.name}の詳細ページへ`}
          title={`${item.name}の詳細ページへ`}
        >
          ↗
        </a>
      </div>

      <div class="mt-2 flex flex-wrap items-center gap-3">
        <span class="text-xs font-extrabold text-zinc-700">総合評価</span>
        <StarRating value={stats.avg} size={16} />
        {stats.count ? (
          <span class="text-xs font-semibold text-zinc-500">（口コミ{stats.count}件）</span>
        ) : (
          <span class="text-xs font-semibold text-zinc-500">（口コミなし）</span>
        )}
      </div>

      <div class="mt-2 flex flex-wrap gap-2">
        <span class="inline-flex items-center rounded-md bg-zinc-100 px-2 py-1 text-xs font-bold text-zinc-700">無料体験</span>
        <span class="inline-flex max-w-full items-center rounded-md bg-white px-2 py-1 text-xs font-semibold text-zinc-900 ring-1 ring-zinc-200">
          <span class="break-words">
            {displayDays == null ? (item.trialText ?? "—") : `${displayDays}日間`}
          </span>
          {promoDays != null ? (
            <span class="ml-2 inline-flex items-center rounded-full bg-rose-100 px-2 py-0.5 text-[10px] font-extrabold text-rose-700 ring-1 ring-rose-200">
              増量中
            </span>
          ) : null}
        </span>

        <span class="ml-1 inline-flex items-center rounded-md bg-zinc-100 px-2 py-1 text-xs font-bold text-zinc-700">月額</span>
        <span class="inline-flex max-w-full items-center rounded-md bg-white px-2 py-1 text-xs font-semibold text-zinc-900 ring-1 ring-zinc-200">
          <span class="break-words">{item.priceText ?? "—"}</span>
        </span>
      </div>

      {highlightText ? (
        <div class="mt-2 flex flex-wrap items-center gap-2 rounded-xl bg-[#ffe8f2] px-3 py-2 ring-1 ring-[#ffc3dd]">
          <span class="inline-flex items-center rounded-md bg-[#d11d76] px-2 py-1 text-xs font-bold text-white">特徴</span>
          <span class="text-sm font-semibold text-zinc-800">{highlightText}</span>
        </div>
      ) : null}
    </div>

    <div class="col-span-2 sm:col-span-1 sm:py-2">
      <CTAButton href={item.officialUrl} offerId={offerId} label="公式サイトを見る" fullWidth />
    </div>
  </div>

  {reviews.length ? (
    <div class="border-t border-zinc-200 p-4">
      <details>
        <summary class="cursor-pointer select-none text-sm font-extrabold text-[color:var(--brand-link-hover)]">
          {item.name}の口コミ・評判を見る
          <span class="ml-2 text-xs font-semibold text-zinc-500">（{Math.min(3, reviews.length)}件表示）</span>
        </summary>
        <ReviewList title={`${item.name}の口コミ・評判`} items={reviews} />
        <div class="mt-3 flex flex-wrap items-center justify-end gap-2">
          <a
            href={`/${encodeURIComponent(offerId)}/reviews`}
            class="text-xs font-semibold text-[color:var(--brand-link)] underline decoration-[#aebcff] underline-offset-2 hover:text-[color:var(--brand-link-hover)]"
          >
            口コミをもっと見る →
          </a>
        </div>
      </details>
    </div>
  ) : null}
</article>

