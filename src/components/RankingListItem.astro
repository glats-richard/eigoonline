---
import CTAButton from "./CTAButton.astro";
import ReviewList from "./ReviewList.astro";
import StarRating from "./StarRating.astro";
import { getReviewStats } from "../utils/reviewStats";

type Item = {
  name: string;
  logoUrl?: string | null;
  officialUrl: string;
  trialText?: string | null;
  priceText?: string | null;
  benefitText?: string | null;
};

type Props = {
  item: Item;
  offerId: string;
  rank: number;
  reviews?: { age: string; rating: number; body: string }[];
  reviewStats?: { count: number; avg: number | null } | null;
};

const { item, offerId, rank, reviews = [], reviewStats = null } = Astro.props satisfies Props;
const stats = reviewStats ?? getReviewStats(reviews);
---

<article class="surface rounded-2xl border border-white/30 shadow-sm">
  <div class="grid grid-cols-[96px_1fr] gap-3 p-3 sm:grid-cols-[140px_1fr_auto] sm:items-center sm:gap-5 sm:p-5">
    <div class="flex h-16 items-center justify-center rounded-xl border border-zinc-200 bg-zinc-50 p-2 sm:h-auto sm:p-3">
      {item.logoUrl ? (
        <img
          src={item.logoUrl}
          alt={`${item.name} ロゴ`}
          loading="lazy"
          decoding="async"
          class="h-12 w-auto max-w-[120px] object-contain"
        />
      ) : (
        <div class="text-sm font-semibold text-zinc-600">{item.name}</div>
      )}
    </div>

    <div class="min-w-0">
      <div class="flex items-center gap-2">
        {rank <= 3 ? (
          <img
            src={`/rank${rank}.webp`}
            alt={`${rank}位`}
            width="36"
            height="36"
            loading="eager"
            decoding="async"
            class="h-9 w-9 shrink-0 object-contain"
          />
        ) : (
          <div class="inline-flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-[#f4f0ff] text-xs font-extrabold text-[#6a56d6] ring-1 ring-[#d8ceff]">
            {rank}
          </div>
        )}
        <h3 class="min-w-0 truncate text-base font-extrabold text-[color:var(--brand-link-hover)] sm:text-lg">
          <a
            href={`/${encodeURIComponent(offerId)}/`}
            class="hover:underline decoration-[#aebcff] underline-offset-2"
            aria-label={`${item.name}の詳細ページへ`}
          >
            {item.name}
          </a>
        </h3>
        <a
          href={`/${encodeURIComponent(offerId)}/`}
          class="inline-flex shrink-0 items-center rounded-full bg-zinc-100 px-2 py-0.5 text-xs font-semibold text-zinc-700 hover:bg-zinc-200"
          aria-label={`${item.name}の詳細ページへ`}
          title={`${item.name}の詳細ページへ`}
        >
          ↗
        </a>
      </div>

      <div class="mt-2 flex flex-wrap items-center gap-3">
        <span class="text-xs font-extrabold text-zinc-700">総合評価</span>
        <StarRating value={stats.avg} size={16} />
        {stats.count ? (
          <span class="text-xs font-semibold text-zinc-500">（口コミ{stats.count}件）</span>
        ) : (
          <span class="text-xs font-semibold text-zinc-500">（口コミなし）</span>
        )}
      </div>

      <div class="mt-2 flex flex-wrap gap-2">
        <span class="inline-flex items-center rounded-md bg-zinc-100 px-2 py-1 text-xs font-bold text-zinc-700">無料体験</span>
        <span class="inline-flex max-w-full items-center rounded-md bg-white px-2 py-1 text-xs font-semibold text-zinc-900 ring-1 ring-zinc-200">
          <span class="break-words">{item.trialText ?? "—"}</span>
        </span>

        <span class="ml-1 inline-flex items-center rounded-md bg-zinc-100 px-2 py-1 text-xs font-bold text-zinc-700">月額</span>
        <span class="inline-flex max-w-full items-center rounded-md bg-white px-2 py-1 text-xs font-semibold text-zinc-900 ring-1 ring-zinc-200">
          <span class="break-words">{item.priceText ?? "—"}</span>
        </span>
      </div>

      {item.benefitText ? (
        <div class="mt-2 flex flex-wrap items-center gap-2 rounded-xl bg-[#ffe8f2] px-3 py-2 ring-1 ring-[#ffc3dd]">
          <span class="inline-flex items-center rounded-md bg-[#ff7ab6] px-2 py-1 text-xs font-extrabold text-white">特典</span>
          <span class="text-sm font-semibold text-zinc-800">{item.benefitText}</span>
        </div>
      ) : null}
    </div>

    <div class="col-span-2 sm:col-span-1 sm:py-2">
      <CTAButton href={item.officialUrl} offerId={offerId} label="公式サイトを見る" fullWidth />
    </div>
  </div>

  {reviews.length ? (
    <div class="border-t border-zinc-200 p-4">
      <details>
        <summary class="cursor-pointer select-none text-sm font-extrabold text-[color:var(--brand-link-hover)]">
          {item.name}の口コミ・評判を見る
          <span class="ml-2 text-xs font-semibold text-zinc-500">（{Math.min(3, reviews.length)}件表示）</span>
        </summary>
        <ReviewList title={`${item.name}の口コミ・評判`} items={reviews} />
        <div class="mt-3 flex flex-wrap items-center justify-end gap-2">
          <a
            href={`/${encodeURIComponent(offerId)}/reviews`}
            class="text-xs font-semibold text-[color:var(--brand-link)] underline decoration-[#aebcff] underline-offset-2 hover:text-[color:var(--brand-link-hover)]"
          >
            口コミをもっと見る →
          </a>
        </div>
      </details>
    </div>
  ) : null}
</article>

