---
type Banner = { href: string; image: string; alt: string; label?: string };
type Props = { heading?: string; items: Banner[] };

const { heading = "バナー", items } = Astro.props satisfies Props;

const isLocal = (src: string) => src.startsWith("/");

const bannerImgAttrs = (src: string) => {
  // Special-case: provide responsive srcset for our sidebar PR banner (329px wide slot).
  if (src.startsWith("/banners/") && src.endsWith("-329.webp")) {
    const src2x = src.replace(/-329\.webp$/i, "-658.webp");
    return {
      src,
      srcset: `${src} 329w, ${src2x} 658w`,
      sizes: "(min-width: 768px) 329px, 100vw",
      width: 329,
      height: 165,
    } as const;
  }

  return { src } as const;
};

// Wrap all external CTA links (except Kimini) so that redirects go through
// our tracking endpoint, e.g.
// /api/track/click?offer_id=xxx&to=...
const withTracking = (href: string) => {
  // Already a tracking URL → そのまま使う
  if (href.startsWith("/api/track/click")) return href;

  // 外部リンクは原則 tracking 経由にする（Kiminiだけは除外して直接遷移）
  if (/^https?:\/\//.test(href)) {
    // Kiminiドメインはリダイレクトを通さずにそのまま遷移
    if (href.includes("kimini.online")) {
      return href;
    }
    // Kimini以外は外部トラッキング経由
    const offerId = "external";
    return `/api/track/click?offer_id=${encodeURIComponent(offerId)}&to=${encodeURIComponent(href)}`;
  }

  // 相対パスなどはそのまま
  return href;
};

const isExternal = (href: string) =>
  /^https?:\/\//.test(href) || href.startsWith("/api/track/click");
---

<section class="rounded-2xl border border-zinc-200 bg-white p-3 shadow-sm">
  <div class="px-2 pb-2 text-xs font-extrabold text-zinc-500">{heading}</div>
  {items.length ? (
    <div class="grid gap-3">
      {items.map((b) => (
        (() => {
          const img = bannerImgAttrs(b.image);
          return (
        <a
          href={withTracking(b.href)}
          target={isExternal(b.href) ? "_blank" : undefined}
          rel={isExternal(b.href) ? "nofollow sponsored noopener noreferrer" : undefined}
          referrerpolicy={isExternal(b.href) ? "no-referrer" : undefined}
          class="group relative block overflow-hidden rounded-xl border border-zinc-200 bg-zinc-50"
        >
          {b.label ? (
            <span class="absolute left-2 top-2 z-10 inline-flex items-center rounded-md bg-zinc-900 px-2 py-0.5 text-[10px] font-extrabold text-white">
              {b.label}
            </span>
          ) : null}
          <img
            src={img.src}
            srcset={(img as any).srcset}
            sizes={(img as any).sizes}
            width={(img as any).width}
            height={(img as any).height}
            alt={b.alt}
            loading="lazy"
            decoding="async"
            class="h-auto w-full object-contain transition group-hover:opacity-95"
          />
        </a>
          );
        })()
      ))}
    </div>
  ) : (
    <div class="grid h-24 place-items-center rounded-xl border border-dashed border-zinc-300 bg-zinc-50 text-xs font-semibold text-zinc-500">
      バナー枠（準備中）
    </div>
  )}
</section>

