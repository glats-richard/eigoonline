---
import SidebarBanner from "./SidebarBanner.astro";
import CategoryIcon from "./CategoryIcon.astro";
import ReviewSubmitCard from "./ReviewSubmitCard.astro";

type School = { offerId: string; name: string; officialUrl: string; logoUrl?: string | null };

type Props = {
  bannersTop?: { href: string; image: string; alt: string; label?: string }[];
  bannersMid?: { href: string; image: string; alt: string; label?: string }[];
  bannersBottom?: { href: string; image: string; alt: string; label?: string }[];
  popular: School[];
  categories: { title: string; href: string }[];
};

const { bannersTop = [], bannersMid = [], bannersBottom = [], popular, categories } = Astro.props satisfies Props;

const uniqueCategories = Array.from(new Map(categories.map((c) => [c.href, c] as const)).values());
const allBanners = [...bannersTop, ...bannersMid, ...bannersBottom];
const topBanner = allBanners[0] ? [allBanners[0]] : [];
const bottomBanners = allBanners.length > 1 ? allBanners.slice(1) : [];

const trackHref = (offerId: string, href: string) =>
  href.startsWith("http://") || href.startsWith("https://")
    ? `/api/track/click?offer_id=${encodeURIComponent(offerId)}&to=${encodeURIComponent(href)}`
    : href;
---

<aside class="space-y-4">
  {topBanner.length ? <SidebarBanner heading="おすすめバナー" items={topBanner} /> : null}

  <ReviewSubmitCard className="hidden lg:block" />

  {uniqueCategories.length ? (
    <section class="rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
      <h3 class="text-base font-extrabold text-zinc-900">カテゴリ別ランキング</h3>
      <div class="mt-4 grid gap-2 max-h-[380px] overflow-y-auto pr-1 overscroll-contain [-webkit-overflow-scrolling:touch]">
        {uniqueCategories.map((c) => (
          <a
            href={c.href}
            class="flex items-center gap-3 rounded-xl border border-zinc-200 bg-zinc-50 px-4 py-2.5 text-sm font-bold text-zinc-800 hover:bg-zinc-100"
          >
            <span class="grid h-6 w-6 place-items-center rounded-lg bg-white text-zinc-700 ring-1 ring-zinc-200">
              <CategoryIcon title={c.title} href={c.href} />
            </span>
            <span class="min-w-0 truncate">{c.title}</span>
          </a>
        ))}
      </div>
    </section>
  ) : null}

  {popular.length ? (
    <section class="rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
      <h3 class="text-base font-extrabold text-zinc-900">人気のオンライン英会話一覧</h3>
      <div class="mt-4 grid gap-2">
        {popular.map((s) => (
          <a
            href={trackHref(s.offerId, s.officialUrl)}
            target="_blank"
            rel="nofollow sponsored noopener noreferrer"
            referrerpolicy="no-referrer"
            class="flex min-w-0 items-center gap-3 rounded-xl border border-zinc-200 bg-white px-4 py-2.5 hover:bg-zinc-50"
          >
            <span class="flex min-w-0 flex-1 items-center gap-2">
              {s.logoUrl ? (
                <img
                  src={s.logoUrl}
                  alt=""
                  loading="lazy"
                  decoding="async"
                  class="h-5 w-auto max-w-[72px] shrink-0 object-contain"
                />
              ) : null}
              <span class="min-w-0 truncate text-sm font-extrabold text-zinc-900">{s.name}</span>
            </span>
            <span class="shrink-0 text-xs font-bold text-zinc-500">↗</span>
          </a>
        ))}
      </div>
    </section>
  ) : null}

  {bottomBanners.length ? <SidebarBanner heading="おすすめバナー" items={bottomBanners} /> : null}
</aside>

