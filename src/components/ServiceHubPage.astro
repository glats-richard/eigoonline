---
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import StarRating from "./StarRating.astro";
import { dbEnvError, query } from "../lib/db";
import { getSchoolsMerged } from "../lib/schools";
import { getCollection } from "astro:content";
import { getReviewStats } from "../utils/reviewStats";

type Props = {
  schoolId: string;
};

const { schoolId } = Astro.props satisfies Props;
const LATEST_REVIEW_LIMIT = 10;

// Merge DB overrides (from /tracker) over static content.
const schools = await getSchoolsMerged();
const schoolEntry = schools.find((s) => s.id === schoolId) ?? null;
const school = schoolEntry?.data ?? null;

if (!school) {
  Astro.response.status = 404;
}

// Kimini はリダイレクトAPIを通さず直接CVへ。それ以外は /api/track/click 経由
const mainCtaHref =
  !school
    ? ""
    : schoolId === "kimini"
      ? ((school.planUrl || school.officialUrl) ?? "")
      : `/api/track/click?offer_id=${encodeURIComponent(schoolId)}&to=${encodeURIComponent((school.planUrl || school.officialUrl) ?? "")}`;

// Overall rank (if present in rankings/overall.json)
const rankings = await getCollection("rankings");
const overallRanking = rankings.find((r) => r.data.category === "overall")?.data ?? null;
const overallRankIndex = overallRanking ? overallRanking.items.indexOf(schoolId) : -1;
const overallRank = overallRankIndex >= 0 ? overallRankIndex + 1 : null;

function rankFor(category: string): number | null {
  const r = rankings.find((x) => x.data.category === category)?.data ?? null;
  if (!r) return null;
  const idx = r.items.indexOf(schoolId);
  return idx >= 0 ? idx + 1 : null;
}

const businessRank = rankFor("business");
const kidsRank = rankFor("kids");

const parseCampaignEndsAt = (v: string | null | undefined): Date | null => {
  if (!v) return null;
  const s = String(v).trim();
  if (!s) return null;
  // YYYY-MM-DD -> interpret as end of day in JST.
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
    const d = new Date(`${s}T23:59:59+09:00`);
    return Number.isNaN(d.getTime()) ? null : d;
  }
  const d = new Date(s);
  return Number.isNaN(d.getTime()) ? null : d;
};

const isCampaignActive = (endsAt: string | null | undefined) => {
  const d = parseCampaignEndsAt(endsAt);
  if (!d) return false;
  return Date.now() <= d.getTime();
};

const maxDaysFromText = (text: string): number | null => {
  const s = String(text ?? "");
  let max: number | null = null;
  for (const m of s.matchAll(/(\d+)\s*日/g)) {
    const n = Number(m?.[1]);
    if (!Number.isFinite(n)) continue;
    if (max == null || n > max) max = n;
  }
  return max;
};

const maxFreeTrialDaysFromText = (text: string): number | null => {
  const s = String(text ?? "");
  let max: number | null = null;
  // Only treat numbers as "trial days" when they're in a free-trial context.
  const patterns = [
    /(\d+)\s*日(?:間)?\s*(?:無料(?:体験)?|無料トライアル)/g,
    /(?:無料(?:体験)?|無料トライアル)[^0-9]{0,12}(\d+)\s*日(?:間)?/g,
  ] as const;
  for (const re of patterns) {
    for (const m of s.matchAll(re)) {
      const n = Number(m?.[1]);
      if (!Number.isFinite(n)) continue;
      if (max == null || n > max) max = n;
    }
  }
  return max;
};

const trialPill = (() => {
  if (!school) return { displayText: "—", promoDays: null as number | null };

  const active = isCampaignActive(school.campaignEndsAt);
  const baseDaysFromField = typeof school.trialMaxDays === "number" && Number.isFinite(school.trialMaxDays) ? school.trialMaxDays : null;
  const baseDaysFromText = maxDaysFromText(String(school.trialText ?? ""));
  const baseDaysFromDetail = maxDaysFromText(String(school.trialDetailText ?? ""));
  const baseDays = baseDaysFromField ?? baseDaysFromText ?? baseDaysFromDetail;
  const promoDaysFromPool = maxFreeTrialDaysFromText(
    `${school.trialDetailText ?? ""} ${school.campaignText ?? ""} ${school.benefitText ?? ""} ${school.heroImageAlt ?? ""}`,
  );
  const promoDaysCandidate =
    (active && typeof school.trialPromoMaxDays === "number" && Number.isFinite(school.trialPromoMaxDays) ? school.trialPromoMaxDays : null) ??
    (active ? promoDaysFromPool : null);
  const promoDays =
    active && promoDaysCandidate != null && (baseDays == null || promoDaysCandidate > baseDays) ? promoDaysCandidate : null;
  const displayDays = promoDays ?? baseDays;

  return {
    displayText: displayDays == null ? (school.trialText ?? "—") : `${displayDays}日間`,
    promoDays,
  };
})();

// Radar chart quality metrics:
// - Prefer averages from approved user reviews (DB)
// - Fall back to editorial scores in `src/content/schools/*.json`
type RadarQuality = {
  teacherQuality: number | null;
  materialQuality: number | null;
  connectionQuality: number | null;
  priceRating: number | null;
  satisfactionRating: number | null;
};

function asQualityNumber(v: unknown): number | null {
  return typeof v === "number" && Number.isFinite(v) ? v : null;
}

const radarQualityById = new Map<string, RadarQuality>(
  schools.map((s) => [
    s.id,
    {
      teacherQuality: asQualityNumber(s.data.teacherQuality),
      materialQuality: asQualityNumber(s.data.materialQuality),
      connectionQuality: asQualityNumber(s.data.connectionQuality),
      // These 2 axes are derived from user reviews (DB). Content JSON doesn't have editorial fallback.
      priceRating: null,
      satisfactionRating: null,
    },
  ]),
);

// Radar chart geometry (5 axes)
const RADAR_CX = 110;
const RADAR_CY = 110;
const RADAR_R = 78;
const RADAR_AXES = [
  { key: "teacherQuality", label: "講師" },
  { key: "materialQuality", label: "教材" },
  { key: "connectionQuality", label: "通信" },
  { key: "priceRating", label: "安さ" },
  { key: "satisfactionRating", label: "満足度" },
] as const;

function clampRadar(v: unknown): number {
  if (typeof v !== "number" || !Number.isFinite(v)) return 0;
  if (v < 0) return 0;
  if (v > 5) return 5;
  return v;
}

function radarPoints(model: Record<string, unknown> | null, scale = 1): string {
  return RADAR_AXES.map((a, i) => {
    const ang = -Math.PI / 2 + (i * 2 * Math.PI) / RADAR_AXES.length;
    const val = clampRadar(model ? model[a.key] : 0);
    const rr = RADAR_R * (val / 5) * scale;
    const x = RADAR_CX + rr * Math.cos(ang);
    const y = RADAR_CY + rr * Math.sin(ang);
    return `${x.toFixed(1)},${y.toFixed(1)}`;
  }).join(" ");
}

function radarGridPoints(level: number): string {
  const t = clampRadar(level) / 5;
  return RADAR_AXES.map((_, i) => {
    const ang = -Math.PI / 2 + (i * 2 * Math.PI) / RADAR_AXES.length;
    const rr = RADAR_R * t;
    const x = RADAR_CX + rr * Math.cos(ang);
    const y = RADAR_CY + rr * Math.sin(ang);
    return `${x.toFixed(1)},${y.toFixed(1)}`;
  }).join(" ");
}

// Static reviews (editorial)
const reviewsCollection = await getCollection("reviews");
const staticReviews = reviewsCollection.find((r) => r.data.schoolId === schoolId)?.data.items ?? [];
const staticStats = getReviewStats(staticReviews);

// DB reviews (approved)
type DbReview = {
  created_at: string | null;
  overall_rating: number | null;
  body: string | null;
  improvement_points?: string | null;
  improvement_points_response?: string | null;
  birth_year: number | null;
  birth_month: number | null;
  age: string | null; // legacy
  nickname: string | null;
  duration_months: number | null;
};

type DisplayReview = {
  label: string;
  rating: number;
  body: string;
  improvementPoints?: string | null;
  companyResponse?: string | null;
  createdAt: string | null;
  studyPeriod: string | null;
};

let dbLatest: DisplayReview[] = [];
let dbCount = 0;
let dbAvg: number | null = null;
let dbErr: string | null = null;

try {
  const statsRes = await query<{ count: number; avg: number | null }>(
    "select count(*)::bigint as count, avg(overall_rating)::numeric as avg from reviews where status = 'approved' and school_id = $1 and overall_rating is not null",
    [schoolId],
  );
  dbCount = statsRes.rows?.[0]?.count ?? 0;
  dbAvg = statsRes.rows?.[0]?.avg ?? null;

  // Quality averages (teacher/material/connection + price/satisfaction) across services for radar compare
  const qRes = await query<{
    school_id: string;
    count: number;
    tq: number | null;
    mq: number | null;
    cq: number | null;
    pr: number | null;
    sr: number | null;
  }>(
    "select school_id, count(*)::int as count, avg(teacher_quality)::numeric as tq, avg(material_quality)::numeric as mq, avg(connection_quality)::numeric as cq, avg(price_rating)::numeric as pr, avg(satisfaction_rating)::numeric as sr from reviews where status = 'approved' and overall_rating is not null group by school_id",
  );

  for (const row of qRes.rows ?? []) {
    if (!row?.school_id) continue;
    if (!radarQualityById.has(row.school_id)) continue;
    if ((row.count ?? 0) <= 0) continue;
    radarQualityById.set(row.school_id, {
      teacherQuality: asQualityNumber(row.tq),
      materialQuality: asQualityNumber(row.mq),
      connectionQuality: asQualityNumber(row.cq),
      priceRating: asQualityNumber(row.pr),
      satisfactionRating: asQualityNumber(row.sr),
    });
  }

  const latestRes = await query<DbReview>(
    `
    select *
    from reviews
    where status = 'approved' and school_id = $1
    order by created_at desc
    limit ${LATEST_REVIEW_LIMIT}
    `,
    [schoolId],
  );

  dbLatest = (latestRes.rows ?? []).map((r: DbReview) => ({
    label:
      r.nickname || "ユーザー",
    rating: r.overall_rating ?? 0,
    body: r.body ?? "",
    improvementPoints: r.improvement_points ?? null,
    companyResponse: r.improvement_points_response ?? null,
    createdAt: r.created_at ?? null,
    studyPeriod: r.duration_months ? `${r.duration_months}ヶ月` : null,
  }));
} catch (e: any) {
  // If DB isn't ready, continue with static reviews only
  dbErr = e?.message ?? String(e);
}

const radarBaseQuality = radarQualityById.get(schoolId) ?? {
  teacherQuality: asQualityNumber(school?.teacherQuality),
  materialQuality: asQualityNumber(school?.materialQuality),
  connectionQuality: asQualityNumber(school?.connectionQuality),
  priceRating: null,
  satisfactionRating: null,
};

const compareOptions = schools
  .map((s) => {
    const q = radarQualityById.get(s.id) ?? {
      teacherQuality: asQualityNumber(s.data.teacherQuality),
      materialQuality: asQualityNumber(s.data.materialQuality),
      connectionQuality: asQualityNumber(s.data.connectionQuality),
      priceRating: null,
      satisfactionRating: null,
    };
    return {
      id: s.id,
      name: s.data.name,
      teacherQuality: q.teacherQuality,
      materialQuality: q.materialQuality,
      connectionQuality: q.connectionQuality,
      priceRating: q.priceRating,
      satisfactionRating: q.satisfactionRating,
    };
  })
  .filter((s) => s.id !== schoolId)
  .filter(
    (s) =>
      s.teacherQuality !== null ||
      s.materialQuality !== null ||
      s.connectionQuality !== null ||
      s.priceRating !== null ||
      s.satisfactionRating !== null,
  )
  .sort((a, b) => a.name.localeCompare(b.name, "ja"));

const staticLatest: DisplayReview[] = staticReviews.map((r) => ({
  label: r.nickname || r.age || "ユーザー",
  rating: r.rating ?? 0,
  body: r.body ?? "",
  createdAt: null,
  studyPeriod: r.studyPeriod ?? null,
}));

// Prefer DB latest; if less than limit, fill with static reviews
const displayLatest: DisplayReview[] = dbLatest.length
  ? dbLatest.slice(0, LATEST_REVIEW_LIMIT)
  : staticLatest.slice(0, LATEST_REVIEW_LIMIT);

// Aggregate rating variables (designed to be dynamically fed)
const staticCount = staticStats.count;
const staticAvg = staticStats.avg;

const totalCount = staticCount + dbCount;
const ratingValue =
  totalCount > 0
    ? Math.round(
        (((staticAvg ?? 0) * staticCount + (dbAvg ?? 0) * dbCount) / totalCount) * 10,
      ) / 10
    : null;
const reviewCount = totalCount;

// Meta (AI-friendly concise description)
const title = school ? `${school.name}｜料金・特徴・口コミ・評判まとめ` : "サービス情報";
const description = school
  ? schoolId === "kimini"
    ? "Kimini英会話（学研グループ運営）の料金・特徴（学研メソッド）・口コミ・総合評価をまとめたページです。"
    : `${school.name}の料金・特徴・口コミ・総合評価をまとめたページです。`
  : "サービス情報ページです。";

const base = Astro.site ? new URL(Astro.site) : new URL(Astro.url.origin);
const pageUrl = new URL(Astro.url.pathname, base).toString();
const logoAbs = school?.logoUrl ? new URL(school.logoUrl, base).toString() : null;

// On-page content (user-friendly headings; structured/consistent wording)
const introPlacement: "section" | "hero" = (school as any)?.introPlacement === "hero" ? "hero" : "section";

const bluf =
  schoolId === "kimini"
    ? "Kimini英会話は学研が運営するオンライン英会話で、教材と学習ステップが整理されているため、初心者でも迷わず継続しやすいのが特徴です。月額1,210円から・無料体験10日間に加え、TOEIC講座（Shikaku Pass）無料特典（〜2026-01-31）があります。"
    : `${school?.name ?? "本サービス"}はオンライン英会話で、料金・無料体験・口コミを比較しながら検討できます。`;

function normalizeTag(s: string): string {
  return String(s ?? "")
    .replace(/[。．.!！?？]/g, "")
    .replace(/\s+/g, " ")
    .trim();
}

function shortenTag(s: string, max = 18): string {
  const t = normalizeTag(s);
  return t.length > max ? `${t.slice(0, max)}…` : t;
}

function uniqTags(xs: string[], limit = 10): string[] {
  return Array.from(new Set(xs.map(normalizeTag).filter(Boolean))).slice(0, limit).map((t) => shortenTag(t, 18));
}

const recommendedTagsRaw: string[] = school?.recommendedFor ?? [];
const featureTagsRaw: string[] = school?.features ?? [];

const recommendedTags = uniqTags(recommendedTagsRaw, 8);
const featureTags = uniqTags(featureTagsRaw, 8);

const entityRows = [
  { k: "サービス名", v: school?.name ?? "—" },
  { k: "総合ランキング", v: overallRank ? `${overallRank}位（当サイト）` : "—" },
  { k: "月額料金", v: school?.priceText ?? "—" },
  { k: "無料体験", v: school?.trialText ?? "—" },
  { k: "特典/キャンペーン", v: school?.campaignText ?? "—" },
  { k: "特典期限", v: school?.campaignEndsAt ?? "—" },
  { k: "講師の質", v: typeof school?.teacherQuality === "number" ? `${school.teacherQuality} / 5` : "—" },
  { k: "教材の質", v: typeof school?.materialQuality === "number" ? `${school.materialQuality} / 5` : "—" },
  { k: "通信の質", v: typeof school?.connectionQuality === "number" ? `${school.connectionQuality} / 5` : "—" },
  { k: "口コミ件数（集計）", v: `${reviewCount}件` },
  { k: "総合評価（集計）", v: ratingValue !== null ? `${ratingValue} / 5` : "—" },
];

type IntroMedia =
  | { type: "image"; src: string; alt?: string | null; width?: number | null; height?: number | null }
  | { type: "iframe"; src: string; width?: number | null; height?: number | null };

type IntroSection = {
  title: string;
  body: string;
  wideMedia?: IntroMedia | null;
  sideMedia?: IntroMedia | null;
  reverse?: boolean;
};

const introSections: IntroSection[] = Array.isArray((school as any)?.introSections) ? (((school as any).introSections as any[]) as IntroSection[]) : [];

function isNonEmptyString(v: unknown): v is string {
  return typeof v === "string" && v.trim().length > 0;
}

function fmtYenFromPriceText(v: unknown): string | null {
  const s = String(v ?? "").replace(/\s+/g, " ").trim();
  if (!s) return null;
  // Prefer a number like "1,210" or "1210" followed by 円
  const m = s.match(/([\d,]{3,})\s*円/);
  if (!m) return null;
  const n = Number(String(m[1]).replace(/,/g, ""));
  if (!Number.isFinite(n) || n <= 0) return null;
  return `¥${n.toLocaleString("ja-JP")}`;
}

const cheapestPlanYen = fmtYenFromPriceText(school?.priceText);

function minYenFromPriceText(v: unknown): number | null {
  const s = String(v ?? "").replace(/\s+/g, " ").trim();
  if (!s) return null;
  const matches = Array.from(s.matchAll(/([\d,]{1,})\s*円/g));
  if (!matches.length) return null;
  const nums = matches
    .map((m) => Number(String(m[1]).replace(/,/g, "")))
    .filter((n) => Number.isFinite(n) && n > 0);
  if (!nums.length) return null;
  return Math.min(...nums);
}

const minPriceYen = minYenFromPriceText(school?.priceText);

// Optional structured-data hint: keep prices valid far into the future.
const DEFAULT_PRICE_VALID_UNTIL = `${new Date().getFullYear() + 1}-12-31`;

function getYoutubeId(url: string | null | undefined): string | null {
  if (!url) return null;
  try {
    const u = new URL(url);
    if (u.hostname === "youtu.be") return u.pathname.slice(1);
    if (u.hostname.includes("youtube.com")) {
      return u.searchParams.get("v") || u.pathname.split("/").pop() || null;
    }
    return null;
  } catch {
    return null;
  }
}

type PrMedia = { src: string; alt?: string | null; width?: number | null; height?: number | null };
type PrYoutube = { youtube: string; title?: string | null };
type PrSection = {
  iconText?: string | null;
  iconUrl?: string | null;
  title: string;
  body: string;
  image?: PrMedia | PrYoutube | null;
  reverse?: boolean;
};

const prSections: PrSection[] = Array.isArray((school as any)?.prSections) ? (((school as any).prSections as any[]) as PrSection[]) : [];

const introHeroText =
  introPlacement === "hero" && introSections.length
    ? introSections
        .map((s) => (isNonEmptyString(s?.body) ? String(s.body).trim() : ""))
        .filter(Boolean)
        .join("\n\n")
    : "";

function looksLikeJsonArray(s: string): boolean {
  const t = String(s ?? "").trim();
  if (!t) return false;
  if (!(t.startsWith("[") && t.endsWith("]"))) return false;
  try {
    return Array.isArray(JSON.parse(t));
  } catch {
    return false;
  }
}

const stripLeadingBullet = (v: unknown): string =>
  String(v ?? "")
    .replace(/^[\s\u3000]+/, "")
    .replace(/^(?:[・•\-–—*]\s*)+/, "")
    .trim();

const heroDescriptionOverrideRaw = typeof school?.heroDescription === "string" ? school.heroDescription : null;
const heroDescriptionOverride =
  introPlacement === "hero" && heroDescriptionOverrideRaw && looksLikeJsonArray(heroDescriptionOverrideRaw) ? null : heroDescriptionOverrideRaw;

const heroDescription =
  heroDescriptionOverride ??
  (introHeroText || null) ??
  school?.summary ??
  "オンライン英会話の料金・特徴・口コミをまとめています。";

function preferWebpForKnownPng(url: string): string {
  // LCP対策: 大きいPNGはWebPを優先（同名の .webp を public/ に用意している）
  if (url.endsWith("/kimini_detail_banner.png")) return url.replace(/\.png$/, ".webp");
  if (url.endsWith("/heroes/kimini_detail_banner.png")) return url.replace(/\.png$/, ".webp");
  return url;
}
const methodologyRaw = school?.methodology?.length ? school.methodology : null;
const methodology: string[] =
  (methodologyRaw as string[] | null | undefined) ??
  (schoolId === "kimini"
    ? [
        "Kimini英会話は教材と学習ステップがコース化されているため、学習者が「次に何をやるか」で迷いにくいです。",
        "Kimini英会話は予習→レッスン→復習の学習サイクルを回しやすく、復習量を確保しやすいです。",
        "Kimini英会話は月額1,210円から始められるため、継続の金銭負担を抑えやすいです。",
      ]
    : [
        `${school?.name ?? "本サービス"}は教材・講師・料金のバランスを見ながら学習を継続しやすいです。`,
        `${school?.name ?? "本サービス"}は無料体験と口コミを先に確認できるため、ミスマッチを減らしやすいです。`,
      ]);

const faqItems: { q: string; a: string }[] =
  schoolId === "kimini"
    ? [
        { q: "Kimini英会話はどんな人に向く？", a: "Kimini英会話は中学英語の基礎からやり直したい人、月額費用を抑えたい人に向きます。" },
        { q: "Kimini英会話に無料体験はある？", a: "Kimini英会話は無料体験10日間を提供します。" },
        { q: "Kimini英会話はTOEIC対策に使える？", a: "Kimini英会話はTOEIC® L&Rテスト講座（Shikaku Pass）無料特典（対象プラン、〜2026-01-31）の案内があります。" },
        { q: "Kimini英会話の強みは何？", a: "Kimini英会話の強みは教材と学習ステップが整理され、迷いにくい点です（口コミより）。" },
      ]
    : [
        { q: `${school?.name ?? "本サービス"}はどんな人に向く？`, a: `${school?.name ?? "本サービス"}は目的と予算に合わせてオンライン英会話を選びたい人に向きます。` },
        { q: `${school?.name ?? "本サービス"}に無料体験はある？`, a: `${school?.name ?? "本サービス"}はプランにより無料体験を提供します（本ページの一覧を参照）。` },
      ];

const jsonLd: any[] = [];
if (school) {
  const baseUrl = new URL(pageUrl);
  const orgUrl = baseUrl.origin;
  const webpageId = `${pageUrl}#webpage`; // matches Layout.astro
  const offerUrl = school.planUrl || school.officialUrl || pageUrl;
  const merchantReturnLink = `${orgUrl}/info/return-policy`;

  // Merchant Listings: digital service (no physical shipping)
  const shippingDetails = [
    {
      "@type": "OfferShippingDetails",
      shippingRate: { "@type": "MonetaryAmount", value: 0, currency: "JPY" },
      shippingDestination: { "@type": "DefinedRegion", addressCountry: "JP" },
      deliveryTime: {
        "@type": "ShippingDeliveryTime",
        handlingTime: { "@type": "QuantitativeValue", minValue: 0, maxValue: 0, unitCode: "DAY" },
        transitTime: { "@type": "QuantitativeValue", minValue: 0, maxValue: 0, unitCode: "DAY" },
      },
    },
  ];

  const hasMerchantReturnPolicy = {
    "@type": "MerchantReturnPolicy",
    applicableCountry: "JP",
    // Digital service: no physical returns; see cancellation/refund policy link.
    returnPolicyCategory: "https://schema.org/MerchantReturnNotPermitted",
    merchantReturnLink,
    inStoreReturnsOffered: false,
  };

  const service: any = {
    // Review Snippet 対象の type に合わせる（Service は対象外になりやすい）
    "@type": "Product",
    "@id": `${pageUrl}#product`,
    name: school.name,
    url: pageUrl,
    description,
    category: "Education",
    mainEntityOfPage: { "@id": webpageId },
  };

  if (logoAbs) {
    service.image = [
      {
        "@type": "ImageObject",
        url: logoAbs,
      },
    ];
  }

  if (minPriceYen) {
    service.offers = {
      "@type": "Offer",
      url: offerUrl,
      priceCurrency: "JPY",
      price: minPriceYen,
      priceValidUntil: DEFAULT_PRICE_VALID_UNTIL,
      priceSpecification: {
        "@type": "UnitPriceSpecification",
        priceCurrency: "JPY",
        minPrice: minPriceYen,
        unitText: "MONTH",
      },
      itemCondition: "https://schema.org/NewCondition",
      availability: "https://schema.org/InStock",
      shippingDetails,
      hasMerchantReturnPolicy,
    };
  } else if (school.priceText) {
    // Keep a human-readable offer snippet even when we can't parse a number
    service.offers = {
      "@type": "Offer",
      url: offerUrl,
      priceCurrency: "JPY",
      description: String(school.priceText),
      priceValidUntil: DEFAULT_PRICE_VALID_UNTIL,
      itemCondition: "https://schema.org/NewCondition",
      availability: "https://schema.org/InStock",
      shippingDetails,
      hasMerchantReturnPolicy,
    };
  }

  if (ratingValue !== null && reviewCount > 0) {
    service.aggregateRating = {
      "@type": "AggregateRating",
      ratingValue,
      reviewCount,
      bestRating: 5,
      worstRating: 1,
    };
  }

  // Attach latest reviews (DB-approved preferred, with static fallback)
  if (displayLatest.length) {
    service.review = displayLatest
      .filter((r) => typeof r.rating === "number" && Number.isFinite(r.rating) && r.rating > 0 && r.body)
      .slice(0, 10)
      .map((r) => {
        const review: any = {
          "@type": "Review",
          author: { "@type": "Person", name: r.label || "ユーザー" },
          reviewBody: r.body,
          reviewRating: { "@type": "Rating", ratingValue: r.rating, bestRating: 5, worstRating: 1 },
        };
        if (r.createdAt) review.datePublished = r.createdAt;
        if (r.improvementPoints) review.negativeNotes = r.improvementPoints;
        return review;
      });
  }

  if (schoolId === "kimini") {
    service.brand = { "@type": "Brand", name: "学研グループ" };
  }

  jsonLd.push(service);
}

if (faqItems.length) {
  jsonLd.push({
    "@type": "FAQPage",
    "@id": `${pageUrl}#faq`,
    mainEntityOfPage: { "@id": `${pageUrl}#webpage` },
    mainEntity: faqItems.map((f) => ({
      "@type": "Question",
      name: f.q,
      acceptedAnswer: { "@type": "Answer", text: f.a },
    })),
  });
}
---

<Layout title={title} description={description}>
  <Fragment slot="head">
    {jsonLd.length ? <script type="application/ld+json" set:html={JSON.stringify({ "@context": "https://schema.org", "@graph": jsonLd })} /> : null}
  </Fragment>

  {!school ? (
    <main class="mx-auto w-full max-w-3xl px-4 pb-14 pt-8">
      <section class="rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
        <h1 class="text-xl font-extrabold text-zinc-900">ページが見つかりません</h1>
        <p class="mt-3 text-sm text-zinc-700">指定されたサービスが見つかりませんでした。</p>
        <div class="mt-4">
          <a class="link-brand font-semibold underline" href="/">TOPへ戻る</a>
        </div>
      </section>
    </main>
  ) : (
    <main id="top" class="mx-auto w-full max-w-6xl px-4 pb-12 pt-6">
      <!-- Hero -->
      <section class="rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-start">
          {school.logoUrl ? (
            <div class="flex h-14 shrink-0 items-center justify-center rounded-xl border border-zinc-200 bg-zinc-50 px-3">
              <img
                src={school.logoUrl}
                alt={`${school.name} ロゴ`}
                width="160"
                height="56"
                loading="eager"
                decoding="async"
                class="h-10 w-auto max-w-[160px] object-contain"
              />
            </div>
          ) : (
            <div class="flex h-14 shrink-0 items-center justify-center rounded-xl border border-zinc-200 bg-zinc-50 px-4 text-sm font-extrabold text-zinc-800">
              LOGO
            </div>
          )}

          <div class="w-full min-w-0 sm:flex-1">
            <div class="flex flex-wrap items-center gap-2">
            <div class="flex min-w-0 max-w-full flex-wrap items-center gap-x-2 gap-y-1 rounded-full bg-zinc-100 px-3 py-1 text-xs font-extrabold text-zinc-700">
              <span class="rounded-full bg-white px-2 py-0.5 text-[11px] font-extrabold text-zinc-700 ring-1 ring-zinc-200">ランキング</span>
              <span class="flex min-w-0 flex-wrap items-center gap-x-2 gap-y-1 text-zinc-700">
                <span class="whitespace-nowrap">{overallRank ? `総合:${overallRank}位` : "総合:—"}</span>
                {typeof businessRank === "number" ? <span class="whitespace-nowrap">{`ビジネス:${businessRank}位`}</span> : null}
                {typeof kidsRank === "number" ? <span class="whitespace-nowrap">{`子供向け:${kidsRank}位`}</span> : null}
              </span>
            </div>

            <div class="flex min-w-0 max-w-full flex-wrap items-center gap-x-2 gap-y-1 rounded-full bg-zinc-100 px-3 py-1 text-xs font-extrabold text-zinc-700">
              <span class="rounded-full bg-white px-2 py-0.5 text-[11px] font-extrabold text-zinc-700 ring-1 ring-zinc-200">無料体験</span>
              <span class="inline-flex min-w-0 items-center gap-2 break-words text-zinc-700">
                <span class="min-w-0 break-words">{trialPill.displayText}</span>
                {trialPill.promoDays != null ? (
                  <span class="inline-flex shrink-0 items-center rounded-full bg-rose-100 px-2 py-0.5 text-[10px] font-extrabold text-rose-700 ring-1 ring-rose-200">
                    増量中
                  </span>
                ) : null}
              </span>
            </div>

            <div class="flex min-w-0 max-w-full flex-wrap items-center gap-x-2 gap-y-1 rounded-full bg-zinc-100 px-3 py-1 text-xs font-extrabold text-zinc-700">
              <span class="rounded-full bg-white px-2 py-0.5 text-[11px] font-extrabold text-zinc-700 ring-1 ring-zinc-200">レッスン満足度</span>
              {ratingValue !== null ? (
                <span class="inline-flex items-center gap-1 leading-none">
                  <span class="shrink-0">
                    <StarRating value={ratingValue} size={12} showValue={false} />
                  </span>
                  <span class="shrink-0 tabular-nums text-zinc-900">{ratingValue.toFixed(1)}</span>
                  <span class="shrink-0 text-zinc-500">（{reviewCount}件）</span>
                </span>
              ) : (
                <span class="text-zinc-500">—</span>
              )}
            </div>

            <div class="flex min-w-0 max-w-full flex-wrap items-center gap-x-2 gap-y-1 rounded-full bg-zinc-100 px-3 py-1 text-xs font-extrabold text-zinc-700">
              <span class="rounded-full bg-white px-2 py-0.5 text-[11px] font-extrabold text-zinc-700 ring-1 ring-zinc-200">最安プラン</span>
              <span class="min-w-0 break-words text-zinc-700">{school.priceText ?? (cheapestPlanYen ? `${cheapestPlanYen}/月` : "—")}</span>
            </div>
            </div>
          </div>
        </div>

        <h1
          class:list={[
            "font-extrabold tracking-tight text-zinc-900",
            school.logoUrl ? "mt-3 text-xl sm:text-2xl" : "mt-4 text-2xl sm:text-3xl",
          ]}
        >
          {school.name}
        </h1>

        <div
          class:list={[
            "mt-4 flex flex-col gap-6",
            school.heroImageUrl ? "lg:grid lg:grid-cols-[1fr_320px] lg:items-stretch" : "lg:grid lg:grid-cols-[1fr_320px] lg:items-start",
          ]}
        >
          <div class="min-w-0 order-1 empty:hidden lg:order-none lg:col-start-1 lg:row-start-1">
            {school.heroImageUrl ? (
              <div class="h-full overflow-hidden rounded-2xl border border-zinc-200 bg-white">
                <img
                  src={preferWebpForKnownPng(school.heroImageUrl)}
                  alt={school.heroImageAlt ?? ""}
                  loading="eager"
                  decoding="async"
                  class="h-full w-full object-contain"
                />
              </div>
            ) : null}
          </div>

          <div class="order-2 lg:order-none lg:col-span-2 lg:col-start-1 lg:row-start-2">
            <p class="whitespace-pre-wrap text-sm font-semibold leading-7 text-zinc-700 sm:text-base">{heroDescription}</p>

            <div class="mt-6 flex flex-wrap gap-3">
              <a
                class="btn-brand inline-flex items-center justify-center rounded-xl px-5 py-3 text-sm font-extrabold text-white shadow-sm hover:opacity-90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-orange-300 focus-visible:ring-offset-2 focus-visible:ring-offset-white"
                href={mainCtaHref}
                target="_blank"
                rel="nofollow sponsored noopener noreferrer"
                referrerpolicy="no-referrer"
              >
                公式サイトを見る
              </a>
              <a
                class="inline-flex items-center justify-center rounded-xl border border-zinc-200 bg-white px-5 py-3 text-sm font-extrabold text-zinc-900 hover:bg-zinc-50"
                href={`/${encodeURIComponent(schoolId)}/reviews`}
              >
                口コミを見る
              </a>
            </div>
          </div>

          <aside class="order-3 h-full rounded-2xl border border-zinc-200 bg-zinc-50 p-3 lg:order-none lg:col-start-2 lg:row-start-1">
            <div class="flex items-end justify-between gap-3">
              <div>
                <div class="text-xs font-extrabold text-zinc-600">総合評価（口コミ{reviewCount}件）</div>
                <div class="mt-1 flex items-end gap-2">
                  <div class="text-xl font-extrabold text-zinc-900">{ratingValue !== null ? ratingValue.toFixed(1) : "—"}</div>
                  <div class="pb-0.5 text-[11px] font-extrabold text-zinc-600">/ 5</div>
                </div>
              </div>
              <div class="text-[10px] font-semibold text-zinc-500">講師/教材/通信/安さ/満足度（5段階）</div>
            </div>

            <div
              id="radar-root"
              class="mt-3"
              data-base={JSON.stringify({
                id: schoolId,
                name: school.name,
                teacherQuality: radarBaseQuality.teacherQuality,
                materialQuality: radarBaseQuality.materialQuality,
                connectionQuality: radarBaseQuality.connectionQuality,
                priceRating: radarBaseQuality.priceRating,
                satisfactionRating: radarBaseQuality.satisfactionRating,
              })}
              data-compare={JSON.stringify(compareOptions)}
            >
              <div class="relative mx-auto aspect-square w-full max-w-[260px]">
                <svg id="radar-svg" viewBox="0 0 220 220" class="h-full w-full">
                  <g id="radar-grid">
                    {[1, 2, 3, 4, 5].map((lv) => (
                      <polygon points={radarGridPoints(lv)} fill="none" stroke="#e4e4e7" stroke-width="1" />
                    ))}
                    {RADAR_AXES.map((_, i) => {
                      const ang = -Math.PI / 2 + (i * 2 * Math.PI) / RADAR_AXES.length;
                      const x2 = RADAR_CX + RADAR_R * Math.cos(ang);
                      const y2 = RADAR_CY + RADAR_R * Math.sin(ang);
                      return <line x1={RADAR_CX} y1={RADAR_CY} x2={x2} y2={y2} stroke="#e4e4e7" stroke-width="1" />;
                    })}
                  </g>

                  <g id="radar-labels">
                    {RADAR_AXES.map((a, i) => {
                      const ang = -Math.PI / 2 + (i * 2 * Math.PI) / RADAR_AXES.length;
                      const x = RADAR_CX + (RADAR_R + 18) * Math.cos(ang);
                      const y = RADAR_CY + (RADAR_R + 18) * Math.sin(ang);
                      return (
                        <text
                          x={x}
                          y={y}
                          text-anchor="middle"
                          dominant-baseline="middle"
                          font-size="10"
                          font-weight="700"
                          fill="#52525b"
                        >
                          {a.label}
                        </text>
                      );
                    })}
                  </g>

                  <polygon
                    id="radar-base"
                    points={radarPoints({
                      teacherQuality: radarBaseQuality.teacherQuality,
                      materialQuality: radarBaseQuality.materialQuality,
                      connectionQuality: radarBaseQuality.connectionQuality,
                      priceRating: radarBaseQuality.priceRating,
                      satisfactionRating: radarBaseQuality.satisfactionRating,
                    })}
                    style="fill: var(--brand-link); fill-opacity: 0.18; stroke: var(--brand-link); stroke-width: 3;"
                  />
                  <polygon
                    id="radar-compare"
                    points={radarPoints(null)}
                    style="fill: #ec4899; fill-opacity: 0.10; stroke: #ec4899; stroke-width: 3; stroke-dasharray: 4 3; opacity: 0;"
                  />
                </svg>
              </div>

              <div class="mt-2 grid gap-2">
                <label class="block">
                  <div class="text-xs font-extrabold text-zinc-700">他サービスと比較</div>
                  <select
                    id="radar-compare-select"
                    class="mt-1 w-full rounded-lg border border-zinc-200 bg-white px-3 py-2 text-xs font-semibold text-zinc-900 shadow-sm"
                  >
                    <option value="">比較しない</option>
                    {compareOptions.map((s) => (
                      <option
                        value={s.id}
                        data-tq={typeof s.teacherQuality === "number" ? String(s.teacherQuality) : ""}
                        data-mq={typeof s.materialQuality === "number" ? String(s.materialQuality) : ""}
                        data-cq={typeof s.connectionQuality === "number" ? String(s.connectionQuality) : ""}
                        data-pr={typeof s.priceRating === "number" ? String(s.priceRating) : ""}
                        data-sr={typeof s.satisfactionRating === "number" ? String(s.satisfactionRating) : ""}
                      >
                        {s.name}
                      </option>
                    ))}
                  </select>
                </label>

                <div class="flex flex-wrap items-center justify-between gap-2 text-[10px] font-semibold text-zinc-600">
                  <span class="inline-flex items-center gap-2">
                    <span class="inline-block h-2.5 w-2.5 rounded-sm bg-[color:var(--brand-link)]"></span>
                    このサービス
                  </span>
                  <span class="inline-flex items-center gap-2">
                    <span class="inline-block h-2.5 w-2.5 rounded-sm border border-pink-500 bg-pink-500"></span>
                    比較サービス
                  </span>
                </div>
              </div>
            </div>
          </aside>
        </div>
      </section>

      {prSections.length ? (
        <section class="mt-6 overflow-hidden rounded-2xl border border-[3px] border-pink-200 bg-white shadow-sm">
          <div class="border-b border-b-[3px] border-pink-200 bg-zinc-50 p-6">
            <div class="flex items-center gap-3">
              <span class="inline-flex items-center rounded-lg bg-pink-100 px-2 py-1 text-[11px] font-extrabold text-pink-700 ring-1 ring-pink-200">
                PR
              </span>
              <h2 class="text-lg font-extrabold text-zinc-900">{school.prSectionTitle ?? "PR"}</h2>
            </div>
            <p class="mt-1 text-sm font-semibold text-zinc-600">公式情報・機能・実績など、特徴が伝わるポイントをまとめました。</p>
          </div>
          <div class="divide-y divide-zinc-200">
            {prSections.slice(0, 5).map((sec) => {
              const reverse = !!sec.reverse;
              const hasIconUrl = typeof sec.iconUrl === "string" && sec.iconUrl.trim().length > 0;
              const hasIconText = typeof sec.iconText === "string" && sec.iconText.trim().length > 0;
              const img = sec.image ?? null;
              const isYoutube = img && "youtube" in img;
              const youtubeUrl = isYoutube ? String((img as PrYoutube).youtube ?? "") : null;
              const youtubeId = isYoutube ? getYoutubeId(youtubeUrl) : null;
              const hasImg = img && !isYoutube && typeof (img as PrMedia).src === "string" && (img as PrMedia).src.trim().length > 0;

              return (
                <div class="p-6">
                  <div class="flex items-center gap-3">
                    {hasIconUrl ? (
                      <img
                        src={String(sec.iconUrl)}
                        alt=""
                        width="22"
                        height="22"
                        loading="lazy"
                        decoding="async"
                        class="h-6 w-6 rounded-md object-contain"
                      />
                    ) : hasIconText ? (
                      <span class="inline-flex h-6 w-6 items-center justify-center rounded-md bg-orange-50 text-sm font-extrabold text-orange-700 ring-1 ring-orange-200">
                        {String(sec.iconText).slice(0, 2)}
                      </span>
                    ) : (
                      <span class="inline-flex h-6 w-6 items-center justify-center rounded-md bg-orange-50 text-sm font-extrabold text-orange-700 ring-1 ring-orange-200">
                        ✓
                      </span>
                    )}
                    <h3 class="text-base font-extrabold text-zinc-900">{sec.title}</h3>
                  </div>

                  <div class="mt-4 flex flex-col gap-4 md:flex-row-reverse md:items-start md:gap-6">
                    {isYoutube && youtubeId ? (
                      <div class="w-full md:w-[280px] md:shrink-0">
                        <a
                          href={youtubeUrl ?? `https://www.youtube.com/watch?v=${youtubeId}`}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="group block overflow-hidden rounded-lg shadow-sm ring-1 ring-zinc-200"
                        >
                          <div class="relative aspect-video w-full bg-black">
                            <img
                              src={`https://i.ytimg.com/vi_webp/${youtubeId}/hqdefault.webp`}
                              alt={(img as PrYoutube).title ?? "YouTube動画"}
                              loading="lazy"
                              decoding="async"
                              class="h-full w-full object-cover transition-opacity group-hover:opacity-90"
                            />
                            <div class="pointer-events-none absolute inset-0 flex items-center justify-center">
                              <span class="inline-flex items-center justify-center rounded-full bg-black/70 px-4 py-2 text-xs font-extrabold text-white">
                                ▶ 動画を再生（YouTube）
                              </span>
                            </div>
                          </div>
                        </a>
                      </div>
                    ) : hasImg ? (
                      <div class="w-full md:w-[280px] md:shrink-0">
                        <img
                          src={String((img as PrMedia).src)}
                          alt={((img as PrMedia).alt ?? "") as string}
                          loading="lazy"
                          decoding="async"
                          width={typeof (img as PrMedia).width === "number" ? String((img as PrMedia).width) : undefined}
                          height={typeof (img as PrMedia).height === "number" ? String((img as PrMedia).height) : undefined}
                          class="h-auto w-full rounded-lg object-cover shadow-sm"
                        />
                      </div>
                    ) : null}
                    <div class="flex-1 whitespace-pre-wrap text-[13px] leading-relaxed text-zinc-600">{sec.body}</div>
                  </div>
                </div>
              );
            })}
          </div>
        </section>
      ) : null}

      <!-- Summary -->
      <section class="mt-6 rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
        <h2 class="text-lg font-extrabold text-zinc-900">{school.tagsSectionTitle ?? "おすすめの人・特徴（キーワード）"}</h2>
        <p class="mt-1 text-sm text-zinc-600">{school.tagsSectionSubtitle ?? "気になるキーワードから、サービスの相性をチェックできます。"}</p>
        {recommendedTags.length || featureTags.length ? (
          <div class="mt-4 grid gap-4 sm:grid-cols-2">
            <div>
              <div class="text-xs font-extrabold text-zinc-700">{school.recommendedTagsTitle ?? "こんな人におすすめ"}</div>
              {recommendedTagsRaw.length ? (
                <ul class="mt-2 space-y-2">
                  {recommendedTagsRaw.map((t) => (
                    <li class="flex items-start gap-2 text-xs font-bold leading-relaxed text-zinc-700">
                      <span class="mt-0.5 text-emerald-500">✔</span>
                      <span>{t}</span>
                    </li>
                  ))}
                </ul>
              ) : (
                <div class="mt-2 text-xs font-semibold text-zinc-500">準備中</div>
              )}
            </div>

            <div>
              <div class="text-xs font-extrabold text-zinc-700">{school.featureTagsTitle ?? "特徴"}</div>
              {featureTags.length ? (
                <div class="mt-2 flex flex-wrap gap-2">
                  {featureTags.map((t) => (
                    <span class="inline-flex items-center rounded-full border border-indigo-200 bg-indigo-50 px-3 py-1 text-xs font-extrabold text-indigo-900">
                      {t}
                    </span>
                  ))}
                </div>
              ) : (
                <div class="mt-2 text-xs font-semibold text-zinc-500">準備中</div>
              )}
            </div>
          </div>
        ) : (
          <p class="mt-2 text-sm font-semibold text-zinc-700">{bluf}</p>
        )}
      </section>

      <script is:inline>
(function () {
  var root = document.getElementById("radar-root");
  if (!root) return;

  var cmpPoly = root.querySelector("#radar-compare");
  var select = root.querySelector("#radar-compare-select");
  if (!cmpPoly) return;

  var cx = 110, cy = 110, R = 78;
  var axes = [
    { key: "teacherQuality", label: "講師" },
    { key: "materialQuality", label: "教材" },
    { key: "connectionQuality", label: "通信" },
    { key: "priceRating", label: "安さ" },
    { key: "satisfactionRating", label: "満足度" }
  ];

  function clamp01(v) {
    if (v === null || v === undefined) return 0;
    var n = Number(v);
    if (!isFinite(n)) return 0;
    if (n < 0) return 0;
    if (n > 5) return 5;
    return n;
  }

  function pointsFor(model, scale) {
    var pts = [];
    for (var i = 0; i < axes.length; i++) {
      var ang = -Math.PI / 2 + (i * 2 * Math.PI) / axes.length;
      var val = clamp01(model ? model[axes[i].key] : 0);
      var rr = (R * (val / 5)) * scale;
      var x = cx + rr * Math.cos(ang);
      var y = cy + rr * Math.sin(ang);
      pts.push(x.toFixed(1) + "," + y.toFixed(1));
    }
    return pts.join(" ");
  }
  function renderCompare(cmpModel) {
    if (cmpModel) {
      cmpPoly.setAttribute("points", pointsFor(cmpModel, 1));
      cmpPoly.style.opacity = "1";
    } else {
      cmpPoly.style.opacity = "0";
    }
  }

  function readCompareFromSelect(sel) {
    if (!sel) return null;
    var opt = sel.options && sel.selectedIndex >= 0 ? sel.options[sel.selectedIndex] : null;
    var tq = opt && opt.dataset ? opt.dataset.tq : "";
    var mq = opt && opt.dataset ? opt.dataset.mq : "";
    var cq = opt && opt.dataset ? opt.dataset.cq : "";
    var pr = opt && opt.dataset ? opt.dataset.pr : "";
    var sr = opt && opt.dataset ? opt.dataset.sr : "";
    var hasAny = (tq !== "" || mq !== "" || cq !== "" || pr !== "" || sr !== "");
    return hasAny ? {
      teacherQuality: Number(tq || 0),
      materialQuality: Number(mq || 0),
      connectionQuality: Number(cq || 0),
      priceRating: Number(pr || 0),
      satisfactionRating: Number(sr || 0)
    } : null;
  }

  // Initial render: if a compare option is already selected (bfcache/back/restore), show it.
  renderCompare(readCompareFromSelect(select));

  if (select) {
    select.addEventListener("change", function () {
      renderCompare(readCompareFromSelect(select));
    });
  }
})();
      </script>

      <!-- Key facts -->
      <section class="mt-6 rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
        <h2 class="text-lg font-extrabold text-zinc-900">{school.keyFactsSectionTitle ?? "料金・無料体験・評価の一覧"}</h2>
        <p class="mt-1 text-sm text-zinc-600">{school.keyFactsSectionSubtitle ?? "比較しやすいよう、主要データを1表にまとめています。"}</p>
        <div class="mt-4 overflow-x-auto rounded-2xl border border-zinc-200 bg-white">
          <table class="w-full table-fixed border-separate border-spacing-0" style="min-width:720px">
            <colgroup>
              <col style="width:220px" />
              <col style="width:500px" />
            </colgroup>
            <tbody class="align-top">
              {entityRows.map((row, idx) => (
                <tr>
                  <th class:list={["px-4 py-3 text-left text-sm font-extrabold text-zinc-700 bg-zinc-100", idx ? "border-t border-zinc-200" : ""]}>
                    {row.k}
                  </th>
                  <td class:list={["px-4 py-3 text-sm font-semibold text-zinc-900", idx ? "border-t border-zinc-200" : ""]}>
                    {row.v}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </section>

      <!-- Basic data -->
      <section class="mt-6 rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
        <h2 class="text-lg font-extrabold text-zinc-900">{school.basicDataSectionTitle ?? "基本データ"}</h2>
        <div class="mt-4 overflow-x-auto rounded-2xl border border-zinc-200 bg-white">
          <table class="w-full table-fixed border-separate border-spacing-0" style="min-width:720px">
            <colgroup>
              <col style="width:200px" />
              <col style="width:520px" />
            </colgroup>
            <tbody class="align-top">
              <tr>
                <th class="bg-zinc-100 px-4 py-3 text-left text-sm font-extrabold text-zinc-700">月額料金</th>
                <td class="px-4 py-3 text-sm font-semibold text-zinc-900">{school.priceText ?? "—"}</td>
              </tr>
              <tr>
                <th class="border-t border-zinc-200 bg-zinc-100 px-4 py-3 text-left text-sm font-extrabold text-zinc-700">無料体験</th>
                <td class="border-t border-zinc-200 px-4 py-3 text-sm font-semibold text-zinc-900">{school.trialText ?? "—"}</td>
              </tr>
              <tr>
                <th class="border-t border-zinc-200 bg-zinc-100 px-4 py-3 text-left text-sm font-extrabold text-zinc-700">レッスン回数</th>
                <td class="border-t border-zinc-200 px-4 py-3 text-sm font-semibold text-zinc-900">—</td>
              </tr>
              <tr>
                <th class="border-t border-zinc-200 bg-zinc-100 px-4 py-3 text-left text-sm font-extrabold text-zinc-700">対象年齢</th>
                <td class="border-t border-zinc-200 px-4 py-3 text-sm font-semibold text-zinc-900">—</td>
              </tr>
              <tr>
                <th class="border-t border-zinc-200 bg-zinc-100 px-4 py-3 text-left text-sm font-extrabold text-zinc-700">講師の質</th>
                <td class="border-t border-zinc-200 px-4 py-3 text-sm font-semibold text-zinc-900">
                  {typeof school.teacherQuality === "number" ? `${school.teacherQuality} / 5` : "—"}
                </td>
              </tr>
              <tr>
                <th class="border-t border-zinc-200 bg-zinc-100 px-4 py-3 text-left text-sm font-extrabold text-zinc-700">教材の質</th>
                <td class="border-t border-zinc-200 px-4 py-3 text-sm font-semibold text-zinc-900">
                  {typeof school.materialQuality === "number" ? `${school.materialQuality} / 5` : "—"}
                </td>
              </tr>
              <tr>
                <th class="border-t border-zinc-200 bg-zinc-100 px-4 py-3 text-left text-sm font-extrabold text-zinc-700">通信の質</th>
                <td class="border-t border-zinc-200 px-4 py-3 text-sm font-semibold text-zinc-900">
                  {typeof school.connectionQuality === "number" ? `${school.connectionQuality} / 5` : "—"}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- How it works -->
      <section class="mt-6 rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
        <h2 class="text-lg font-extrabold text-zinc-900">{school.methodologySectionTitle ?? "学習が続く理由（学習設計）"}</h2>
        <p class="mt-1 text-sm text-zinc-600">{school.methodologySectionSubtitle ?? "ポイントを「結論→根拠」の順に整理して、初めてでもわかりやすくしています。"}</p>
        <ul class="mt-3 list-disc space-y-2 pl-5 text-sm font-semibold text-zinc-700">
          {methodology.map((t) => (
            <li>{stripLeadingBullet(t)}</li>
          ))}
        </ul>
      </section>

      {introPlacement !== "hero" && introSections.length ? (
        <section class="mt-6 rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
          <h2 class="text-lg font-extrabold text-zinc-900">{school.introSectionTitle ?? "紹介"}</h2>
          <div class="mt-4 space-y-6">
            {introSections.map((sec) => {
              const reverse = !!sec.reverse;
              const wide = sec.wideMedia ?? null;
              const side = sec.sideMedia ?? null;
              return (
                <div class="rounded-2xl border border-zinc-200 bg-white p-4 shadow-sm">
                  {wide && wide.type === "image" && isNonEmptyString(wide.src) ? (
                    <div class="mb-4">
                      <img
                        src={wide.src}
                        alt={wide.alt ?? ""}
                        loading="lazy"
                        decoding="async"
                        width={typeof wide.width === "number" ? String(wide.width) : undefined}
                        height={typeof wide.height === "number" ? String(wide.height) : undefined}
                        class="h-auto w-full rounded-xl border border-zinc-200 bg-white object-contain"
                      />
                    </div>
                  ) : null}
                  {wide && wide.type === "iframe" && isNonEmptyString(wide.src) ? (
                    <div class="mb-4">
                      <div class="aspect-video w-full overflow-hidden rounded-xl border border-zinc-200 bg-black">
                        <iframe
                          src={wide.src}
                          class="h-full w-full"
                          loading="lazy"
                          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                          allowfullscreen={true}
                          referrerpolicy="no-referrer"
                          title="embed"
                        />
                      </div>
                    </div>
                  ) : null}
                  <div class:list={["grid gap-4", side ? "lg:grid-cols-[1fr_240px]" : "", reverse ? "lg:[direction:rtl]" : ""]}>
                    <div class:list={["min-w-0", reverse ? "lg:[direction:ltr]" : ""]}>
                      <h3 class="text-base font-extrabold text-zinc-900">{sec.title}</h3>
                      <p class="mt-2 text-sm font-semibold leading-7 text-zinc-700 whitespace-pre-wrap">{sec.body}</p>
                    </div>
                    {side && side.type === "image" && isNonEmptyString(side.src) ? (
                      <div class:list={reverse ? "lg:[direction:ltr]" : ""}>
                        <img
                          src={side.src}
                          alt={side.alt ?? ""}
                          loading="lazy"
                          decoding="async"
                          width={typeof side.width === "number" ? String(side.width) : undefined}
                          height={typeof side.height === "number" ? String(side.height) : undefined}
                          class="h-auto w-full rounded-xl border border-zinc-200 bg-white object-contain"
                        />
                      </div>
                    ) : null}
                    {side && side.type === "iframe" && isNonEmptyString(side.src) ? (
                      <div class:list={reverse ? "lg:[direction:ltr]" : ""}>
                        <div class="aspect-video w-full overflow-hidden rounded-xl border border-zinc-200 bg-black">
                          <iframe
                            src={side.src}
                            class="h-full w-full"
                            loading="lazy"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen={true}
                            referrerpolicy="no-referrer"
                            title="embed"
                          />
                        </div>
                      </div>
                    ) : null}
                  </div>
                </div>
              );
            })}
          </div>
        </section>
      ) : null}

      <!-- Feature section -->
      <section class="mt-6 rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
        <h2 class="text-lg font-extrabold text-zinc-900">
          {school.featureSectionTitle ?? (schoolId === "kimini" ? "特徴（学研メソッド）" : "特徴")}
        </h2>
        {schoolId === "kimini" ? (
          <div class="mt-3 space-y-3 text-sm text-zinc-700">
            <p>
              Kimini英会話は学研グループが運営するオンライン英会話です。学研メソッドの考え方をベースに、教材と学習ステップが整理されているため、
              「何を・どの順番で・どれくらい」学ぶかが分かりやすいのが特徴です。
            </p>
            <ul class="list-disc pl-5">
              <li>目的に合うコースを選びやすい（基礎〜目的別）</li>
              <li>学習サイクル（予習→レッスン→復習）を回しやすい</li>
              <li>教材が体系化されていて、迷いにくい</li>
            </ul>
          </div>
        ) : (
          <div class="mt-3 space-y-3 text-sm text-zinc-700">
            <p>{school.summary}</p>
            {school.features?.length ? (
              <ul class="list-disc pl-5">
                {school.features.slice(0, 6).map((t: string) => (
                  <li>{stripLeadingBullet(t)}</li>
                ))}
              </ul>
            ) : null}
          </div>
        )}
      </section>

      {school.uniquenessBullets?.length ? (
        <section class="mt-6">
          <div class="rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
            <h2 class="text-lg font-extrabold text-zinc-900">{school.uniquenessTitle ?? "独自性（他社との違い）"}</h2>
            <ul class="mt-3 list-disc space-y-2 pl-5 text-sm font-semibold text-zinc-700">
              {school.uniquenessBullets.slice(0, 6).map((t: string) => (
                <li>{stripLeadingBullet(t)}</li>
              ))}
            </ul>
          </div>
        </section>
      ) : null}

      <!-- Reviews -->
      <section class="mt-6 rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
        <div class="flex flex-wrap items-end justify-between gap-3">
          <div>
            <h2 class="text-lg font-extrabold text-zinc-900">{school.reviewsSectionTitle ?? "口コミ・評判"}</h2>
            <p class="mt-1 text-sm text-zinc-600">{school.reviewsSectionSubtitle ?? "総合評価と最新の口コミを確認できます。"}</p>
          </div>
          <a
            class="inline-flex items-center justify-center rounded-xl bg-[color:var(--brand-link)] px-4 py-2.5 text-sm font-extrabold text-white shadow-sm hover:opacity-90 transition-opacity"
            href={`/${encodeURIComponent(schoolId)}/reviews`}
          >
            もっと口コミを見る →
          </a>
        </div>

        <div class="mt-4 rounded-2xl border border-zinc-200 bg-zinc-50 p-4">
          <div class="text-xs font-extrabold text-zinc-700">総合評価</div>
          <div class="mt-1 flex flex-wrap items-center gap-3">
            <StarRating value={ratingValue} size={18} />
            <div class="text-sm font-extrabold text-zinc-900">
              {ratingValue ? `${ratingValue} / 5` : "—"}
              <span class="ml-2 text-xs font-semibold text-zinc-500">（口コミ{reviewCount}件）</span>
            </div>
          </div>
          {dbEnvError ? (
            <div class="mt-2 text-xs font-semibold text-rose-700">DB未設定のため、口コミ（ユーザー投稿）の集計が一部表示できません。</div>
          ) : null}

        </div>

        {displayLatest.length ? (
          <div class="mt-4 grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
            {displayLatest.map((r) => (
              <article class="rounded-xl border border-zinc-200 bg-white p-4">
                <div class="flex items-center justify-between gap-3">
                  <div class="text-xs font-extrabold text-zinc-700">
                    {r.label}
                    {r.studyPeriod && <span class="ml-1 text-[10px] font-normal text-zinc-500">(学習期間 {r.studyPeriod})</span>}
                  </div>
                  <StarRating value={r.rating} showValue={false} size={16} />
                </div>
                <p class="mt-2 text-sm leading-relaxed text-zinc-700">{r.body}</p>
              </article>
            ))}
          </div>
        ) : (
          <p class="mt-3 text-sm text-zinc-600">まだ口コミがありません。</p>
        )}
      </section>

      <!-- Voices -->
      <section class="mt-6 rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
        <h2 class="text-lg font-extrabold text-zinc-900">利用者の声（最新口コミ）</h2>
        <p class="mt-1 text-sm text-zinc-600">当サイトで収集した口コミから、最新の内容を掲載します。</p>
        {displayLatest.length ? (
          <ul class="mt-4 space-y-3">
            {displayLatest.map((r) => (
              <li class="rounded-xl border border-zinc-200 bg-zinc-50 p-4">
                <div class="flex flex-wrap items-center justify-between gap-3">
                  <div class="text-xs font-extrabold text-zinc-800">
                    {r.label}
                    {r.studyPeriod && <span class="ml-1 text-[10px] font-normal text-zinc-500">(学習期間 {r.studyPeriod})</span>}
                  </div>
                  <div class="flex items-center gap-2">
                    <StarRating value={r.rating} showValue={false} size={16} />
                    <span class="text-xs font-extrabold text-zinc-700">{r.rating.toFixed(1)} / 5</span>
                  </div>
                </div>
                <div class="mt-2 text-sm font-semibold leading-relaxed text-zinc-700">{r.body}</div>
              </li>
            ))}
          </ul>
        ) : (
          <p class="mt-3 text-sm text-zinc-600">まだ口コミがありません。</p>
        )}
      </section>

      <!-- FAQ -->
      <section class="mt-6 rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
        <h2 class="text-lg font-extrabold text-zinc-900">よくある質問</h2>
        <p class="mt-1 text-sm text-zinc-600">質問→結論の順で、迷いやすいポイントを短く整理しています。</p>
        <dl class="mt-4 space-y-4">
          {faqItems.map((f) => (
            <div class="rounded-xl border border-zinc-200 bg-white p-4">
              <dt class="text-sm font-extrabold text-zinc-900">Q. {f.q}</dt>
              <dd class="mt-2 text-sm font-semibold leading-relaxed text-zinc-700">A. {f.a}</dd>
            </div>
          ))}
        </dl>
      </section>
    </main>
  )}
</Layout>

