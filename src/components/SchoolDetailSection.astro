---
import CTAButton from "./CTAButton.astro";
import StarRating from "./StarRating.astro";
import ReviewList from "./ReviewList.astro";
import Countdown from "./Countdown.astro";
import { getReviewStats } from "../utils/reviewStats";

type Review = { age: string; rating: number; body: string };

type School = {
  name: string;
  rating?: number | null;
  logoUrl?: string | null;
  officialUrl: string;
  planUrl?: string | null;
  bannerImage?: string | null;
  bannerAlt?: string | null;
  bannerHref?: string | null;
  trialText?: string | null;
  trialDetailText?: string | null;
  hoursText?: string | null;
  teacherQuality?: number | null;
  recommendedFor?: string[];
  editorialComments?: string[];
  campaignText?: string | null;
  campaignBullets?: string[];
  campaignEndsAt?: string | null;
};

type Props = {
  rank: number;
  offerId: string;
  item: School;
  reviews?: Review[];
  reviewStats?: { count: number; avg: number | null } | null;
};

const { rank, offerId, item, reviews = [], reviewStats = null } = Astro.props satisfies Props;

const quality = typeof item.teacherQuality === "number" ? item.teacherQuality : null;
const planHref = item.planUrl || item.officialUrl;
const bannerHref = item.bannerHref || planHref;
const stats = reviewStats ?? getReviewStats(reviews);

const trackHref = (href: string) =>
  href.startsWith("http://") || href.startsWith("https://")
    ? `/api/track/click?offer_id=${encodeURIComponent(offerId)}&to=${encodeURIComponent(href)}`
    : href;
---

<section class={`rank-card relative rounded-3xl border border-zinc-200 bg-white p-5 shadow-sm sm:p-6 ${rank === 1 ? "rank-card--sparkle" : ""}`}>
  <div class="flex flex-wrap items-start justify-between gap-4">
    <div class="flex items-start gap-4">
      {rank <= 3 ? (
        <div class={`rank-badge shrink-0 ${rank === 1 ? "rank-badge--hero" : ""}`}>
          <img
            src={`/rank${rank}.webp`}
            alt={`${rank}位`}
            width="56"
            height="56"
            loading="eager"
            decoding="async"
            class="h-14 w-14 object-contain"
          />
        </div>
      ) : (
        <div class="grid h-14 w-14 shrink-0 place-items-center rounded-2xl bg-zinc-50 text-xl font-extrabold text-zinc-800 ring-1 ring-zinc-200">
          {rank}
        </div>
      )}
      <div class="min-w-0">
        <h3 class="text-xl font-extrabold text-zinc-900">
          <a
            href={`/${encodeURIComponent(offerId)}/`}
            class="hover:underline hover:decoration-zinc-300 hover:underline-offset-4"
            aria-label={`${item.name}の詳細ページへ`}
          >
            {item.name}
          </a>
        </h3>
        <div class="mt-2 flex flex-wrap items-center gap-3">
          <span class="text-sm font-extrabold text-zinc-700">総合評価</span>
          <StarRating value={stats.avg} />
          {typeof stats.avg === "number" ? <span class="text-sm font-extrabold text-zinc-900">{stats.avg.toFixed(1)}pt</span> : null}
          <span class="text-sm font-semibold text-zinc-500">
            {stats.count ? `（口コミ${stats.count}件）` : "（口コミなし）"}
          </span>
        </div>
      </div>
    </div>

    {item.logoUrl ? (
      <img src={item.logoUrl} alt={`${item.name} ロゴ`} class="h-12 w-auto max-w-[200px] object-contain" loading="lazy" decoding="async" />
    ) : null}
  </div>

  {item.bannerImage ? (
    <a
      href={trackHref(bannerHref)}
      target={bannerHref.startsWith("http") ? "_blank" : undefined}
      rel={bannerHref.startsWith("http") ? "nofollow sponsored noopener noreferrer" : undefined}
      referrerpolicy={bannerHref.startsWith("http") ? "no-referrer" : undefined}
      class="mt-5 block overflow-hidden rounded-2xl border border-zinc-200 bg-zinc-50"
    >
      <img
        src={item.bannerImage}
        alt={item.bannerAlt ?? `${item.name} バナー`}
        loading="lazy"
        decoding="async"
        class="h-auto w-full object-contain"
      />
    </a>
  ) : null}

  <div class="mt-5 overflow-x-auto">
    <table class="min-w-[520px] w-full overflow-hidden rounded-2xl ring-1 ring-zinc-200">
      <thead>
        <tr class="bg-zinc-50 text-left text-xs font-extrabold text-zinc-700">
          <th class="p-3">講師の質</th>
          <th class="p-3">無料体験</th>
          <th class="p-3">受講可能時間</th>
        </tr>
      </thead>
      <tbody class="text-sm text-zinc-800">
        <tr class="[&_td]:border-t [&_td]:border-zinc-200">
          <td class="p-3">
            <StarRating value={quality} label="講師の質" showValue={false} size={16} />
          </td>
          <td class="p-3">
            <div class="font-extrabold text-zinc-900">{item.trialText ?? "—"}</div>
            {item.trialDetailText ? <div class="text-sm text-zinc-700">{item.trialDetailText}</div> : null}
          </td>
          <td class="p-3">
            <div class="font-extrabold text-zinc-900">{item.hoursText ?? "—"}</div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="mt-5 grid gap-4 sm:grid-cols-2">
    <div class="rounded-2xl border border-zinc-200 bg-zinc-50 p-4">
      <div class="text-sm font-extrabold text-zinc-900">こんな人におすすめ</div>
      {item.recommendedFor?.length ? (
        <ul class="mt-3 list-disc pl-5 text-sm text-zinc-800">
          {item.recommendedFor.slice(0, 6).map((t) => (
            <li>{t}</li>
          ))}
        </ul>
      ) : (
        <div class="mt-2 text-sm text-zinc-500">準備中</div>
      )}
      <div class="mt-4">
        <CTAButton href={planHref} offerId={offerId} label="プランと料金を詳しくチェック" />
      </div>
    </div>

    <div class="rounded-2xl border border-zinc-200 bg-white p-4">
      <div class="text-sm font-extrabold text-zinc-900">編集部のコメント</div>
      {item.editorialComments?.length ? (
        <ul class="mt-3 list-disc pl-5 text-sm text-zinc-800">
          {item.editorialComments.slice(0, 6).map((t) => (
            <li>{t}</li>
          ))}
        </ul>
      ) : (
        <div class="mt-2 text-sm text-zinc-500">準備中</div>
      )}
      <div class="mt-4">
        <CTAButton href={item.officialUrl} offerId={offerId} label="公式サイトを見る" />
      </div>
    </div>
  </div>

  {reviews.length ? (
    <div class="mt-5">
      <ReviewList title={`${item.name}の口コミ・評判`} items={reviews} />
      <div class="mt-3 flex flex-wrap items-center justify-end gap-2">
        <a
          href={`/${encodeURIComponent(offerId)}/reviews`}
          class="text-xs font-semibold text-[color:var(--brand-link)] underline decoration-[#aebcff] underline-offset-2 hover:text-[color:var(--brand-link-hover)]"
        >
          口コミをもっと見る →
        </a>
      </div>
    </div>
  ) : null}

  {(item.campaignText || (item.campaignBullets && item.campaignBullets.length) || item.campaignEndsAt) ? (
    <div class="mt-5 grid gap-3">
      <Countdown endsAt={item.campaignEndsAt ?? null} />
      <div class="rounded-2xl border border-[#c9d4ff] bg-[#eef3ff] p-4">
        <div class="text-sm font-extrabold text-[#2f46b6]">期間限定キャンペーン</div>
        {item.campaignBullets?.length ? (
          <ul class="mt-2 list-disc pl-5 text-sm text-[#2f46b6]/90">
            {item.campaignBullets.slice(0, 6).map((t) => (
              <li>{t}</li>
            ))}
          </ul>
        ) : item.campaignText ? (
          <p class="mt-2 text-sm text-[#2f46b6]/90">{item.campaignText}</p>
        ) : null}
        <div class="mt-4">
          <CTAButton href={item.officialUrl} offerId={offerId} label="無料体験レッスンを受ける" />
        </div>
      </div>
    </div>
  ) : null}
</section>

<style>
  .rank-badge {
    position: relative;
    display: grid;
    place-items: center;
    width: 3.5rem; /* 56px */
    height: 3.5rem;
  }

  /* Disable the extra glow layer around the #1 badge */
  .rank-badge--hero::before {
    content: none;
  }

  .rank-badge--hero img {
    position: relative;
    z-index: 1;
    transform: scale(1.08);
    filter: none;
  }

  .rank-card--sparkle {
    /* Keep the sparkle above background but below content */
    isolation: isolate;
  }

  .rank-card--sparkle::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: 1.5rem; /* matches rounded-3xl */
    padding: 2px; /* border thickness */
    background: conic-gradient(
      from var(--sparkle-rot, 0deg),
      rgba(255, 215, 0, 0) 0deg,
      rgba(255, 215, 0, 0.95) 35deg,
      rgba(255, 255, 255, 0.95) 55deg,
      rgba(255, 215, 0, 0.85) 75deg,
      rgba(255, 215, 0, 0) 110deg,
      rgba(255, 215, 0, 0) 360deg
    );
    /* Show only the border ring */
    -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    pointer-events: none;
    z-index: 0;
    filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.35));
    opacity: 0.95;
    /* animation removed (static highlight) */
  }

  .rank-card--sparkle::after {
    content: "";
    position: absolute;
    inset: -6px;
    border-radius: 1.65rem;
    pointer-events: none;
    z-index: 0;
    opacity: 0.6;
    background: radial-gradient(circle at 20% 10%, rgba(255, 255, 255, 0.75), rgba(255, 255, 255, 0) 35%),
      radial-gradient(circle at 85% 30%, rgba(255, 215, 0, 0.65), rgba(255, 215, 0, 0) 40%),
      radial-gradient(circle at 40% 95%, rgba(255, 215, 0, 0.55), rgba(255, 215, 0, 0) 45%);
    filter: blur(0.5px);
    /* animation removed (static highlight) */
  }

  .rank-card--sparkle > * {
    position: relative;
    z-index: 1;
  }

  /* sparkle keyframes removed: animation disabled */

</style>

