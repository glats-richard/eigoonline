---
import CTAButton from "./CTAButton.astro";
import StarRating from "./StarRating.astro";

type School = {
  name: string;
  logoUrl?: string | null;
  officialUrl: string;
  rating?: number | null;
  teacherQuality?: number | null;
  materialQuality?: number | null;
  connectionQuality?: number | null;
  priceRating?: number | null;
  satisfactionRating?: number | null;
  priceText?: string | null;
  hoursText?: string | null;
  trialText?: string | null;
  trialMaxDays?: number | null;
	trialMaxLessons?: number | null;
  trialPromoMaxDays?: number | null;
  trialPromoMaxLessons?: number | null;
  trialDetailText?: string | null;
  benefitText?: string | null;
  campaignText?: string | null;
  campaignEndsAt?: string | null;
  points?: string[];
  recommendedFor?: string[];
};

type Ranking = {
  title: string;
  items: { id: string; data: School }[];
};

type Props = {
  ranking: Ranking;
  /** "table" for desktop, "stack" for mobile */
  variant?: "table" | "stack";
};

const { ranking, variant = "table" } = Astro.props satisfies Props;

const cols = Math.max(1, ranking.items.length);
const firstColWidth = 140;
const serviceColWidth = 220;
const tableMinWidth = cols >= 2 ? `${firstColWidth + cols * serviceColWidth}px` : "0px";

const colBorder = (rank: number) => {
  if (rank === 1) return "#f5c542";
  if (rank === 2) return "#bdbdbd";
  if (rank === 3) return "#c79a6b";
  return "#9fd6ff";
};

const labelBar = "bg-zinc-100 text-zinc-700";

const fmtScore = (v: number) => {
  const rounded = Math.round(v * 2) / 2;
  const s = rounded.toFixed(1);
  return s.endsWith(".0") ? s.slice(0, -2) : s;
};

const gaugeWidthPct = (v: number) => Math.max(0, Math.min(100, (v / 5) * 100));

const fmtYen = (yen: number) =>
  new Intl.NumberFormat("ja-JP", { maximumFractionDigits: 0 }).format(yen) + "円";

const parseMinMonthlyYen = (s: string | null | undefined): number | null => {
  if (!s) return null;
  // Extract the first "xxxx円" amount as the minimum price.
  // Examples: "月額1,210円から" / "7,425円" / "4,800円"
  const m = s.replace(/,/g, "").match(/(\d{3,})\s*円/);
  if (!m) return null;
  const n = Number(m[1]);
  return Number.isFinite(n) ? n : null;
};

const parseMaxDays = (a: string | null | undefined, b: string | null | undefined): number | null => {
  const s = `${a ?? ""} ${b ?? ""}`;
  const m = s.match(/(\d+)\s*日/);
  if (!m) return null;
  const n = Number(m[1]);
  return Number.isFinite(n) ? n : null;
};

const parseMaxLessons = (a: string | null | undefined, b: string | null | undefined): number | null => {
  const s = `${a ?? ""} ${b ?? ""}`;
  const m = s.match(/(\d+)\s*回/);
  if (!m) return null;
  const n = Number(m[1]);
  return Number.isFinite(n) ? n : null;
};

const maxNumberByUnit = (text: string, unit: "日" | "回"): number | null => {
  const s = String(text ?? "");
  const re = unit === "日" ? /(\d+)\s*日/g : /(\d+)\s*回/g;
  let max: number | null = null;
  for (const m of s.matchAll(re)) {
    const n = Number(m?.[1]);
    if (!Number.isFinite(n)) continue;
    if (max == null || n > max) max = n;
  }
  return max;
};

const deriveTrialBasePromo = (opts: {
  active: boolean;
  baseField: number | null | undefined;
  promoField: number | null | undefined;
  trialText: string | null | undefined;
  trialDetailText: string | null | undefined;
  unit: "日" | "回";
}) => {
  const baseFromField = typeof opts.baseField === "number" && Number.isFinite(opts.baseField) ? opts.baseField : null;
  const promoFromField = typeof opts.promoField === "number" && Number.isFinite(opts.promoField) ? opts.promoField : null;

  const textA = String(opts.trialText ?? "");
  const textB = String(opts.trialDetailText ?? "");
  const baseFromText = maxNumberByUnit(textA, opts.unit);
  const maxFromBoth = maxNumberByUnit(`${textA} ${textB}`, opts.unit);

  const base = baseFromField ?? baseFromText ?? maxFromBoth;
  const promoCandidate = promoFromField ?? (opts.active ? maxFromBoth : null);
  const promo = opts.active && promoCandidate != null && (base == null || promoCandidate > base) ? promoCandidate : null;

  return { base, promo, display: promo ?? base };
};

const parseCampaignEndsAt = (v: string | null | undefined): Date | null => {
  if (!v) return null;
  const s = String(v).trim();
  if (!s) return null;
  // YYYY-MM-DD -> interpret as end of day in JST.
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
    const d = new Date(`${s}T23:59:59+09:00`);
    return Number.isNaN(d.getTime()) ? null : d;
  }
  const d = new Date(s);
  return Number.isNaN(d.getTime()) ? null : d;
};

const jstYmd = (d: Date): string => {
  // "2026-02-17"
  return new Intl.DateTimeFormat("en-CA", {
    timeZone: "Asia/Tokyo",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
  }).format(d);
};

const isCampaignActive = (endsAt: string | null | undefined) => {
  const d = parseCampaignEndsAt(endsAt);
  if (!d) return false;
  return Date.now() <= d.getTime();
};

const isCampaignLastDay = (endsAt: string | null | undefined) => {
  if (!isCampaignActive(endsAt)) return false;
  const s = String(endsAt ?? "").trim();
  const endsYmd = /^\d{4}-\d{2}-\d{2}$/.test(s) ? s : (() => {
    const d = parseCampaignEndsAt(s);
    return d ? jstYmd(d) : "";
  })();
  if (!endsYmd) return false;
  return endsYmd === jstYmd(new Date());
};

const isTrialBoosted = (benefitText: string | null | undefined, campaignText: string | null | undefined) => {
  const s = `${benefitText ?? ""} ${campaignText ?? ""}`;
  // Only flag when the copy explicitly indicates an increase/extension.
  return /増量|延長|追加|アップ|増や/.test(s);
};

const stripLeadingBullet = (v: unknown): string =>
  String(v ?? "")
    .replace(/^[\s\u3000]+/, "")
    .replace(/^(?:[・•\-–—*]\s*)+/, "")
    .trim();
---

{variant === "stack" ? (
  <div class="mt-4 grid gap-4">
    {ranking.items.map((x, idx) => {
      const rank = idx + 1;
      const borderColor = colBorder(rank);
      const lastDay = isCampaignLastDay(x.data.campaignEndsAt);
      return (
        <section
          class:list={[
            "rounded-2xl border-2 bg-white p-4 shadow-sm",
            lastDay ? "ring-2 ring-rose-400 ring-offset-2 ring-offset-white bg-rose-50/30" : "",
          ]}
          style={`border-color:${borderColor}`}
        >
          <div class="flex items-start justify-between gap-3">
            <div class="flex min-w-0 items-start gap-3">
              {rank <= 3 ? (
                <img
                  src={`/rank${rank}.webp`}
                  alt={`${rank}位`}
                  width="36"
                  height="36"
                  loading="eager"
                  decoding="async"
                  class="h-9 w-9 shrink-0 object-contain"
                />
              ) : (
                <div class="inline-flex h-9 w-9 shrink-0 items-center justify-center rounded-full bg-white text-sm font-extrabold text-zinc-800 ring-1 ring-zinc-300">
                  {rank}
                </div>
              )}

              <div class="min-w-0">
                <div class="flex min-w-0 items-center gap-2">
                  {x.data.logoUrl ? (
                    <img
                      src={x.data.logoUrl}
                      alt={`${x.data.name} ロゴ`}
                      width="112"
                      height="28"
                      class="h-7 w-auto max-w-full object-contain"
                      loading="lazy"
                      decoding="async"
                    />
                  ) : null}
                </div>
                <a
                  href={`#school-${x.id}`}
                  class="mt-2 block min-w-0 truncate text-base font-extrabold text-[color:var(--brand-link-hover)]"
                >
                  {x.data.name}
                </a>
                {lastDay ? (
                  <div class="mt-1">
                    <span class="inline-flex items-center rounded-full bg-rose-600 px-2 py-0.5 text-[10px] font-extrabold text-white">
                      キャンペーン最終日
                    </span>
                  </div>
                ) : null}
                <div class="mt-2">
                  <StarRating value={x.data.rating ?? null} size={16} />
                </div>
              </div>
            </div>
          </div>

          <div class="mt-4 grid gap-3">
            <div class="grid grid-cols-[96px_1fr] items-start gap-3 rounded-xl bg-zinc-50 p-3 ring-1 ring-zinc-200">
              <div class="text-xs font-extrabold text-zinc-700">講師の質</div>
              <div class="text-sm font-extrabold text-zinc-900">
                {typeof x.data.teacherQuality === "number" && Number.isFinite(x.data.teacherQuality) ? (
                  <div class="flex items-center gap-3">
                    <div class="h-2.5 flex-1 overflow-hidden rounded-full bg-zinc-200 ring-1 ring-zinc-300">
                      <div
                        class="h-full rounded-full bg-linear-to-r from-[#7ac6ff] to-[#ff7ab6]"
                        style={`width:${gaugeWidthPct(x.data.teacherQuality)}%`}
                      />
                    </div>
                    <span class="whitespace-nowrap text-xs font-extrabold text-zinc-700">{fmtScore(x.data.teacherQuality)} / 5</span>
                  </div>
                ) : (
                  <span class="text-zinc-500">—</span>
                )}
              </div>
            </div>
            <div class="grid grid-cols-[96px_1fr] items-start gap-3 rounded-xl bg-zinc-50 p-3 ring-1 ring-zinc-200">
              <div class="text-xs font-extrabold text-zinc-700">教材の質</div>
              <div class="text-sm font-extrabold text-zinc-900">
                {typeof x.data.materialQuality === "number" && Number.isFinite(x.data.materialQuality) ? (
                  <div class="flex items-center gap-3">
                    <div class="h-2.5 flex-1 overflow-hidden rounded-full bg-zinc-200 ring-1 ring-zinc-300">
                      <div
                        class="h-full rounded-full bg-linear-to-r from-[#ff7ab6] to-[#b6a7ff]"
                        style={`width:${gaugeWidthPct(x.data.materialQuality)}%`}
                      />
                    </div>
                    <span class="whitespace-nowrap text-xs font-extrabold text-zinc-700">{fmtScore(x.data.materialQuality)} / 5</span>
                  </div>
                ) : (
                  <span class="text-zinc-500">—</span>
                )}
              </div>
            </div>
            <div class="grid grid-cols-[96px_1fr] items-start gap-3 rounded-xl bg-zinc-50 p-3 ring-1 ring-zinc-200">
              <div class="text-xs font-extrabold text-zinc-700">通信の質</div>
              <div class="text-sm font-extrabold text-zinc-900">
                {typeof x.data.connectionQuality === "number" && Number.isFinite(x.data.connectionQuality) ? (
                  <div class="flex items-center gap-3">
                    <div class="h-2.5 flex-1 overflow-hidden rounded-full bg-zinc-200 ring-1 ring-zinc-300">
                      <div
                        class="h-full rounded-full bg-linear-to-r from-[#6ee7d8] to-[#7ac6ff]"
                        style={`width:${gaugeWidthPct(x.data.connectionQuality)}%`}
                      />
                    </div>
                    <span class="whitespace-nowrap text-xs font-extrabold text-zinc-700">{fmtScore(x.data.connectionQuality)} / 5</span>
                  </div>
                ) : (
                  <span class="text-zinc-500">—</span>
                )}
              </div>
            </div>
            <div class="grid grid-cols-[96px_1fr] items-start gap-3 rounded-xl bg-zinc-50 p-3 ring-1 ring-zinc-200">
              <div class="text-xs font-extrabold text-zinc-700">安さ</div>
              <div class="text-sm font-extrabold text-zinc-900">
                {typeof x.data.priceRating === "number" && Number.isFinite(x.data.priceRating) ? (
                  <div class="flex items-center gap-3">
                    <div class="h-2.5 flex-1 overflow-hidden rounded-full bg-zinc-200 ring-1 ring-zinc-300">
                      <div
                        class="h-full rounded-full bg-linear-to-r from-[#f5c542] to-[#ff7ab6]"
                        style={`width:${gaugeWidthPct(x.data.priceRating)}%`}
                      />
                    </div>
                    <span class="whitespace-nowrap text-xs font-extrabold text-zinc-700">{fmtScore(x.data.priceRating)} / 5</span>
                  </div>
                ) : (
                  <span class="text-zinc-500">—</span>
                )}
              </div>
            </div>
            <div class="grid grid-cols-[96px_1fr] items-start gap-3 rounded-xl bg-zinc-50 p-3 ring-1 ring-zinc-200">
              <div class="text-xs font-extrabold text-zinc-700">満足度</div>
              <div class="text-sm font-extrabold text-zinc-900">
                {typeof x.data.satisfactionRating === "number" && Number.isFinite(x.data.satisfactionRating) ? (
                  <div class="flex items-center gap-3">
                    <div class="h-2.5 flex-1 overflow-hidden rounded-full bg-zinc-200 ring-1 ring-zinc-300">
                      <div
                        class="h-full rounded-full bg-linear-to-r from-[#b6a7ff] to-[#6ee7d8]"
                        style={`width:${gaugeWidthPct(x.data.satisfactionRating)}%`}
                      />
                    </div>
                    <span class="whitespace-nowrap text-xs font-extrabold text-zinc-700">{fmtScore(x.data.satisfactionRating)} / 5</span>
                  </div>
                ) : (
                  <span class="text-zinc-500">—</span>
                )}
              </div>
            </div>
            <div class="grid grid-cols-[96px_1fr] items-start gap-3 rounded-xl bg-zinc-50 p-3 ring-1 ring-zinc-200">
              <div class="text-xs font-extrabold text-zinc-700">月額</div>
              <div class="text-sm font-extrabold text-zinc-900">
                {(() => {
                  const v = parseMinMonthlyYen(x.data.priceText);
                  return v == null ? "—" : fmtYen(v);
                })()}
              </div>
            </div>
            <div class="grid grid-cols-[96px_1fr] items-start gap-3 rounded-xl bg-zinc-50 p-3 ring-1 ring-zinc-200">
              <div class="text-xs font-extrabold text-zinc-700">受講時間</div>
              <div class="text-sm font-extrabold text-zinc-900">{x.data.hoursText ?? "—"}</div>
            </div>
            <div class="grid grid-cols-[96px_1fr] items-start gap-3 rounded-xl bg-zinc-50 p-3 ring-1 ring-zinc-200">
              <div class="text-xs font-extrabold text-zinc-700">無料体験</div>
              <div class="text-sm font-extrabold text-zinc-900">
                {(() => {
                  const active = isCampaignActive(x.data.campaignEndsAt);

                  const days = deriveTrialBasePromo({
                    active,
                    baseField: x.data.trialMaxDays,
                    promoField: x.data.trialPromoMaxDays,
                    trialText: x.data.trialText,
                    trialDetailText: x.data.trialDetailText,
                    unit: "日",
                  });
                  const lessons = deriveTrialBasePromo({
                    active,
                    baseField: x.data.trialMaxLessons,
                    promoField: x.data.trialPromoMaxLessons,
                    trialText: x.data.trialText,
                    trialDetailText: x.data.trialDetailText,
                    unit: "回",
                  });

                  const boostedByNumbers =
                    active &&
                    ((days.promo != null && days.base != null && days.promo > days.base) ||
                      (lessons.promo != null && lessons.base != null && lessons.promo > lessons.base));
                  const boosted = boostedByNumbers || (active && isTrialBoosted(x.data.benefitText, x.data.campaignText));
                  return (
                    <div class="space-y-1">
                      <div class="flex items-center gap-2">
                        <div class="text-sm font-extrabold text-zinc-900">{days.display == null ? "最大—日間" : `最大${days.display}日間`}</div>
                        {boosted ? (
                          <span class="inline-flex items-center rounded-full bg-rose-100 px-2 py-0.5 text-[10px] font-extrabold text-rose-700 ring-1 ring-rose-200">
                            増量中
                          </span>
                        ) : null}
                      </div>
                      {active && days.promo != null ? (
                        <div class="text-xs font-extrabold">
                          {days.base != null ? <span class="text-zinc-500">（通常{days.base}日無料） </span> : null}
                          <span class="text-rose-700">期間限定 {days.promo}日無料</span>
                        </div>
                      ) : null}
                      {active && lessons.promo != null ? (
                        <div class="text-xs font-extrabold">
                          {lessons.base != null ? <span class="text-zinc-500">（通常{lessons.base}回） </span> : null}
                          <span class="text-rose-700">期間限定 {lessons.promo}回</span>
                        </div>
                      ) : (
                        <div class="text-xs font-extrabold text-zinc-700">
                          期間中の最大レッスン数 {lessons.display == null ? "—" : `${lessons.display}回`}
                        </div>
                      )}
                    </div>
                  );
                })()}
              </div>
            </div>

            <div class="rounded-xl bg-zinc-50 p-3 ring-1 ring-zinc-200">
              <div class="text-xs font-extrabold text-zinc-700">おすすめポイント</div>
              {x.data.points?.length ? (
                <ul class="mt-2 space-y-1 text-sm font-semibold text-zinc-900">
                  {x.data.points.slice(0, 3).map((p) => (
                    <li class="flex gap-1.5">
                      <span class="shrink-0" aria-hidden="true">・</span>
                      <span class="min-w-0">{stripLeadingBullet(p)}</span>
                    </li>
                  ))}
                </ul>
              ) : (
                <div class="mt-2 text-sm font-semibold text-zinc-500">—</div>
              )}
            </div>

            <div class="rounded-xl bg-zinc-50 p-3 ring-1 ring-zinc-200">
              <div class="text-xs font-extrabold text-zinc-700">こんな人におすすめ</div>
              {x.data.recommendedFor?.length ? (
                <ul class="mt-2 space-y-1 text-sm font-semibold text-zinc-900">
                  {x.data.recommendedFor.slice(0, 4).map((p) => (
                    <li class="flex gap-1.5">
                      <span class="shrink-0" aria-hidden="true">・</span>
                      <span class="min-w-0">{stripLeadingBullet(p)}</span>
                    </li>
                  ))}
                </ul>
              ) : (
                <div class="mt-2 text-sm font-semibold text-zinc-500">—</div>
              )}
            </div>
          </div>

          <div class="mt-4 border-t border-zinc-200 pt-4">
            <CTAButton href={x.data.officialUrl} offerId={x.id} label="公式サイトを見る" fullWidth />
          </div>
        </section>
      );
    })}
  </div>
) : (
  <div class="scroll-x-contain mt-4 w-full max-w-full overflow-x-auto [-webkit-overflow-scrolling:touch]">
    <table
      class="w-full table-fixed border-separate border-spacing-0"
      style={tableMinWidth !== "0px" ? `min-width:${tableMinWidth}` : undefined}
    >
      <colgroup>
        <col style={`width:${firstColWidth}px`} />
        {ranking.items.map(() => (
          <col style={`width:${serviceColWidth}px`} />
        ))}
      </colgroup>
      <thead>
        <tr>
          <th class="sticky left-0 z-10 bg-white" style={`width:${firstColWidth}px`}></th>
          {ranking.items.map((x, idx) => {
            const rank = idx + 1;
            const borderColor = colBorder(rank);
            const lastDay = isCampaignLastDay(x.data.campaignEndsAt);
            return (
              <th
                class="px-3 pb-4 pt-3 text-center align-top"
                style={[
                  `border-top:2px solid ${borderColor}`,
                  `border-left:2px solid ${borderColor}`,
                  `border-right:2px solid ${borderColor}`,
                  `border-top-left-radius:12px`,
                  `border-top-right-radius:12px`,
                  lastDay ? "background:#fff1f2" : "",
                  lastDay ? "box-shadow: inset 0 0 0 2px #fb7185" : "",
                ].filter(Boolean).join(";")}
              >
                <div class="flex items-center justify-center">
                  {rank <= 3 ? (
                    <img src={`/rank${rank}.webp`} alt={`${rank}位`} width="40" height="40" loading="eager" decoding="async" class="h-10 w-10 object-contain" />
                  ) : (
                    <div class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-white text-sm font-extrabold text-zinc-800 ring-1 ring-zinc-300">
                      {rank}
                    </div>
                  )}
                </div>
                {x.data.logoUrl ? (
                  <div class="mt-2 flex items-center justify-center">
                    <img
                      src={x.data.logoUrl}
                      alt={`${x.data.name} ロゴ`}
                      width="160"
                      height="40"
                      class="h-10 w-auto max-w-full object-contain"
                      loading="lazy"
                      decoding="async"
                    />
                  </div>
                ) : null}
                        <a
                          href={`#school-${x.id}`}
                          class="mt-2 block truncate text-sm font-extrabold text-[color:var(--brand-link)] underline decoration-[#aebcff] underline-offset-2 hover:text-[color:var(--brand-link-hover)]"
                        >
                  {x.data.name}
                </a>
                <div class="mt-2 flex items-center justify-center">
                  <StarRating value={x.data.rating ?? null} size={18} />
                </div>
                {lastDay ? (
                  <div class="mt-2 flex items-center justify-center">
                    <span class="inline-flex items-center rounded-full bg-rose-600 px-2 py-0.5 text-[10px] font-extrabold text-white">
                      キャンペーン最終日
                    </span>
                  </div>
                ) : null}
              </th>
            );
          })}
        </tr>
      </thead>
      <tbody class="align-top">
        <tr>
          <th class={`sticky left-0 z-10 px-3 py-3 text-left text-sm font-extrabold ${labelBar}`}>講師の質</th>
          {ranking.items.map((x, idx) => {
            const borderColor = colBorder(idx + 1);
            return (
              <td class="px-3 py-3" style={`border-left:2px solid ${borderColor}; border-right:2px solid ${borderColor};`}>
                <div class="flex items-center justify-center gap-2">
                  {typeof x.data.teacherQuality === "number" && Number.isFinite(x.data.teacherQuality) ? (
                    <>
                      <div class="h-2.5 w-[140px] overflow-hidden rounded-full bg-zinc-200 ring-1 ring-zinc-300">
                        <div
                          class="h-full rounded-full bg-linear-to-r from-[#7ac6ff] to-[#ff7ab6]"
                          style={`width:${gaugeWidthPct(x.data.teacherQuality)}%`}
                        />
                      </div>
                      <span class="whitespace-nowrap text-xs font-extrabold text-zinc-700">{fmtScore(x.data.teacherQuality)} / 5</span>
                    </>
                  ) : (
                    <span class="text-sm font-semibold text-zinc-500">—</span>
                  )}
                </div>
              </td>
            );
          })}
        </tr>
        <tr>
          <th class={`sticky left-0 z-10 border-t border-zinc-200 px-3 py-3 text-left text-sm font-extrabold ${labelBar}`}>教材の質</th>
          {ranking.items.map((x, idx) => {
            const borderColor = colBorder(idx + 1);
            return (
              <td class="border-t border-zinc-200 px-3 py-3" style={`border-left:2px solid ${borderColor}; border-right:2px solid ${borderColor};`}>
                <div class="flex items-center justify-center gap-2">
                  {typeof x.data.materialQuality === "number" && Number.isFinite(x.data.materialQuality) ? (
                    <>
                      <div class="h-2.5 w-[140px] overflow-hidden rounded-full bg-zinc-200 ring-1 ring-zinc-300">
                        <div
                          class="h-full rounded-full bg-linear-to-r from-[#ff7ab6] to-[#b6a7ff]"
                          style={`width:${gaugeWidthPct(x.data.materialQuality)}%`}
                        />
                      </div>
                      <span class="whitespace-nowrap text-xs font-extrabold text-zinc-700">{fmtScore(x.data.materialQuality)} / 5</span>
                    </>
                  ) : (
                    <span class="text-sm font-semibold text-zinc-500">—</span>
                  )}
                </div>
              </td>
            );
          })}
        </tr>
        <tr>
          <th class={`sticky left-0 z-10 border-t border-zinc-200 px-3 py-3 text-left text-sm font-extrabold ${labelBar}`}>通信の質</th>
          {ranking.items.map((x, idx) => {
            const borderColor = colBorder(idx + 1);
            return (
              <td class="border-t border-zinc-200 px-3 py-3" style={`border-left:2px solid ${borderColor}; border-right:2px solid ${borderColor};`}>
                <div class="flex items-center justify-center gap-2">
                  {typeof x.data.connectionQuality === "number" && Number.isFinite(x.data.connectionQuality) ? (
                    <>
                      <div class="h-2.5 w-[140px] overflow-hidden rounded-full bg-zinc-200 ring-1 ring-zinc-300">
                        <div
                          class="h-full rounded-full bg-linear-to-r from-[#6ee7d8] to-[#7ac6ff]"
                          style={`width:${gaugeWidthPct(x.data.connectionQuality)}%`}
                        />
                      </div>
                      <span class="whitespace-nowrap text-xs font-extrabold text-zinc-700">{fmtScore(x.data.connectionQuality)} / 5</span>
                    </>
                  ) : (
                    <span class="text-sm font-semibold text-zinc-500">—</span>
                  )}
                </div>
              </td>
            );
          })}
        </tr>
        <tr>
          <th class={`sticky left-0 z-10 border-t border-zinc-200 px-3 py-3 text-left text-sm font-extrabold ${labelBar}`}>安さ</th>
          {ranking.items.map((x, idx) => {
            const borderColor = colBorder(idx + 1);
            return (
              <td class="border-t border-zinc-200 px-3 py-3" style={`border-left:2px solid ${borderColor}; border-right:2px solid ${borderColor};`}>
                <div class="flex items-center justify-center gap-2">
                  {typeof x.data.priceRating === "number" && Number.isFinite(x.data.priceRating) ? (
                    <>
                      <div class="h-2.5 w-[140px] overflow-hidden rounded-full bg-zinc-200 ring-1 ring-zinc-300">
                        <div
                          class="h-full rounded-full bg-linear-to-r from-[#f5c542] to-[#ff7ab6]"
                          style={`width:${gaugeWidthPct(x.data.priceRating)}%`}
                        />
                      </div>
                      <span class="whitespace-nowrap text-xs font-extrabold text-zinc-700">{fmtScore(x.data.priceRating)} / 5</span>
                    </>
                  ) : (
                    <span class="text-sm font-semibold text-zinc-500">—</span>
                  )}
                </div>
              </td>
            );
          })}
        </tr>
        <tr>
          <th class={`sticky left-0 z-10 border-t border-zinc-200 px-3 py-3 text-left text-sm font-extrabold ${labelBar}`}>満足度</th>
          {ranking.items.map((x, idx) => {
            const borderColor = colBorder(idx + 1);
            return (
              <td class="border-t border-zinc-200 px-3 py-3" style={`border-left:2px solid ${borderColor}; border-right:2px solid ${borderColor};`}>
                <div class="flex items-center justify-center gap-2">
                  {typeof x.data.satisfactionRating === "number" && Number.isFinite(x.data.satisfactionRating) ? (
                    <>
                      <div class="h-2.5 w-[140px] overflow-hidden rounded-full bg-zinc-200 ring-1 ring-zinc-300">
                        <div
                          class="h-full rounded-full bg-linear-to-r from-[#b6a7ff] to-[#6ee7d8]"
                          style={`width:${gaugeWidthPct(x.data.satisfactionRating)}%`}
                        />
                      </div>
                      <span class="whitespace-nowrap text-xs font-extrabold text-zinc-700">{fmtScore(x.data.satisfactionRating)} / 5</span>
                    </>
                  ) : (
                    <span class="text-sm font-semibold text-zinc-500">—</span>
                  )}
                </div>
              </td>
            );
          })}
        </tr>
        <tr>
          <th class={`sticky left-0 z-10 px-3 py-3 text-left text-sm font-extrabold ${labelBar}`}>月額</th>
          {ranking.items.map((x, idx) => {
            const borderColor = colBorder(idx + 1);
            const v = parseMinMonthlyYen(x.data.priceText);
            return (
              <td class="px-3 py-3 text-center text-base font-extrabold text-zinc-900 sm:text-lg" style={`border-left:2px solid ${borderColor}; border-right:2px solid ${borderColor};`}>
                {v == null ? "—" : fmtYen(v)}
              </td>
            );
          })}
        </tr>
        <tr>
          <th class={`sticky left-0 z-10 border-t border-zinc-200 px-3 py-3 text-left text-sm font-extrabold ${labelBar}`}>受講できる時間</th>
          {ranking.items.map((x, idx) => {
            const borderColor = colBorder(idx + 1);
            return (
              <td class="border-t border-zinc-200 px-3 py-3 text-center text-base font-extrabold text-zinc-900 sm:text-lg" style={`border-left:2px solid ${borderColor}; border-right:2px solid ${borderColor};`}>
                {x.data.hoursText ?? "—"}
              </td>
            );
          })}
        </tr>
        <tr>
          <th class={`sticky left-0 z-10 border-t border-zinc-200 px-3 py-3 text-left text-sm font-extrabold ${labelBar}`}>無料体験</th>
          {ranking.items.map((x, idx) => {
            const borderColor = colBorder(idx + 1);
            const lastDay = isCampaignLastDay(x.data.campaignEndsAt);
            const active = isCampaignActive(x.data.campaignEndsAt);

            const days = deriveTrialBasePromo({
              active,
              baseField: x.data.trialMaxDays,
              promoField: x.data.trialPromoMaxDays,
              trialText: x.data.trialText,
              trialDetailText: x.data.trialDetailText,
              unit: "日",
            });
            const lessons = deriveTrialBasePromo({
              active,
              baseField: x.data.trialMaxLessons,
              promoField: x.data.trialPromoMaxLessons,
              trialText: x.data.trialText,
              trialDetailText: x.data.trialDetailText,
              unit: "回",
            });

            const boostedByNumbers =
              active &&
              ((days.promo != null && days.base != null && days.promo > days.base) ||
                (lessons.promo != null && lessons.base != null && lessons.promo > lessons.base));
            const boosted = boostedByNumbers || (active && isTrialBoosted(x.data.benefitText, x.data.campaignText));
            return (
              <td
                class="border-t border-zinc-200 px-3 py-3 text-center text-base font-extrabold text-zinc-900 sm:text-lg"
                style={[
                  `border-left:2px solid ${borderColor}`,
                  `border-right:2px solid ${borderColor}`,
                  lastDay ? "background:#fff1f2" : "",
                  lastDay ? "box-shadow: inset 0 0 0 2px #fb7185" : "",
                ].filter(Boolean).join(";")}
              >
                <div class="grid place-items-center gap-1">
                  <div class="flex items-center justify-center gap-2">
                    <div class="text-base font-extrabold text-zinc-900">{days.display == null ? "最大—日間" : `最大${days.display}日間`}</div>
                    {boosted ? (
                      <span class="inline-flex items-center rounded-full bg-rose-100 px-2 py-0.5 text-[10px] font-extrabold text-rose-700 ring-1 ring-rose-200">
                        増量中
                      </span>
                    ) : null}
                  </div>
                  {active && days.promo != null ? (
                    <div class="text-[11px] font-extrabold">
                      {days.base != null ? <span class="text-zinc-500">（通常{days.base}日無料） </span> : null}
                      <span class="text-rose-700">期間限定 {days.promo}日無料</span>
                    </div>
                  ) : null}
                  {active && lessons.promo != null ? (
                    <div class="text-[11px] font-extrabold">
                      {lessons.base != null ? <span class="text-zinc-500">（通常{lessons.base}回） </span> : null}
                      <span class="text-rose-700">期間限定 {lessons.promo}回</span>
                    </div>
                  ) : (
                    <div class="text-xs font-extrabold text-zinc-700">
                      期間中の最大レッスン数 {lessons.display == null ? "—" : `${lessons.display}回`}
                    </div>
                  )}
                </div>
              </td>
            );
          })}
        </tr>
        <tr>
          <th class={`sticky left-0 z-10 border-t border-zinc-200 px-3 py-3 text-left text-sm font-extrabold ${labelBar}`}>おすすめポイント</th>
          {ranking.items.map((x, idx) => {
            const borderColor = colBorder(idx + 1);
            return (
              <td class="border-t border-zinc-200 px-3 py-3 text-left text-sm font-semibold text-zinc-900" style={`border-left:2px solid ${borderColor}; border-right:2px solid ${borderColor};`}>
                {x.data.points?.length ? (
                  <ul class="space-y-1">
                    {x.data.points.slice(0, 3).map((p) => (
                      <li class="flex gap-1.5">
                        <span class="shrink-0" aria-hidden="true">・</span>
                        <span class="min-w-0">{stripLeadingBullet(p)}</span>
                      </li>
                    ))}
                  </ul>
                ) : (
                  <div class="text-center text-sm font-semibold text-zinc-500">—</div>
                )}
              </td>
            );
          })}
        </tr>
        <tr>
          <th class={`sticky left-0 z-10 border-t border-zinc-200 px-3 py-3 text-left text-sm font-extrabold ${labelBar}`}>こんな人におすすめ</th>
          {ranking.items.map((x, idx) => {
            const borderColor = colBorder(idx + 1);
            return (
              <td class="border-t border-zinc-200 px-3 py-3 text-left text-sm font-semibold text-zinc-900" style={`border-left:2px solid ${borderColor}; border-right:2px solid ${borderColor};`}>
                {x.data.recommendedFor?.length ? (
                  <ul class="space-y-1">
                    {x.data.recommendedFor.slice(0, 4).map((p) => (
                      <li class="flex gap-1.5">
                        <span class="shrink-0" aria-hidden="true">・</span>
                        <span class="min-w-0">{stripLeadingBullet(p)}</span>
                      </li>
                    ))}
                  </ul>
                ) : (
                  <div class="text-center text-sm font-semibold text-zinc-500">—</div>
                )}
              </td>
            );
          })}
        </tr>
        <tr>
          <th class="sticky left-0 z-10 border-t border-zinc-200 bg-white"></th>
          {ranking.items.map((x, idx) => {
            const borderColor = colBorder(idx + 1);
            const isLastRow = true;
            return (
              <td
                class="border-t border-zinc-200 p-3"
                style={[
                  `border-left:2px solid ${borderColor}`,
                  `border-right:2px solid ${borderColor}`,
                  isLastRow ? `border-bottom:2px solid ${borderColor}; border-bottom-left-radius:12px; border-bottom-right-radius:12px;` : "",
                ].filter(Boolean).join(";")}
              >
                <CTAButton href={x.data.officialUrl} offerId={x.id} label="公式サイトを見る" fullWidth />
              </td>
            );
          })}
        </tr>
      </tbody>
    </table>
  </div>
)}

