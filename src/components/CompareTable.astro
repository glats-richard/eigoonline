---
import CTAButton from "./CTAButton.astro";
import StarRating from "./StarRating.astro";

type School = {
  name: string;
  logoUrl?: string | null;
  officialUrl: string;
  rating?: number | null;
  priceText?: string | null;
  hoursText?: string | null;
  trialText?: string | null;
  points?: string[];
  recommendedFor?: string[];
};

type Ranking = {
  title: string;
  items: { id: string; data: School }[];
};

type Props = { ranking: Ranking };

const { ranking } = Astro.props satisfies Props;

const cols = Math.max(1, ranking.items.length);
const colWidth = `${100 / cols}%`;
const tableMinWidth = cols >= 4 ? "780px" : cols === 3 ? "640px" : "0px";
---

<div class="mt-4 overflow-x-auto [-webkit-overflow-scrolling:touch]">
  <table
    class="w-full border-separate border-spacing-0 overflow-hidden rounded-xl ring-1 ring-zinc-200"
    style={tableMinWidth !== "0px" ? `min-width:${tableMinWidth}` : undefined}
  >
    <thead>
      <tr>
        {ranking.items.map((x, idx) => (
          <th class="bg-sky-50 p-3 align-top text-left" style={`width:${colWidth}`}>
            <div class="flex items-start gap-3">
              {idx + 1 <= 3 ? (
                <img
                  src={`/rank${idx + 1}.png`}
                  alt={`${idx + 1}位`}
                  width="28"
                  height="28"
                  loading="eager"
                  decoding="async"
                  class="mt-0.5 h-7 w-7 shrink-0 object-contain"
                />
              ) : (
                <div class="mt-0.5 inline-flex h-7 w-7 items-center justify-center rounded-full bg-amber-50 text-xs font-extrabold text-amber-700 ring-1 ring-amber-200">
                  {idx + 1}
                </div>
              )}
              <div class="min-w-0">
                <div class="flex items-center gap-2">
                  <span class="truncate text-sm font-extrabold text-zinc-900">{x.data.name}</span>
                </div>
                {x.data.logoUrl ? (
                  <img
                    src={x.data.logoUrl}
                    alt={`${x.data.name} ロゴ`}
                    class="mt-2 h-8 w-auto max-w-[160px] object-contain"
                    loading="lazy"
                    decoding="async"
                  />
                ) : null}
              </div>
            </div>
          </th>
        ))}
      </tr>
    </thead>
    <tbody class="[&_tr:not(:last-child)_td]:border-b [&_td:not(:last-child)]:border-r [&_td]:border-zinc-200">
      <tr>
        {ranking.items.map((x) => (
          <td class="p-3 align-top">
            <div class="text-xs font-bold text-zinc-500">総合評価</div>
            <div class="mt-1"><StarRating value={x.data.rating ?? null} /></div>
          </td>
        ))}
      </tr>
      <tr>
        {ranking.items.map((x) => (
          <td class="p-3 align-top">
            <div class="text-xs font-bold text-zinc-500">月額</div>
            <div class="mt-1 text-sm font-semibold text-zinc-900">{x.data.priceText ?? "—"}</div>
          </td>
        ))}
      </tr>
      <tr>
        {ranking.items.map((x) => (
          <td class="p-3 align-top">
            <div class="text-xs font-bold text-zinc-500">受講できる時間</div>
            <div class="mt-1 text-sm font-semibold text-zinc-900">{x.data.hoursText ?? "—"}</div>
          </td>
        ))}
      </tr>
      <tr>
        {ranking.items.map((x) => (
          <td class="p-3 align-top">
            <div class="text-xs font-bold text-zinc-500">無料体験</div>
            <div class="mt-1 text-sm font-semibold text-zinc-900">{x.data.trialText ?? "—"}</div>
          </td>
        ))}
      </tr>
      <tr>
        {ranking.items.map((x) => (
          <td class="p-3 align-top">
            <div class="text-xs font-bold text-zinc-500">おすすめポイント</div>
            {x.data.points?.length ? (
              <ul class="mt-2 list-disc pl-5 text-sm text-zinc-800">
                {x.data.points.slice(0, 3).map((p) => (
                  <li>{p}</li>
                ))}
              </ul>
            ) : (
              <div class="mt-1 text-sm text-zinc-500">—</div>
            )}
          </td>
        ))}
      </tr>
      <tr>
        {ranking.items.map((x) => (
          <td class="p-3 align-top">
            <div class="text-xs font-bold text-zinc-500">こんな人におすすめ</div>
            {x.data.recommendedFor?.length ? (
              <ul class="mt-2 list-disc pl-5 text-sm text-zinc-800">
                {x.data.recommendedFor.slice(0, 3).map((p) => (
                  <li>{p}</li>
                ))}
              </ul>
            ) : (
              <div class="mt-1 text-sm text-zinc-500">—</div>
            )}
          </td>
        ))}
      </tr>
      <tr>
        {ranking.items.map((x) => (
          <td class="p-3 align-top">
            <CTAButton href={x.data.officialUrl} label="詳しく見る" />
          </td>
        ))}
      </tr>
    </tbody>
  </table>
</div>

